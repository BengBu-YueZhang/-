<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="React," />










<meta name="keywords" content="React">
<meta property="og:type" content="article">
<meta property="og:title" content="ã€ŒPreactã€Preactæºç åˆ†æ">
<meta property="og:url" content="https://bengbu-yuezhang.github.io/yue.github.io/2019/04/06/preactæºç åˆ†æ/index.html">
<meta property="og:site_name" content="æ–°ä¸–ç´€ã‚¨ãƒ´ã‚¡ãƒ³ã‚²ãƒªã‚ªãƒ³">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://unsplash.it/979/612?random">
<meta property="og:image" content="https://calendar.perfplanet.com/wp-content/uploads/2013/12/vjeux/1.png">
<meta property="og:image" content="https://i.loli.net/2019/04/08/5caaee5c9cd4c.png">
<meta property="og:image" content="https://i.loli.net/2019/04/06/5ca88be74abba.jpg">
<meta property="og:updated_time" content="2019-09-22T05:51:34.471Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ã€ŒPreactã€Preactæºç åˆ†æ">
<meta name="twitter:image" content="https://unsplash.it/979/612?random">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://bengbu-yuezhang.github.io/yue.github.io/2019/04/06/preactæºç åˆ†æ/"/>





  <title>ã€ŒPreactã€Preactæºç åˆ†æ | æ–°ä¸–ç´€ã‚¨ãƒ´ã‚¡ãƒ³ã‚²ãƒªã‚ªãƒ³</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">æ–°ä¸–ç´€ã‚¨ãƒ´ã‚¡ãƒ³ã‚²ãƒªã‚ªãƒ³</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">å‰ç«¯å°å­¦ç”Ÿ</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            ä¸»é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            æ ‡ç­¾
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            æ—¶é—´è½´
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://bengbu-yuezhang.github.io/yue.github.io/2019/04/06/preactæºç åˆ†æ/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="å¼ è¶Š">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ–°ä¸–ç´€ã‚¨ãƒ´ã‚¡ãƒ³ã‚²ãƒªã‚ªãƒ³">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">ã€ŒPreactã€Preactæºç åˆ†æ</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘å¸ƒäº</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-06T23:00:00+08:00">
                2019-04-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><img src="https://unsplash.it/979/612?random" alt="image"></p>
<a id="more"></a>
<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å‰ä¸¤ä¸ªæ˜ŸæœŸèŠ±äº†ä¸€äº›æ—¶é—´å­¦ä¹ preactçš„æºç , å¹¶å†™äº†å‡ ç¯‡åšå®¢ã€‚ä½†æ˜¯ç°åœ¨å›å¤´çœ‹çœ‹å†™çš„å¹¶ä¸å¥½ï¼Œè€Œä¸”æºç çš„æœ‰äº›åœ°æ–¹(diffChildrençš„éƒ¨åˆ†)æˆ‘è¿˜ç†è§£ğŸ™…é”™äº†ã€‚å®åœ¨æ˜¯ä¸å¥½æ„æ€ã€‚æ‰€ä»¥è¿™æ¬¡å‡†å¤‡é‡æ–°å†™ä¸€ç¯‡åšå®¢é‡æ–°åšä¸‹åˆ†æã€‚</p>
<p>preactè™½ç„¶æ˜¯reactçš„æœ€å°å®ç°, å¾ˆå¤šreactçš„ç‰¹æ€§preacté‡Œä¸€ç‚¹éƒ½æ²¡æœ‰å°‘, æ¯”å¦‚contextAPI, Fragmentç­‰ã€‚æˆ‘ä»¬åˆ†ææ—¶æ›´æ³¨é‡å®ç°è¿‡ç¨‹ï¼Œä¼šå¯¹ä¸€äº›APIçš„å®ç°è¿›è¡Œå¿½ç•¥ã€‚è¯·è§è°…</p>
<h2 id="preactæ˜¯ä»€ä¹ˆ"><a href="#preactæ˜¯ä»€ä¹ˆ" class="headerlink" title="preactæ˜¯ä»€ä¹ˆ?"></a>preactæ˜¯ä»€ä¹ˆ?</h2><p>âš›ï¸ Fast 3kB React alternative with the same modern API. Components &amp; Virtual DOM</p>
<p>preactå¯ä»¥è¯´æ˜¯ç±»reactæ¡†æ¶çš„æœ€å°å®ç°</p>
<h2 id="è™šæ‹ŸDOM"><a href="#è™šæ‹ŸDOM" class="headerlink" title="è™šæ‹ŸDOM"></a>è™šæ‹ŸDOM</h2><h3 id="å…³äºjsx"><a href="#å…³äºjsx" class="headerlink" title="å…³äºjsx"></a>å…³äºjsx</h3><p>æˆ‘ä»¬é¦–å…ˆçœ‹ä¸‹<a href="https://preactjs.com/" target="_blank" rel="noopener">preactå®˜ç½‘</a>ä¸Šçš„demoã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; h, render &#125; <span class="keyword">from</span> <span class="string">'preact'</span>;</span><br><span class="line"></span><br><span class="line">render((</span><br><span class="line">  &lt;h1 id=<span class="string">"title"</span> &gt;Hello, world!<span class="xml"><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line">), <span class="built_in">document</span>.body);</span><br></pre></td></tr></table></figure>
<p>å…¶å®ä¸Šé¢ğŸ‘†çš„jsxä»£ç ï¼Œæœ¬è´¨æ˜¯ä¸‹é¢ğŸ‘‡ä»£ç çš„è¯­æ³•ç³–</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">h(</span><br><span class="line">  <span class="string">'h1'</span>,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="string">'title'</span> &#125;,</span><br><span class="line">  <span class="string">'Hello, world!'</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>preactæ˜¯å¦‚ä½•åšåˆ°çš„å‘¢ï¼Ÿpreactæœ¬èº«å¹¶æ²¡æœ‰å®ç°è¿™ä¸ªè¯­æ³•è½¬æ¢çš„åŠŸèƒ½ï¼Œpreactæ˜¯ä¾èµ–transform-react-jsxçš„babelæ’ä»¶åšåˆ°çš„ã€‚</p>
<h3 id="createElement"><a href="#createElement" class="headerlink" title="createElement"></a>createElement</h3><p>å‰é¢æˆ‘ä»¬çœ‹åˆ°äº†jsxçš„ä»£ç ä¼šè¢«è½¬æ¢ä¸ºç”¨hå‡½æ•°åŒ…è£¹çš„ä»£ç , æˆ‘ä»¬æ¥ä¸‹æ¥çœ‹ä¸‹hå‡½æ•°æ˜¯å¦‚ä½•å®ç°çš„ã€‚createElementå‡½æ•°ä½äºcreate-element.jsè¿™ä¸ªæ–‡ä»¶ä¸­ã€‚</p>
<p>æ–‡ä»¶ä¸­ä¸»è¦ä¸º3ä¸ªå‡½æ•°, createElementå’ŒcreateVNode, ä»¥åŠcoerceToVNodeã€‚</p>
<p>createElementå’ŒcreateVNodeæ˜¯ä¸€å¯¹çš„, createElementä¼šå°†childrenæŒ‚è½½åˆ°VNodeçš„propsä¸­ã€‚æ—¢props.childrençš„æ•°ç»„ä¸­ã€‚createVNodeåˆ™ä¼šå°†æ ¹æ®è¿™äº›å‚æ•°è¿”å›ä¸€ä¸ªå¯¹è±¡, è¿™ä¸ªå¯¹è±¡å°±æ˜¯è™šæ‹ŸDOMã€‚</p>
<p>åœ¨createElementä¸­æˆ‘ä»¬è¿˜å¯ä»¥çœ‹åˆ°å¯¹defaultPropsçš„å¤„ç†, è€ŒdefaultPropså¯ä»¥ä¸ºæˆ‘ä»¬è®¾ç½®propsçš„é»˜è®¤çš„åˆå§‹å€¼ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createElement</span>(<span class="params">type, props, children</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (props==<span class="literal">null</span>) props = &#123;&#125;;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">arguments</span>.length&gt;<span class="number">3</span>) &#123;</span><br><span class="line">		children = [children];</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">let</span> i=<span class="number">3</span>; i&lt;<span class="built_in">arguments</span>.length; i++) &#123;</span><br><span class="line">			children.push(<span class="built_in">arguments</span>[i]);</span><br><span class="line">		&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">	<span class="keyword">if</span> (children!=<span class="literal">null</span>) &#123;</span><br><span class="line">		props.children = children;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (type!=<span class="literal">null</span> &amp;&amp; type.defaultProps!=<span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">in</span> type.defaultProps) &#123;</span><br><span class="line">			<span class="keyword">if</span> (props[i]===<span class="literal">undefined</span>) props[i] = type.defaultProps[i];</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">let</span> ref = props.ref;</span><br><span class="line">	<span class="keyword">if</span> (ref) <span class="keyword">delete</span> props.ref;</span><br><span class="line">	<span class="keyword">let</span> key = props.key;</span><br><span class="line">	<span class="keyword">if</span> (key) <span class="keyword">delete</span> props.key;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> createVNode(type, props, <span class="literal">null</span>, key, ref);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createVNode</span>(<span class="params">type, props, text, key, ref</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> vnode = &#123;</span><br><span class="line">		type,</span><br><span class="line">		props,</span><br><span class="line">		text,</span><br><span class="line">		key,</span><br><span class="line">		ref,</span><br><span class="line">		_children: <span class="literal">null</span>,</span><br><span class="line">		_dom: <span class="literal">null</span>,</span><br><span class="line">		_lastDomChild: <span class="literal">null</span>,</span><br><span class="line">		_component: <span class="literal">null</span></span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> vnode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è€ŒcoerceToVNodeå‡½æ•°çš„ä½œç”¨åˆ™æ˜¯å°†ä¸€äº›æ²¡æœ‰typeç±»å‹çš„èŠ‚ç‚¹ã€‚æ¯”å¦‚ä¸€æ®µå­—ç¬¦ä¸², ä¸€ä¸ªæ•°å­—å¼ºåˆ¶è½¬æ¢ä¸ºVNodeèŠ‚ç‚¹, è¿™äº›èŠ‚ç‚¹çš„typeå€¼ä¸ºnull, textå±æ€§ä¸­ä¿ç•™äº†å­—ç¬¦ä¸²å’Œæ•°å­—çš„å€¼ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">coerceToVNode</span>(<span class="params">possibleVNode</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (possibleVNode == <span class="literal">null</span> || <span class="keyword">typeof</span> possibleVNode === <span class="string">'boolean'</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">typeof</span> possibleVNode === <span class="string">'string'</span> || <span class="keyword">typeof</span> possibleVNode === <span class="string">'number'</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> createVNode(<span class="literal">null</span>, <span class="literal">null</span>, possibleVNode, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(possibleVNode)) &#123;</span><br><span class="line">		<span class="keyword">return</span> createElement(Fragment, <span class="literal">null</span>, possibleVNode);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (possibleVNode._dom!=<span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> createVNode(possibleVNode.type, possibleVNode.props, possibleVNode.text, possibleVNode.key, <span class="literal">null</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> possibleVNode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ°è¿™é‡Œcreate-elementçš„è¿™ä¸ªæ¨¡å—æˆ‘ä»¬å°±ä»‹ç»å®Œäº†ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„æ¨¡å—, åšçš„åŠŸèƒ½å°±æ˜¯æ ¹æ®å¯¹åº”çš„jsx-&gt;è™šæ‹ŸDOMã€‚æˆ‘ä»¬è¿™é‡Œè¿˜æ²¡æœ‰æ¶‰åŠå¦‚ä½•æ¸²æŸ“å‡ºçœŸæ­£çš„DOMèŠ‚ç‚¹, è¿™æ˜¯å› ä¸ºpreactä¸­æ¸²æŸ“çš„è¿‡ç¨‹æ˜¯ç›´æ¥åœ¨diffç®—æ³•ä¸­å®ç°ï¼Œä¸€è¾¹æ¯”å¯¹ä¸€è¾¹è·Ÿæ›´æ–°çœŸå®çš„domã€‚</p>
<h2 id="ç»„ä»¶"><a href="#ç»„ä»¶" class="headerlink" title="ç»„ä»¶"></a>ç»„ä»¶</h2><p>preactä¸­æœ‰ä¸€ä¸ªé€šç”¨Componentç±», ç»„ä»¶çš„å®ç°éœ€è¦ç»§æ‰¿è¿™ä¸ªé€šç”¨çš„Componentç±»ã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹preactä¸­Componentç±»æ˜¯å¦‚ä½•å®ç°çš„ã€‚å®ƒä½äºcomponent.jsæ–‡ä»¶ğŸ“ƒä¸­ã€‚</p>
<p>æˆ‘ä»¬é¦–å…ˆçœ‹ä¸‹Componentç±»çš„æ„é€ å‡½æ•°ï¼Œéå¸¸çš„ç®€å•ã€‚åªæœ‰ä¸¤ä¸ªå±æ€§props, contextã€‚å› ä¸ºé€šç”¨çš„Componentç±»å®ç°äº†propså±æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ç»„ä»¶ç±»åœ¨ç»§æ‰¿Componentç±»åï¼Œéœ€è¦æ˜¾å¼çš„ä½¿ç”¨superä½œä¸ºå‡½æ•°è°ƒç”¨ï¼Œå¹¶å°†propsä¼ å…¥ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">Component</span>(<span class="params">props, context</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">this</span>.props = props</span><br><span class="line">	<span class="keyword">this</span>.context = context</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Componentç±»ä¸­å®ç°äº†setStateæ–¹æ³•, forceUpdateæ–¹æ³•ï¼Œrenderæ–¹æ³•ï¼Œä»¥åŠå…¶ä»–çš„ä¸€äº›è¾…åŠ©å‡½æ•°ã€‚forceUpdateæ¶‰åŠåˆ°äº†setStateçš„å¼‚æ­¥æ›´æ–°, æˆ‘ä»¬å°†åœ¨<strong>setState</strong>ä¸€èŠ‚ä¸­ä¸“é—¨ä»‹ç»ã€‚è¿™é‡Œæš‚ä¸åšä»‹ç»ã€‚æˆ‘ä»¬æ¥ä¸‹æ¥çœ‹çœ‹setStateçš„å®ç°ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Component.prototype.setState = <span class="function"><span class="keyword">function</span>(<span class="params">update, callback</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">let</span> s = (<span class="keyword">this</span>._nextState!==<span class="keyword">this</span>.state &amp;&amp; <span class="keyword">this</span>._nextState) || (<span class="keyword">this</span>._nextState = assign(&#123;&#125;, <span class="keyword">this</span>.state));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">typeof</span> update!==<span class="string">'function'</span> || (update = update(s, <span class="keyword">this</span>.props))) &#123;</span><br><span class="line">		assign(s, update);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (update==<span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>._vnode) &#123;</span><br><span class="line">		<span class="keyword">if</span> (callback) <span class="keyword">this</span>._renderCallbacks.push(callback);</span><br><span class="line">		enqueueRender(<span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// src/util.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">assign</span>(<span class="params">obj, props</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">in</span> props) obj[i] = props[i];</span><br><span class="line">	<span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨preactçš„setStateæ–¹æ³•, åŒreactä¸€æ ·æ”¯æŒå‡½æ•°æˆ–è€…Objectä¸¤ç§æ–¹å¼æ›´æ–°state, å¹¶ä¸”æ”¯æŒsetStateçš„å›è°ƒã€‚æˆ‘ä»¬è¿™é‡Œçœ‹åˆ°äº†ä¸¤ä¸ªä¸ªç§æœ‰å±æ€§_nextState, _renderCallbacksã€‚_renderCallbacksåˆ™æ˜¯å­˜å‚¨äº†setStateå›è°ƒçš„é˜Ÿåˆ—ã€‚</p>
<p>_nextStateé‡Œå­˜å‚¨äº†æœ€æ–°çš„state, <strong>ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸å»ç›´æ¥æ›´æ–°stateå‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬è¦å®ç°ç”Ÿå‘½å‘¨æœŸ, æ¯”å¦‚getDerivedStateFromPropsç”Ÿå‘½å‘¨æœŸä¸­ç»„ä»¶çš„stateå¹¶æ²¡æœ‰æ›´æ–°å‘¢ã€‚æˆ‘ä»¬éœ€è¦ä½¿ç”¨_nextStateå­˜å‚¨æœ€æ–°çš„stateğŸ˜Š</strong>ã€‚enqueueRenderå‡½æ•°æ¶‰åŠåˆ°äº†stateçš„å¼‚æ­¥æ›´æ–°, æˆ‘ä»¬åœ¨æœ¬èŠ‚å…ˆä¸ä»‹ç»ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/component.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">Fragment</span>(<span class="params"></span>) </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">Component.prototype.render = Fragment;</span><br></pre></td></tr></table></figure>
<p>åŸºç±»çš„renderæ–¹æ³•æœ¬èº«æ˜¯ä¸€ä¸ªç©ºå‡½æ•°, éœ€è¦ç»§æ‰¿çš„å­ç±»è‡ªå·±å…·ä½“å®ç°ã€‚</p>
<p>ğŸ‰component.jsçš„æ¨¡å—çš„éƒ¨åˆ†å†…å®¹ï¼Œæˆ‘ä»¬å·²ç»ä»‹ç»å®Œæˆäº†, åŒæ ·ä¸æ˜¯å¾ˆå¤æ‚ã€‚component.jsçš„æ¨¡å—çš„å…¶ä»–çš„å†…å®¹å› ä¸ºæ¶‰åŠäº†setStateå¼‚æ­¥æ›´æ–°é˜Ÿåˆ—ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†åœ¨setStateä¸€èŠ‚ä¸­ã€‚å›è¿‡å¤´æ¥ä»‹ç»å®ƒã€‚</p>
<h2 id="diffç®—æ³•"><a href="#diffç®—æ³•" class="headerlink" title="diffç®—æ³•"></a>diffç®—æ³•</h2><p><img src="https://calendar.perfplanet.com/wp-content/uploads/2013/12/vjeux/1.png" alt="image"></p>
<p><img src="https://i.loli.net/2019/04/08/5caaee5c9cd4c.png" alt="image"></p>
<p>ps: ğŸ‘†æˆ‘ä»¬åªéœ€è¦æ¯”è¾ƒåŒçº§çš„èŠ‚ç‚¹(ç›¸åŒé¢œè‰²æ¡†å†…çš„), å¦‚æœä¸¤ä¸ªèŠ‚ç‚¹typeä¸ä¸€è‡´, æˆ‘ä»¬ä¼šé”€æ¯å½“å‰çš„èŠ‚ç‚¹ã€‚ä¸è¿›è¡Œæ¯”è¾ƒå­èŠ‚ç‚¹çš„æ“ä½œã€‚</p>
<p>åœ¨preactä¸­diffç®—æ³•ä»¥åŠçœŸå®domçš„æ›´æ–°å’Œæ¸²æŸ“æ˜¯æ‚ç³…åœ¨ä¸€èµ·çš„ã€‚æ‰€ä»¥æœ¬èŠ‚å†…å®¹ä¼šæ¯”è¾ƒå¤šã€‚</p>
<p>preactä¼šå­˜å‚¨ä¸Šä¸€æ¬¡çš„æ¸²æŸ“çš„VNode(<strong>å­˜å‚¨åœ¨_prevVNodeçš„ç§æœ‰å±æ€§ä¸Š</strong>)ã€‚è€Œæœ¬æ¬¡æ¸²æŸ“è¿‡ç¨‹ä¸­æˆ‘ä»¬ä¼šæ¯”è¾ƒæœ¬æ¬¡çš„VNodeä¸Šå‰ä¸€æ¬¡çš„_prevVNodeã€‚åˆ¤æ–­æ˜¯å¦éœ€è¦ç”Ÿæˆæ–°çš„Dom, å¸è½½Domçš„æ“ä½œ, æ›´æ–°çœŸå®domçš„æ“ä½œ(<strong>æˆ‘ä»¬å°†VNodeå¯¹åº”çš„çœŸå®çš„domå­˜å‚¨åœ¨VNodeçš„ç§æœ‰å±æ€§_dom, å¯ä»¥å®ç°åœ¨diffçš„è¿‡ç¨‹ä¸­æ›´æ–°domçš„æ“ä½œ</strong>)ã€‚</p>
<h3 id="å¯¹æ¯”æ–‡æœ¬èŠ‚ç‚¹"><a href="#å¯¹æ¯”æ–‡æœ¬èŠ‚ç‚¹" class="headerlink" title="å¯¹æ¯”æ–‡æœ¬èŠ‚ç‚¹"></a>å¯¹æ¯”æ–‡æœ¬èŠ‚ç‚¹</h3><p>æˆ‘ä»¬é¦–å…ˆå›å¿†ä¸€ä¸‹æ–‡æœ¬èŠ‚ç‚¹çš„VNodeçš„ç»“æ„æ˜¯æ€ä¹ˆæ ·çš„</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–‡æœ¬èŠ‚ç‚¹VNode</span></span><br><span class="line">&#123;</span><br><span class="line">  type: <span class="literal">null</span>,</span><br><span class="line">  props: <span class="literal">null</span>,</span><br><span class="line">  text: <span class="string">'ä½ çš„æ–‡æœ¬'</span></span><br><span class="line">  _dom: TextNode</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬é¦–å…ˆè¿›å…¥diffæ–¹æ³•ã€‚diffæ–¹æ³•ä¸­ä¼šå¯¹VNodeç±»å‹è¿›è¡Œåˆ¤æ–­, å¦‚æœä¸æ˜¯functionç±»å‹(ç»„ä»¶ç±»å‹), å’ŒFragmentç±»å‹ã€‚æˆ‘ä»¬çš„ä¼šè°ƒç”¨diffElementNodeså‡½æ•°ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/diff/index.js</span></span><br><span class="line"><span class="comment">// func diff</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å‚æ•°å¾ˆå¤š, æˆ‘ä»¬æ¥è¯´ä¸‹å‡ ä¸ªå‚æ•°çš„å…·ä½“å«ä¹‰</span></span><br><span class="line"><span class="comment">// domä¸ºVNodeå¯¹åº”çš„çœŸå®çš„DomèŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">// newVNodeæ–°çš„VNode</span></span><br><span class="line"><span class="comment">// oldVNodeæ—§çš„VNode</span></span><br><span class="line"><span class="comment">// mountså­˜å‚¨æŒ‚è½½ç»„ä»¶çš„åˆ—è¡¨</span></span><br><span class="line">dom = diffElementNodes(dom, newVNode, oldVNode, context, isSvg, excessDomChildren, mounts, ancestorComponent)</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ­¤æ—¶domè¿˜æ²¡æœ‰åˆ›å»ºã€‚åˆæ¬¡æ¸²æŸ“, é‚£ä¹ˆæˆ‘ä»¬æ ¹æ®VNodeç±»å‹åˆ›å»ºå¯¹åº”çš„çœŸå®domèŠ‚ç‚¹ã€‚æ–‡æœ¬ç±»å‹ä¼šä½¿ç”¨createTextNodeåˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šæ ‡ç­¾ä¹‹å‰VNodeçš„textçš„å†…å®¹, å¦‚æœæ–°æ—§ä¸ç›¸ç­‰ã€‚æˆ‘ä»¬å°†æ–°VNodeçš„textå±æ€§ï¼Œèµ‹å€¼ç»™domèŠ‚ç‚¹ã€‚å®Œæˆå¯¹domçš„æ›´æ–°æ“ä½œã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// src/diff/index.js</span></span><br><span class="line"><span class="comment">// func diffElementNodes</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (dom==<span class="literal">null</span>) &#123;</span><br><span class="line">	dom = newVNode.type===<span class="literal">null</span> ? <span class="built_in">document</span>.createTextNode(newVNode.text) : isSvg ? <span class="built_in">document</span>.createElementNS(<span class="string">'http://www.w3.org/2000/svg'</span>, newVNode.type) : <span class="built_in">document</span>.createElement(newVNode.type);</span><br><span class="line"></span><br><span class="line">	excessDomChildren = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">newVNode._dom = dom;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (newVNode.type===<span class="literal">null</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> ((d===<span class="literal">null</span> || dom===d) &amp;&amp; newVNode.text!==oldVNode.text) &#123;</span><br><span class="line">		dom.data = newVNode.text;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å¯¹æ¯”éæ–‡æœ¬DOMèŠ‚ç‚¹"><a href="#å¯¹æ¯”éæ–‡æœ¬DOMèŠ‚ç‚¹" class="headerlink" title="å¯¹æ¯”éæ–‡æœ¬DOMèŠ‚ç‚¹"></a>å¯¹æ¯”éæ–‡æœ¬DOMèŠ‚ç‚¹</h3><p>éæ–‡æœ¬DOMèŠ‚ç‚¹ğŸˆ¯ï¸çš„æ˜¯é‚£äº›typeä¸ºdiv, span, h1çš„VNodeèŠ‚ç‚¹ã€‚è¿™äº›ç±»å‹çš„èŠ‚ç‚¹åœ¨diffæ–¹æ³•ä¸­, æˆ‘ä»¬ä¾æ—§ä¼šè°ƒç”¨diffElementNodeså‡½æ•°å»å¤„ç†ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// src/diff/index.js</span></span><br><span class="line"><span class="comment">// func diff</span></span><br><span class="line"></span><br><span class="line">dom = diffElementNodes(dom, newVNode, oldVNode, context, isSvg, excessDomChildren, mounts, ancestorComponent)</span><br></pre></td></tr></table></figure>
<p>è¿›å…¥diffElementNodesæ–¹æ³•å, å¦‚æœæ˜¯åˆæ¬¡æ¸²æŸ“æˆ‘ä»¬ä¼šä½¿ç”¨createElementåˆ›å»ºçœŸå®çš„domèŠ‚ç‚¹æŒ‚è½½åˆ°VNodeçš„_domå±æ€§ä¸Šã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šæ¯”è¾ƒæ–°æ—§VNodeçš„å±æ€§propsã€‚ä½†æ˜¯ä¹‹å‰ä¼šè°ƒç”¨diffChildrenæ–¹æ³•, å¯¹å½“å‰çš„VNodeå­èŠ‚ç‚¹è¿›è¡Œæ¯”è¾ƒã€‚æˆ‘ä»¬è¿™é‡Œå…ˆä¸è¿›å…¥diffChildrenå‡½æ•°ä¸­ã€‚<strong>æˆ‘ä»¬åªéœ€è¦çŸ¥é“æˆ‘ä»¬åœ¨æ›´æ–°å½“å‰èŠ‚ç‚¹å±æ€§çš„æ—¶å€™, æˆ‘ä»¬å·²ç»é€šè¿‡é€’å½’å½¢å¼, å®Œæˆäº†å¯¹å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹çš„æ›´æ–°æ“ä½œã€‚</strong>æ¥ä¸‹æ¥æˆ‘ä»¬è¿›å…¥diffPropså‡½æ•°ä¸­ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// src/diff/index.js</span></span><br><span class="line"><span class="comment">// func diffElementNodes</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (dom==<span class="literal">null</span>) &#123;</span><br><span class="line">	dom = newVNode.type===<span class="literal">null</span> ? <span class="built_in">document</span>.createTextNode(newVNode.text) : isSvg ? <span class="built_in">document</span>.createElementNS(<span class="string">'http://www.w3.org/2000/svg'</span>, newVNode.type) : <span class="built_in">document</span>.createElement(newVNode.type);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">newVNode._dom = dom;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (newVNode !== oldVNode) &#123;</span><br><span class="line">	<span class="keyword">let</span> oldProps = oldVNode.props;</span><br><span class="line">	<span class="keyword">let</span> newProps = newVNode.props;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (oldProps == <span class="literal">null</span>) &#123;</span><br><span class="line">		oldProps = &#123;&#125;;</span><br><span class="line">	&#125;</span><br><span class="line">	diffChildren(dom, newVNode, oldVNode, context, newVNode.type === <span class="string">'foreignObject'</span> ? <span class="literal">false</span> : isSvg, excessDomChildren, mounts, ancestorComponent);</span><br><span class="line">	diffProps(dom, newProps, oldProps, isSvg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨diffPropså‡½æ•°ä¸­æˆ‘ä»¬ä¼šåšä¸¤ä»¶äº‹ã€‚è®¾ç½®, æ›´æ–°å±æ€§ã€‚åˆ é™¤æ–°çš„propsä¸­ä¸å­˜åœ¨çš„å±æ€§ã€‚setPropertyåœ¨preactä¸­çš„å…·ä½“å®ç°, æˆ‘ä»¬å¾€ä¸‹çœ‹ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// src/diff/props.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">diffProps</span>(<span class="params">dom, newProps, oldProps, isSvg</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// è®¾ç½®æˆ–æ›´æ–°å±æ€§å€¼</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">in</span> newProps) &#123;</span><br><span class="line">		<span class="keyword">if</span> (i!==<span class="string">'children'</span> &amp;&amp; i!==<span class="string">'key'</span> &amp;&amp; (!oldProps || ((i===<span class="string">'value'</span> || i===<span class="string">'checked'</span>) ? dom : oldProps)[i]!==newProps[i])) &#123;</span><br><span class="line">			setProperty(dom, i, newProps[i], oldProps[i], isSvg);</span><br><span class="line">		&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// åˆ é™¤å±æ€§</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">in</span> oldProps) &#123;</span><br><span class="line">		<span class="keyword">if</span> (i!==<span class="string">'children'</span> &amp;&amp; i!==<span class="string">'key'</span> &amp;&amp; (!newProps || !(i <span class="keyword">in</span> newProps))) &#123;</span><br><span class="line">			setProperty(dom, i, <span class="literal">null</span>, oldProps[i], isSvg);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨setPropertyæ–¹æ³•ä¸­, å¦‚æœvalue(æ–°çš„å±æ€§å€¼)ä¸ºnull, æˆ‘ä»¬ä¼šåˆ é™¤å¯¹åº”çš„å±æ€§ã€‚å¦‚æœä¸ä¸ºnull, æˆ‘ä»¬å°†ä¼šæ›´æ–°æˆ–è€…è®¾ç½®æ–°çš„å±æ€§ã€‚åŒæ—¶è¿˜ä¼šå¯¹äº‹ä»¶è¿›è¡Œå¤„ç†, ä¾‹å¦‚onClickå±æ€§, æˆ‘ä»¬ä¼šä½¿ç”¨addEventListeneræ·»åŠ åŸç”Ÿçš„clickäº‹ä»¶ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// src/diff/props.js</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setProperty</span>(<span class="params">dom, name, value, oldValue, isSvg</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> v;</span><br><span class="line">  <span class="comment">// å¯¹classå¤„ç†</span></span><br><span class="line">	<span class="keyword">if</span> (name===<span class="string">'class'</span> || name===<span class="string">'className'</span>) name = isSvg ? <span class="string">'class'</span> : <span class="string">'className'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¯¹styleå¤„ç†, styleä¼ å…¥Objectæˆ–è€…å­—ç¬¦ä¸²éƒ½ä¼šå¾—åˆ°å…¼å®¹çš„å¤„ç†</span></span><br><span class="line">	<span class="keyword">if</span> (name===<span class="string">'style'</span>) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">let</span> s = dom.style;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœstyleæ˜¯stringç±»å‹</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">typeof</span> value===<span class="string">'string'</span>) &#123;</span><br><span class="line">			s.cssText = value;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœstyleæ˜¯objectç±»å‹</span></span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">typeof</span> oldValue===<span class="string">'string'</span>) s.cssText = <span class="string">''</span>;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">in</span> oldValue) &#123;</span><br><span class="line">					<span class="keyword">if</span> (value==<span class="literal">null</span> || !(i <span class="keyword">in</span> value)) s.setProperty(i.replace(CAMEL_REG, <span class="string">'-'</span>), <span class="string">''</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">in</span> value) &#123;</span><br><span class="line">				v = value[i];</span><br><span class="line">				<span class="keyword">if</span> (oldValue==<span class="literal">null</span> || v!==oldValue[i]) &#123;</span><br><span class="line">					s.setProperty(i.replace(CAMEL_REG, <span class="string">'-'</span>), <span class="keyword">typeof</span> v===<span class="string">'number'</span> &amp;&amp; IS_NON_DIMENSIONAL.test(i)===<span class="literal">false</span> ? (v + <span class="string">'px'</span>) : v);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (name===<span class="string">'dangerouslySetInnerHTML'</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (name[<span class="number">0</span>]===<span class="string">'o'</span> &amp;&amp; name[<span class="number">1</span>]===<span class="string">'n'</span>) &#123;</span><br><span class="line">    <span class="comment">// å¯¹äº‹ä»¶å¤„ç†</span></span><br><span class="line">		<span class="keyword">let</span> useCapture = name !== (name=name.replace(<span class="regexp">/Capture$/</span>, <span class="string">''</span>));</span><br><span class="line">		<span class="keyword">let</span> nameLower = name.toLowerCase();</span><br><span class="line">		name = (nameLower <span class="keyword">in</span> dom ? nameLower : name).substring(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (value) &#123;</span><br><span class="line">			<span class="keyword">if</span> (!oldValue) dom.addEventListener(name, eventProxy, useCapture);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			dom.removeEventListener(name, eventProxy, useCapture);</span><br><span class="line">		&#125;</span><br><span class="line">		(dom._listeners || (dom._listeners = &#123;&#125;))[name] = value;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (name!==<span class="string">'list'</span> &amp;&amp; name!==<span class="string">'tagName'</span> &amp;&amp; !isSvg &amp;&amp; (name <span class="keyword">in</span> dom)) &#123;</span><br><span class="line">		dom[name] = value==<span class="literal">null</span> ? <span class="string">''</span> : value;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (value==<span class="literal">null</span> || value===<span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="comment">// åˆ é™¤ä»¥åŠä¸ºnullçš„å±æ€§</span></span><br><span class="line">		<span class="keyword">if</span> (name!==(name = name.replace(<span class="regexp">/^xlink:?/</span>, <span class="string">''</span>))) dom.removeAttributeNS(<span class="string">'http://www.w3.org/1999/xlink'</span>, name.toLowerCase());</span><br><span class="line">		<span class="keyword">else</span> dom.removeAttribute(name);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> value!==<span class="string">'function'</span>) &#123;</span><br><span class="line">    <span class="comment">// æ›´æ–°æˆ–è®¾ç½®æ–°çš„å±æ€§</span></span><br><span class="line">		<span class="keyword">if</span> (name!==(name = name.replace(<span class="regexp">/^xlink:?/</span>, <span class="string">''</span>))) dom.setAttributeNS(<span class="string">'http://www.w3.org/1999/xlink'</span>, name.toLowerCase(), value);</span><br><span class="line">		<span class="keyword">else</span> dom.setAttribute(name, value);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å¯¹æ¯”ç»„ä»¶"><a href="#å¯¹æ¯”ç»„ä»¶" class="headerlink" title="å¯¹æ¯”ç»„ä»¶"></a>å¯¹æ¯”ç»„ä»¶</h3><p><img src="https://i.loli.net/2019/04/06/5ca88be74abba.jpg" alt="image"></p>
<p>å¦‚æœVNodeæ˜¯ç»„ä»¶ç±»å‹ã€‚åœ¨diffå‡½æ•°ä¸­, ä¼šåœ¨ä¸åŒçš„æ—¶åˆ»æ‰§è¡Œç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸã€‚åœ¨diffä¸­, æ‰§è¡Œç»„ä»¶å®ä¾‹çš„renderå‡½æ•°ã€‚æˆ‘ä»¬å°†ä¼šæ‹¿åˆ°ç»„ä»¶è¿”å›çš„VNode, ç„¶åå†å°†VNodeå†ä¸€æ¬¡å¸¦å…¥diffæ–¹æ³•ä¸­è¿›è¡Œdiffæ¯”è¾ƒã€‚å¤§è‡´çš„æµç¨‹å¯ä»¥å¦‚ä¸Šå›¾æ‰€ç¤ºã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// src/diff/index.js</span></span><br><span class="line"><span class="comment">// func diff</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> c, p, isNew = <span class="literal">false</span>, oldProps, oldState, snapshot,</span><br><span class="line">  newType = newVNode.type;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">let</span> cxType = newType.contextType;</span><br><span class="line"><span class="keyword">let</span> provider = cxType &amp;&amp; context[cxType._id];</span><br><span class="line"><span class="keyword">let</span> cctx = cxType != <span class="literal">null</span> ? (provider ? provider.props.value : cxType._defaultValue) : context;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (oldVNode._component) &#123;</span><br><span class="line">	c = newVNode._component = oldVNode._component;</span><br><span class="line">	clearProcessingException = c._processingException;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">	isNew = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºç»„ä»¶çš„å®ä¾‹</span></span><br><span class="line">	<span class="keyword">if</span> (newType.prototype &amp;&amp; newType.prototype.render) &#123;</span><br><span class="line">		newVNode._component = c = <span class="keyword">new</span> newType(newVNode.props, cctx);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		newVNode._component = c = <span class="keyword">new</span> Component(newVNode.props, cctx);</span><br><span class="line">		c.constructor = newType;</span><br><span class="line">		c.render = doRender;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">	c._ancestorComponent = ancestorComponent;</span><br><span class="line">	<span class="keyword">if</span> (provider) provider.sub(c);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆå§‹åŒ–,ç»„ä»¶çš„state, propsçš„å±æ€§</span></span><br><span class="line">	c.props = newVNode.props;</span><br><span class="line">	<span class="keyword">if</span> (!c.state) c.state = &#123;&#125;;</span><br><span class="line">	c.context = cctx;</span><br><span class="line">	c._context = context;</span><br><span class="line">	c._dirty = <span class="literal">true</span>;</span><br><span class="line">	c._renderCallbacks = [];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»„ä»¶çš„å®ä¾‹ä¸ŠæŒ‚è½½ç»„ä»¶æ‰€å¯¹åº”çš„VNodeèŠ‚ç‚¹</span></span><br><span class="line">c._vnode = newVNode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> s = c._nextState || c.state;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰§è¡ŒgetDerivedStateFromPropsç”Ÿå‘½å‘¨æœŸå‡½æ•°, è¿”å›åªä¼šæ›´æ–°ç»„ä»¶çš„state</span></span><br><span class="line"><span class="keyword">if</span> (newType.getDerivedStateFromProps != <span class="literal">null</span>) &#123;</span><br><span class="line">	oldState = assign(&#123;&#125;, c.state);</span><br><span class="line">	<span class="keyword">if</span> (s === c.state) s = c._nextState = assign(&#123;&#125;, s);</span><br><span class="line">	assign(s, newType.getDerivedStateFromProps(newVNode.props, s));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (isNew) &#123;</span><br><span class="line">  <span class="comment">// æ‰§è¡ŒcomponentWillMountç”Ÿå‘½å‘¨æœŸ</span></span><br><span class="line">  <span class="keyword">if</span> (newType.getDerivedStateFromProps == <span class="literal">null</span> &amp;&amp; c.componentWillMount != <span class="literal">null</span>) c.componentWillMount();</span><br><span class="line">  <span class="comment">// å°†éœ€è¦æ‰§è¡ŒcomponentDidMountç”Ÿå‘½å‘¨æœŸçš„ç»„ä»¶, pushåˆ°mountsé˜Ÿåˆ—ä¸­</span></span><br><span class="line">	<span class="keyword">if</span> (c.componentDidMount != <span class="literal">null</span>) mounts.push(c);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// æ‰§è¡ŒcomponentWillReceivePropsç”Ÿå‘½å‘¨æœŸ</span></span><br><span class="line">	<span class="keyword">if</span> (newType.getDerivedStateFromProps == <span class="literal">null</span> &amp;&amp; force == <span class="literal">null</span> &amp;&amp; c.componentWillReceiveProps != <span class="literal">null</span>) &#123;</span><br><span class="line">		c.componentWillReceiveProps(newVNode.props, cctx);</span><br><span class="line">		s = c._nextState || c.state;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ‰§è¡ŒshouldComponentUpdateç”Ÿå‘½å‘¨æœŸ, å¹¶å°†_dirtyè®¾ç½®ä¸ºfalse, å½“_dirtyè¢«è®¾ç½®ä¸ºfalseæ—¶, æ‰§è¡Œçš„æ›´æ–°æ“ä½œå°†ä¼šè¢«æš‚åœ</span></span><br><span class="line">	<span class="keyword">if</span> (!force &amp;&amp; c.shouldComponentUpdate != <span class="literal">null</span> &amp;&amp; c.shouldComponentUpdate(newVNode.props, s, cctx) === <span class="literal">false</span>) &#123;</span><br><span class="line">		c.props = newVNode.props;</span><br><span class="line">		c.state = s;</span><br><span class="line">    c._dirty = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// breakåï¼Œä¸åœ¨æ‰§è¡Œä»¥ä¸‹çš„ä»£ç </span></span><br><span class="line">		<span class="keyword">break</span> outer;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ‰§è¡ŒcomponentWillUpdateç”Ÿå‘½å‘¨æœŸ</span></span><br><span class="line">	<span class="keyword">if</span> (c.componentWillUpdate != <span class="literal">null</span>) &#123;</span><br><span class="line">		c.componentWillUpdate(newVNode.props, s, cctx);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">oldProps = c.props;</span><br><span class="line"><span class="keyword">if</span> (!oldState) oldState = c.state;</span><br><span class="line"></span><br><span class="line">c.context = cctx;</span><br><span class="line">c.props = newVNode.props;</span><br><span class="line"><span class="comment">// å°†æ›´æ–°åçš„stateçš„sï¼Œèµ‹äºˆç»„ä»¶çš„state</span></span><br><span class="line">c.state = s;</span><br><span class="line"></span><br><span class="line"><span class="comment">// prevä¸ºä¸Šä¸€æ¬¡æ¸²æŸ“æ—¶å¯¹åº”çš„VNodeèŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">let</span> prev = c._prevVNode;</span><br><span class="line"><span class="comment">// è°ƒç”¨ç»„ä»¶çš„renderæ–¹æ³•è·å–ç»„ä»¶çš„VNode</span></span><br><span class="line"><span class="keyword">let</span> vnode = c._prevVNode = coerceToVNode(c.render(c.props, c.state, c.context));</span><br><span class="line">c._dirty = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (c.getChildContext != <span class="literal">null</span>) &#123;</span><br><span class="line">	context = assign(assign(&#123;&#125;, context), c.getChildContext());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰§è¡ŒgetSnapshotBeforeUpdateç”Ÿå‘½å‘¨æœŸ</span></span><br><span class="line"><span class="keyword">if</span> (!isNew &amp;&amp; c.getSnapshotBeforeUpdate != <span class="literal">null</span>) &#123;</span><br><span class="line">	snapshot = c.getSnapshotBeforeUpdate(oldProps, oldState);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ›´æ–°ç»„ä»¶æ‰€å¯¹åº”çš„VNodeï¼Œè¿”å›å¯¹åº”çš„dom</span></span><br><span class="line">c.base = dom = diff(dom, parentDom, vnode, prev, context, isSvg, excessDomChildren, mounts, c, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (vnode != <span class="literal">null</span>) &#123;</span><br><span class="line">	newVNode._lastDomChild = vnode._lastDomChild;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">c._parentDom = parentDom;</span><br></pre></td></tr></table></figure>
<p>åœ¨diffå‡½æ•°çš„é¡¶éƒ¨æœ‰è¿™æ ·ä¸€æ®µä»£ç ä¸Šé¢æœ‰ä¸€å¥è‹±æ–‡æ³¨é‡Š(<strong>If the previous type doesnâ€™t match the new type we drop the whole subtree</strong>), å¦‚æœoldVNodeå’ŒnewVNodeç±»å‹ä¸åŒï¼Œæˆ‘ä»¬å°†ä¼šå¸è½½æ•´ä¸ªå­æ ‘ğŸŒ²ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> (oldVNode==<span class="literal">null</span> || newVNode==<span class="literal">null</span> || oldVNode.type!==newVNode.type) &#123;</span><br><span class="line">  <span class="comment">// å¦‚æœnewVNodeä¸ºnull, æˆ‘ä»¬å°†ä¼šå¸è½½æ•´ä¸ªç»„ä»¶, å¹¶åˆ é™¤å¯¹åº”çš„domèŠ‚ç‚¹ </span></span><br><span class="line">	<span class="keyword">if</span> (oldVNode!=<span class="literal">null</span>) unmount(oldVNode, ancestorComponent);</span><br><span class="line">	<span class="keyword">if</span> (newVNode==<span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	dom = <span class="literal">null</span>;</span><br><span class="line">	oldVNode = EMPTY_OBJ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å¯¹æ¯”å­èŠ‚ç‚¹"><a href="#å¯¹æ¯”å­èŠ‚ç‚¹" class="headerlink" title="å¯¹æ¯”å­èŠ‚ç‚¹"></a>å¯¹æ¯”å­èŠ‚ç‚¹</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">diffChildren</span>(<span class="params">parentDom, newParentVNode, oldParentVNode, context, isSvg, excessDomChildren, mounts, ancestorComponent</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">let</span> childVNode, i, j, p, index, oldVNode, newDom,</span><br><span class="line">		nextDom, sibDom, focus,</span><br><span class="line">		childDom;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">let</span> newChildren = newParentVNode._children || toChildArray(newParentVNode.props.children, newParentVNode._children=[], coerceToVNode);</span><br><span class="line">	<span class="keyword">let</span> oldChildren = oldParentVNode!=<span class="literal">null</span> &amp;&amp; oldParentVNode!=EMPTY_OBJ &amp;&amp; oldParentVNode._children || EMPTY_ARR;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">let</span> oldChildrenLength = oldChildren.length;</span><br><span class="line"></span><br><span class="line">  childDom = oldChildrenLength ? oldChildren[<span class="number">0</span>] &amp;&amp; oldChildren[<span class="number">0</span>]._dom : <span class="literal">null</span>;</span><br><span class="line">  </span><br><span class="line">	<span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;newChildren.length; i++) &#123;</span><br><span class="line">		childVNode = newChildren[i] = coerceToVNode(newChildren[i]);</span><br><span class="line">		oldVNode = index = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    p = oldChildren[i];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">		<span class="keyword">if</span> (p != <span class="literal">null</span> &amp;&amp; (childVNode.key==<span class="literal">null</span> &amp;&amp; p.key==<span class="literal">null</span> ? (childVNode.type === p.type) : (childVNode.key === p.key))) &#123;</span><br><span class="line">			index = i;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">for</span> (j=<span class="number">0</span>; j&lt;oldChildrenLength; j++) &#123;</span><br><span class="line">				p = oldChildren[j];</span><br><span class="line">				<span class="keyword">if</span> (p!=<span class="literal">null</span>) &#123;</span><br><span class="line">					<span class="keyword">if</span> (childVNode.key==<span class="literal">null</span> &amp;&amp; p.key==<span class="literal">null</span> ? (childVNode.type === p.type) : (childVNode.key === p.key)) &#123;</span><br><span class="line">						index = j;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (index!=<span class="literal">null</span>) &#123;</span><br><span class="line">			oldVNode = oldChildren[index];</span><br><span class="line">			oldChildren[index] = <span class="literal">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">    nextDom = childDom!=<span class="literal">null</span> &amp;&amp; childDom.nextSibling;</span><br><span class="line">    </span><br><span class="line">		newDom = diff(oldVNode==<span class="literal">null</span> ? <span class="literal">null</span> : oldVNode._dom, parentDom, childVNode, oldVNode, context, isSvg, excessDomChildren, mounts, ancestorComponent, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (childVNode!=<span class="literal">null</span> &amp;&amp; newDom !=<span class="literal">null</span>) &#123;</span><br><span class="line">			focus = <span class="built_in">document</span>.activeElement;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (childVNode._lastDomChild != <span class="literal">null</span>) &#123;</span><br><span class="line">				newDom = childVNode._lastDomChild;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (excessDomChildren==oldVNode || newDom!=childDom || newDom.parentNode==<span class="literal">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">				outer: <span class="keyword">if</span> (childDom==<span class="literal">null</span> || childDom.parentNode!==parentDom) &#123;</span><br><span class="line">					parentDom.appendChild(newDom);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> &#123;</span><br><span class="line">					sibDom = childDom;</span><br><span class="line">					j = <span class="number">0</span>;</span><br><span class="line">					<span class="keyword">while</span> ((sibDom=sibDom.nextSibling) &amp;&amp; j++<span class="xml"><span class="tag">&lt;<span class="name">oldChildrenLength</span>/<span class="attr">2</span>) &#123;</span></span></span><br><span class="line"><span class="xml">						if (sibDom===newDom) &#123;</span></span><br><span class="line"><span class="xml">							break outer;</span></span><br><span class="line"><span class="xml">						&#125;</span></span><br><span class="line"><span class="xml">					&#125;</span></span><br><span class="line"><span class="xml">					parentDom.insertBefore(newDom, childDom);</span></span><br><span class="line"><span class="xml">				&#125;</span></span><br><span class="line"><span class="xml">			&#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">			if (focus!==document.activeElement) &#123;</span></span><br><span class="line"><span class="xml">				focus.focus();</span></span><br><span class="line"><span class="xml">			&#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">			childDom = newDom!=null ? newDom.nextSibling : nextDom;</span></span><br><span class="line"><span class="xml">		&#125;</span></span><br><span class="line"><span class="xml">	&#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">	for (i=oldChildrenLength; i--; ) &#123;</span></span><br><span class="line"><span class="xml">		if (oldChildren[i]!=null) &#123;</span></span><br><span class="line"><span class="xml">			unmount(oldChildren[i], ancestorComponent);</span></span><br><span class="line"><span class="xml">		&#125;</span></span><br><span class="line"><span class="xml">	&#125;</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure>
<p>diffChildrenæ˜¯æœ€ä¸ºå¤æ‚çš„ä¸€éƒ¨åˆ†å†…å®¹ã€‚å­VNodeä½œä¸ºä¸€ä¸ªæ•°ç»„, æ•°ç»„ä¸­çš„å†…å®¹å¯èƒ½æ”¹å˜äº†é¡ºåºæˆ–è€…æ•°ç›®, å¾ˆéš¾ç¡®å®šæ–°çš„VNodeè¦å’Œé‚£ä¸€ä¸ªæ—§çš„VNodeæ¯”è¾ƒã€‚æ‰€ä»¥preactä¸­å½“é¢å¯¹åˆ—è¡¨æ—¶ï¼Œæˆ‘ä»¬å°†è¦æ±‚ç”¨æˆ·æä¾›key, å¸®åŠ©æˆ‘ä»¬æ¯”è¾ƒVNodeã€‚è¾¾åˆ°å¤ç”¨Domçš„ç›®çš„ã€‚</p>
<p>åœ¨diffChildrenä¸­ï¼Œæˆ‘ä»¬ä¼šé¦–å…ˆé€šè¿‡toChildArrayå‡½æ•°å°†å­èŠ‚ç‚¹ä»¥æ•°ç»„çš„å½¢å¼å­˜å‚¨åœ¨_childrenå±æ€§ä¸Šã€‚</p>
<p>childDomä¸ºç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹çœŸå®çš„dom(<strong>è¿™å¾ˆæœ‰ç”¨, æˆ‘ä»¬åœ¨åé¢å°†é€šè¿‡å®ƒæ¥åˆ¤æ–­æ˜¯ä½¿ç”¨appendChildæ’å…¥newDomè¿˜æ˜¯ä½¿ç”¨insertBeforeæ’å…¥newDomï¼Œæˆ–è€…ä»€ä¹ˆéƒ½ä¸åš</strong>)</p>
<p>æ¥ä¸‹æ¥éå†_childrenå±æ€§ã€‚å¦‚æœVNodeæœ‰keyå±æ€§, åˆ™æ‰¾åˆ°keyä¸keyç›¸ç­‰çš„æ—§çš„VNodeã€‚å¦‚æœæ²¡æœ‰key, åˆ™æ‰¾åˆ°æœ€è¿‘çš„typeç›¸ç­‰çš„æ—§çš„VNodeã€‚ç„¶åå°†oldChildrenå¯¹åº”çš„ä½ç½®è®¾ç½®null, é¿å…é‡å¤çš„æŸ¥æ‰¾ã€‚ä½¿ç”¨diffç®—æ³•å¯¹æ¯”, æ–°æ—§VNodeã€‚è¿”å›æ–°çš„domã€‚</p>
<p><strong>å¦‚æœchildDomä¸ºnullã€‚åªä¼šåœ¨ä¸¤ç§æƒ…å†µä¸‹å‡ºç°ï¼Œç¬¬ä¸€ç§å¯èƒ½æ˜¯ç¬¬ä¸€æ¬¡æ¸²æŸ“oldChildrenå°šä¸å­˜åœ¨ï¼Œç¬¬äºŒç§å¯èƒ½æ˜¯æˆ‘ä»¬å·²ç»æ¯”è¾ƒåˆ°äº†åˆ—è¡¨æœ€åçš„ä½ç½®childDomå·²ç»ä¸ºnullã€‚è¿™ä¸¤ç§æƒ…å†µéƒ½æ˜¯åˆ™å°†diffè¿”å›çš„dom, appendçš„åˆ°çˆ¶DOMä¸­ã€‚</strong></p>
<p><strong>å¦‚æœchildDomä¸ä¸ºnull, æˆ‘ä»¬å…ˆæŸ¥æ‰¾childDomåé¢çš„domæ˜¯å¦å­˜åœ¨ä¸newDomç›¸ç­‰çš„domã€‚å¦‚æœå­˜åœ¨æˆ‘ä»¬ä¸å»åšä»»ä½•å¤„ç†(domå±æ€§ç›¸å…³çš„å˜æ›´å·²ç»åœ¨diffElementNodeå®Œæˆäº†)ã€‚å¦‚æœæˆ‘ä»¬åœ¨childDomåé¢æ²¡æœ‰æ‰¾åˆ°ä¸newDomç›¸ç­‰çš„domï¼Œåˆ™è¯´æ˜åˆ—è¡¨ä¸å­˜åœ¨newDomï¼Œæˆ‘ä»¬å°†æ’å…¥åˆ°childDomçš„å‰é¢</strong></p>
<p>ä¸‹é¢éå†å‰©ä½™æ²¡æœ‰ä½¿ç”¨åˆ°oldChildren, å¸è½½è¿™äº›èŠ‚ç‚¹æˆ–è€…ç»„ä»¶ã€‚</p>
<h2 id="å¼‚æ­¥setState"><a href="#å¼‚æ­¥setState" class="headerlink" title="å¼‚æ­¥setState"></a>å¼‚æ­¥setState</h2><p>preacté™¤äº†ä½¿ç”¨diffç®—æ³•å‡å°‘domæ“ä½œä¼˜åŒ–æ€§èƒ½å¤–, preactä¼šå°†ä¸€æ®µæ—¶é—´å†…çš„å¤šæ¬¡setStateåˆå¹¶å‡å°‘ç»„ä»¶æ¸²æŸ“çš„æ¬¡æ•°ã€‚</p>
<p>æˆ‘ä»¬é¦–å…ˆåœ¨setStateä¸­, å¹¶æ²¡æœ‰ç›´æ¥æ›´æ–°state, æˆ–è€…ç›´æ¥é‡æ–°æ¸²æŸ“å‡½æ•°å‡½æ•°ã€‚è€Œæ˜¯å°†ç»„ä»¶çš„å®ä¾‹å¸¦å…¥åˆ°äº†enqueueRenderå‡½æ•°ä¸­ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Component.prototype.setState = <span class="function"><span class="keyword">function</span>(<span class="params">update, callback</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">let</span> s = (<span class="keyword">this</span>._nextState!==<span class="keyword">this</span>.state &amp;&amp; <span class="keyword">this</span>._nextState) || (<span class="keyword">this</span>._nextState = assign(&#123;&#125;, <span class="keyword">this</span>.state));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">typeof</span> update!==<span class="string">'function'</span> || (update = update(s, <span class="keyword">this</span>.props))) &#123;</span><br><span class="line">		assign(s, update);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (update==<span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>._vnode) &#123;</span><br><span class="line">		<span class="keyword">if</span> (callback) <span class="keyword">this</span>._renderCallbacks.push(callback);</span><br><span class="line">		enqueueRender(<span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>åœ¨enqueueRenderå‡½æ•°ä¸­, æˆ‘ä»¬å°†ç»„ä»¶pushåˆ°é˜Ÿåˆ—qä¸­ã€‚</p>
<p>åŒæ—¶ä½¿ç”¨_dirtyæ§åˆ¶, é¿å…qé˜Ÿåˆ—ä¸­è¢«pushäº†ç›¸åŒçš„ç»„ä»¶ã€‚æˆ‘ä»¬åº”è¯¥åœ¨å¤šé•¿æ—¶é—´å†…æ¸…ç©ºqé˜Ÿåˆ—å‘¢?</p>
<p>æˆ‘ä»¬è¯¥å¦‚ä½•å®šä¹‰è¿™ä¹ˆä¸€æ®µæ—¶é—´å‘¢ï¼Ÿæ¯”è¾ƒå¥½çš„åšæ³•æ˜¯ä½¿ç”¨Promise.resolve()ã€‚åœ¨è¿™ä¸€æ®µæ—¶é—´çš„setStateæ“ä½œéƒ½ä¼šè¢«pushåˆ°qé˜Ÿåˆ—ä¸­ã€‚_nextStateå°†ä¼šè¢«åˆå¹¶åœ¨æ¸…ç©ºé˜Ÿåˆ—çš„æ—¶å€™ï¼Œä¸€å¹¶æ›´æ–°åˆ°stateä¸Šï¼Œé¿å…äº†é‡å¤çš„æ¸²æŸ“ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">let</span> q = [];</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">enqueueRender</span>(<span class="params">c</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!c._dirty &amp;&amp; (c._dirty = <span class="literal">true</span>) &amp;&amp; q.push(c) === <span class="number">1</span>) &#123;</span><br><span class="line">		(options.debounceRendering || defer)(process);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">process</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">let</span> p;</span><br><span class="line">	<span class="keyword">while</span> ((p=q.pop())) &#123;</span><br><span class="line">		<span class="keyword">if</span> (p._dirty) p.forceUpdate(<span class="literal">false</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> defer = <span class="keyword">typeof</span> <span class="built_in">Promise</span>==<span class="string">'function'</span> ? <span class="built_in">Promise</span>.prototype.then.bind(<span class="built_in">Promise</span>.resolve()) : setTimeout;</span><br></pre></td></tr></table></figure>
<p>åœ¨å®ä»»åŠ¡å®Œæˆåï¼Œæˆ‘ä»¬æ‰§è¡Œå¾®ä»»åŠ¡Promise.resolve(), æ¸…ç©ºqé˜Ÿåˆ—ï¼Œä½¿ç”¨diffæ–¹æ³•æ›´æ–°é˜Ÿåˆ—ä¸­çš„ç»„ä»¶ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Component.prototype.forceUpdate = <span class="function"><span class="keyword">function</span>(<span class="params">callback</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">let</span> vnode = <span class="keyword">this</span>._vnode, dom = <span class="keyword">this</span>._vnode._dom, parentDom = <span class="keyword">this</span>._parentDom;</span><br><span class="line">	<span class="keyword">if</span> (parentDom) &#123;</span><br><span class="line">		<span class="keyword">const</span> force = callback!==<span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">let</span> mounts = [];</span><br><span class="line">		dom = diff(dom, parentDom, vnode, vnode, <span class="keyword">this</span>._context, parentDom.ownerSVGElement!==<span class="literal">undefined</span>, <span class="literal">null</span>, mounts, <span class="keyword">this</span>._ancestorComponent, force);</span><br><span class="line">		<span class="keyword">if</span> (dom!=<span class="literal">null</span> &amp;&amp; dom.parentNode!==parentDom) &#123;</span><br><span class="line">			parentDom.appendChild(dom);</span><br><span class="line">		&#125;</span><br><span class="line">		commitRoot(mounts, vnode);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (callback) callback();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="render"><a href="#render" class="headerlink" title="render"></a>render</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">vnode, parentDom</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (options.root) options.root(vnode, parentDom);</span><br><span class="line">	<span class="keyword">let</span> oldVNode = parentDom._prevVNode;</span><br><span class="line">	vnode = createElement(Fragment, <span class="literal">null</span>, [vnode]);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">let</span> mounts = [];</span><br><span class="line">	diffChildren(parentDom, parentDom._prevVNode = vnode, oldVNode, EMPTY_OBJ, parentDom.ownerSVGElement!==<span class="literal">undefined</span>, oldVNode ? <span class="literal">null</span> : EMPTY_ARR.slice.call(parentDom.childNodes), mounts, vnode);</span><br><span class="line">	commitRoot(mounts, vnode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨preactçš„renderå‡½æ•°ä¸­ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ ¹ç»„ä»¶ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºæ ¹ç»„ä»¶æŒ‚è½½çš„æ ¹èŠ‚ç‚¹ã€‚preactä¼šä½¿ç”¨FragmentåŒ…è£¹æ ¹ç»„ä»¶, æˆä¸ºå¦‚ä¸‹çš„VNodeã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  type: Fragment,</span><br><span class="line">  props: &#123;</span><br><span class="line">    children: [</span><br><span class="line">      vnode <span class="comment">// æ ¹èŠ‚ç‚¹</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¥ç€ä½¿ç”¨diffChildrenéå†ç»è¿‡FragmentåŒ…è£¹çš„ç»„ä»¶ã€‚åœ¨<a href="https://github.com/BengBu-YueZhang/very-simple-react" target="_blank" rel="noopener">very-simple-react</a>ä¸­ï¼Œç”±äºæˆ‘æ²¡æœ‰å®ç°Fragmentçš„åŠŸèƒ½ï¼Œrenderå‡½æ•°ä¸­ç›´æ¥ä½¿ç”¨diffå‡½æ•°ã€‚åœ¨renderå‡½æ•°çš„æœ€åä½¿ç”¨commitRootæ‰§è¡Œç»„ä»¶çš„componentDidMountç”Ÿå‘½å‘¨æœŸã€‚</p>
<h2 id="unmount"><a href="#unmount" class="headerlink" title="unmount"></a>unmount</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">unmount</span>(<span class="params">vnode, ancestorComponent, skipRemove</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">let</span> r;</span><br><span class="line">	<span class="keyword">if</span> (options.unmount) options.unmount(vnode);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (r = vnode.ref) &#123;</span><br><span class="line">		applyRef(r, <span class="literal">null</span>, ancestorComponent);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">let</span> dom;</span><br><span class="line">	<span class="keyword">if</span> (!skipRemove &amp;&amp; vnode._lastDomChild==<span class="literal">null</span>) &#123;</span><br><span class="line">		skipRemove = (dom = vnode._dom)!=<span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	vnode._dom = vnode._lastDomChild = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ((r = vnode._component)!=<span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (r.componentWillUnmount) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				r.componentWillUnmount();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (e) &#123;</span><br><span class="line">				catchErrorInComponent(e, ancestorComponent);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		r.base = r._parentDom = <span class="literal">null</span>;</span><br><span class="line">		<span class="keyword">if</span> (r = r._prevVNode) unmount(r, ancestorComponent, skipRemove);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (r = vnode._children) &#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; r.length; i++) &#123;</span><br><span class="line">			unmount(r[i], ancestorComponent, skipRemove);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (dom!=<span class="literal">null</span>) removeNode(dom);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>unmountå‡½æ•°çš„ä½œç”¨, è§åçŸ¥ä¹‰, ä½œç”¨å°±æ˜¯å¸è½½ç»„ä»¶å’Œåˆ é™¤å¯¹åº”çš„DOMèŠ‚ç‚¹ã€‚</p>
<p>skipRemoveå‚æ•°çš„ä½œç”¨æ˜¯æ ‡è®°å½“å‰èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹æ˜¯å¦è¢«ä»Documentä¸­åˆ é™¤ã€‚å¦‚æœå½“å‰èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹å·²ç»è¢«åˆ é™¤ï¼Œé‚£æˆ‘ä»¬æ— é¡»åˆ é™¤å½“å‰èŠ‚ç‚¹ã€‚åªéœ€è¦åˆ¤æ–­å½“å‰çš„èŠ‚ç‚¹æ˜¯å¦ä¸ºç»„ä»¶èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯ç»„ä»¶èŠ‚ç‚¹æ‰§è¡Œç»„ä»¶çš„componentWillUnmountç”Ÿå‘½å‘¨æœŸå³å¯ã€‚</p>
<h2 id="commitRoot"><a href="#commitRoot" class="headerlink" title="commitRoot"></a>commitRoot</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">commitRoot</span>(<span class="params">mounts, root</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">let</span> c;</span><br><span class="line">	<span class="keyword">while</span> ((c = mounts.pop())) &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			c.componentDidMount();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (e) &#123;</span><br><span class="line">			catchErrorInComponent(e, c._ancestorComponent);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (options.commit) options.commit(root);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>commitRootæ–¹æ³•å¾ˆç®€å•, å°±æ˜¯åœ¨ç»„ä»¶æ¸²æŸ“å®Œæˆåæ‰§è¡Œç»„ä»¶çš„componentDidMountç”Ÿå‘½å‘¨æœŸã€‚å…¶ä¸­mountsä¸­è£…è½½äº†æ‰€æœ‰ç¬¬ä¸€æ¬¡æ¸²æŸ“çš„ç»„ä»¶ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> (isNew) &#123;</span><br><span class="line">	<span class="keyword">if</span> (newType.getDerivedStateFromProps==<span class="literal">null</span> &amp;&amp; c.componentWillMount!=<span class="literal">null</span>) &#123;</span><br><span class="line">    c.componentWillMount()</span><br><span class="line">  &#125;</span><br><span class="line">	<span class="keyword">if</span> (c.componentDidMount!=<span class="literal">null</span>) &#123;</span><br><span class="line">    mounts.push(c)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨diffæ–¹æ³•ä¸­ä¼šåˆ¤æ–­æ˜¯å¦ä¸ºç¬¬ä¸€æ¬¡æ¸²æŸ“, å’Œç»„ä»¶å®ä¾‹æ˜¯å¦åŒ…å«componentWillMountç”Ÿå‘½å‘¨æœŸ, å¦‚æœæ»¡è¶³æ¡ä»¶å°±ä¼šå°†å®ä¾‹pushåˆ°mountsçš„é˜Ÿåˆ—ä¸­ã€‚</p>
<h2 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h2><p>åˆ°è¿™é‡Œæˆ‘ä»¬å·²ç»å§preactçš„æºç å¤§è‡´æµè§ˆäº†ä¸€éã€‚æˆ‘ä»¬æ¥ä¸‹æ¥å¯ä»¥å‚è€ƒpreactçš„æºç ï¼Œå®ç°è‡ªå·±çš„reactã€‚è¯è¯´æˆ‘è¿˜ç»™preactçš„é¡¹ç›®æäº¤äº†prğŸ˜Šï¼Œä¸è¿‡è¿˜æ²¡æœ‰mergeğŸ˜¢ã€‚</p>
<h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><p><a href="https://github.com/BengBu-YueZhang/very-simple-react" target="_blank" rel="noopener">very-simple-react</a>ã€‚æºç ä¸»è¦æ˜¯æˆ‘åœ¨å­¦ä¹ preactçš„æºç å, å‚è€ƒ(æŠ„ğŸ¤¦â€)preactæºç å®ç°çš„ã€‚å¦‚æœè¯´preactæ˜¯reactçš„ç²¾ç®€çš„å®ç°ï¼Œé‚£æˆ‘è¿™ä¸ªå°±æ˜¯preactç²¾ç®€å®ç°ã€‚è™½ç„¶ä¸èƒ½ç”¨äºç”Ÿäº§ç¯å¢ƒï¼Œä½†æ˜¯å¯¹äºå­¦ä¹ äº†è§£reactåŸç†è¿˜æ˜¯æœ‰ä¸€å®šå¸®åŠ©çš„ã€‚ä»£ç å®ç°äº†JSXï¼Œç»„ä»¶ï¼Œç”Ÿå‘½å‘¨æœŸï¼Œdiffï¼ŒsetStateç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/React/" rel="tag"># React</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/04/03/å­¦ä¼šæ­£åˆ™çœ‹æ‡‚ç«æ˜Ÿæ–‡3/" rel="next" title="å­¦ä¼šæ­£åˆ™, çœ‹æ‡‚ç«æ˜Ÿæ–‡(ä¸‰)">
                <i class="fa fa-chevron-left"></i> å­¦ä¼šæ­£åˆ™, çœ‹æ‡‚ç«æ˜Ÿæ–‡(ä¸‰)
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/04/14/vuerouter/" rel="prev" title="VueRouteræºç åˆ†æ">
                VueRouteræºç åˆ†æ <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            ä½œè€…æ¦‚è¿°
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpeg"
                alt="å¼ è¶Š" />
            
              <p class="site-author-name" itemprop="name">å¼ è¶Š</p>
              <p class="site-description motion-element" itemprop="description">æ‰€è°“æˆé•¿ï¼Œå°±æ˜¯ç»è¿‡ä¸æ–­çš„èšæ•£ç¦»åˆï¼Œæ‰¾åˆ°ä¸å¤ªä¼šä¼¤å®³åˆ°å½¼æ­¤çš„è·ç¦»</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">75</span>
                  <span class="site-state-item-name">ç¯‡æ–‡ç« </span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">33</span>
                  <span class="site-state-item-name">Tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/BengBu-YueZhang" target="_blank" title="æˆ‘çš„GitHub">
                      
                        <i class="fa fa-fw fa-globe"></i>æˆ‘çš„GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://weibo.com/5460100952/profile?topnav=1&wvr=6" target="_blank" title="æˆ‘çš„å¾®åš">
                      
                        <i class="fa fa-fw fa-globe"></i>æˆ‘çš„å¾®åš</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#å‰è¨€"><span class="nav-number">1.</span> <span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#preactæ˜¯ä»€ä¹ˆ"><span class="nav-number">2.</span> <span class="nav-text">preactæ˜¯ä»€ä¹ˆ?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#è™šæ‹ŸDOM"><span class="nav-number">3.</span> <span class="nav-text">è™šæ‹ŸDOM</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#å…³äºjsx"><span class="nav-number">3.1.</span> <span class="nav-text">å…³äºjsx</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#createElement"><span class="nav-number">3.2.</span> <span class="nav-text">createElement</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ç»„ä»¶"><span class="nav-number">4.</span> <span class="nav-text">ç»„ä»¶</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#diffç®—æ³•"><span class="nav-number">5.</span> <span class="nav-text">diffç®—æ³•</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#å¯¹æ¯”æ–‡æœ¬èŠ‚ç‚¹"><span class="nav-number">5.1.</span> <span class="nav-text">å¯¹æ¯”æ–‡æœ¬èŠ‚ç‚¹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å¯¹æ¯”éæ–‡æœ¬DOMèŠ‚ç‚¹"><span class="nav-number">5.2.</span> <span class="nav-text">å¯¹æ¯”éæ–‡æœ¬DOMèŠ‚ç‚¹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å¯¹æ¯”ç»„ä»¶"><span class="nav-number">5.3.</span> <span class="nav-text">å¯¹æ¯”ç»„ä»¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å¯¹æ¯”å­èŠ‚ç‚¹"><span class="nav-number">5.4.</span> <span class="nav-text">å¯¹æ¯”å­èŠ‚ç‚¹</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å¼‚æ­¥setState"><span class="nav-number">6.</span> <span class="nav-text">å¼‚æ­¥setState</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#render"><span class="nav-number">7.</span> <span class="nav-text">render</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#unmount"><span class="nav-number">8.</span> <span class="nav-text">unmount</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#commitRoot"><span class="nav-number">9.</span> <span class="nav-text">commitRoot</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ç»“è¯­"><span class="nav-number">10.</span> <span class="nav-text">ç»“è¯­</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å…¶ä»–"><span class="nav-number">11.</span> <span class="nav-text">å…¶ä»–</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">å¼ è¶Š</span>

  
</div>


  <div class="powered-by">Erstellt mit  <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
