<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="vue," />










<meta name="keywords" content="vue">
<meta property="og:type" content="article">
<meta property="og:title" content="Vue3æºç è§£æï¼šreactivityï¼ˆè¡¥å…¨ä¸­ï¼‰">
<meta property="og:url" content="https://bengbu-yuezhang.github.io/yue.github.io/2019/11/25/vueæºç /index.html">
<meta property="og:site_name" content="æ–°ä¸–ç´€ã‚¨ãƒ´ã‚¡ãƒ³ã‚²ãƒªã‚ªãƒ³">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://unsplash.it/1169/612?random">
<meta property="og:image" content="https://i.loli.net/2019/11/11/LoeQqi13BP7HjnW.png">
<meta property="og:updated_time" content="2019-12-08T07:57:54.633Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Vue3æºç è§£æï¼šreactivityï¼ˆè¡¥å…¨ä¸­ï¼‰">
<meta name="twitter:image" content="https://unsplash.it/1169/612?random">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://bengbu-yuezhang.github.io/yue.github.io/2019/11/25/vueæºç /"/>





  <title>Vue3æºç è§£æï¼šreactivityï¼ˆè¡¥å…¨ä¸­ï¼‰ | æ–°ä¸–ç´€ã‚¨ãƒ´ã‚¡ãƒ³ã‚²ãƒªã‚ªãƒ³</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">æ–°ä¸–ç´€ã‚¨ãƒ´ã‚¡ãƒ³ã‚²ãƒªã‚ªãƒ³</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">å‰ç«¯å°å­¦ç”Ÿ</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            ä¸»é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            æ ‡ç­¾
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            æ—¶é—´è½´
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://bengbu-yuezhang.github.io/yue.github.io/2019/11/25/vueæºç /">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="å¼ è¶Š">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ–°ä¸–ç´€ã‚¨ãƒ´ã‚¡ãƒ³ã‚²ãƒªã‚ªãƒ³">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Vue3æºç è§£æï¼šreactivityï¼ˆè¡¥å…¨ä¸­ï¼‰</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘å¸ƒäº</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-11-25T00:30:00+08:00">
                2019-11-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><img src="https://unsplash.it/1169/612?random" alt="image"></p>
<a id="more"></a>
<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ¬æ–‡æ˜¯æœ¬äººçš„ä¸€äº›æ‹™è§ï¼Œå¦‚æœ‰é”™è¯¯è¯·è§‚ä¼—è€çˆ·ä»¬æŒ‡å‡ºã€‚</p>
<h2 id="æ¦‚è§ˆ"><a href="#æ¦‚è§ˆ" class="headerlink" title="æ¦‚è§ˆ"></a>æ¦‚è§ˆ</h2><p>ReactivityåŒ…å«äº†Vue3æ•´ä¸ªæ•°æ®å“åº”ç³»ç»Ÿï¼ŒReactivityç›®å½•ç»“æ„ï¼š</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># ğŸ“ reactivity</span><br><span class="line"># |â€”â€”  ğŸ“ __tests__ // åŒ…å«æ‰€æœ‰çš„å•å…ƒæµ‹è¯•æ–‡ä»¶</span><br><span class="line"># |â€”â€”  ğŸ“ src</span><br><span class="line"># |â€”â€”  |â€”â€”  ğŸ“ƒ baseHandlers.ts  // åŒ…å«äº†ï¼Œé’ˆå¯¹å¸¸è§„çš„æ•°æ®ç±»å‹ï¼ŒProxyä»£ç†ä½¿ç”¨çš„å¤„ç†å‡½æ•°ï¼ˆä¾‹å¦‚ï¼šgetã€setã€hasã€ownKeysï¼‰</span><br><span class="line"># |â€”â€”  |â€”â€”  ğŸ“ƒ collectionHandlers.ts  // åŒ…å«äº†ï¼Œé’ˆå¯¹ç‰¹æ®Šçš„æ•°æ®ç±»å‹ï¼ˆSet, Map, WeakMap, WeakSetï¼‰ï¼ŒProxyä»£ç†ä½¿ç”¨çš„å¤„ç†å‡½æ•°</span><br><span class="line"># |â€”â€”  |â€”â€”  ğŸ“ƒ computed.ts // åŒ…å«äº†è®¡ç®—å±æ€§ç›¸å…³å†…å®¹</span><br><span class="line"># |â€”â€”  |â€”â€”  ğŸ“ƒ effect.ts // åŒ…å«äº†effectåˆ›å»ºå‡½æ•°ï¼Œä¾èµ–æ”¶é›†å‡½æ•°ï¼ˆtrackï¼‰ï¼Œè§¦å‘ç›‘å¬å‡½æ•°ï¼ˆtriggerï¼‰ç­‰</span><br><span class="line"># |â€”â€”  |â€”â€”  ğŸ“ƒ reactive.ts // reactiveä¼šå°†å¯¹è±¡åŒ…è£…ä¸ºå“åº”å¼å¯¹è±¡</span><br><span class="line"># |â€”â€”  |â€”â€”  ğŸ“ƒ ref.ts // refä¼šå°†åŸºæœ¬ç±»å‹åŒ…è£…ä¸ºå“åº”å¼æ•°æ®</span><br><span class="line"># |â€”â€”  |â€”â€”  ğŸ“ƒ lock.ts</span><br><span class="line"># |â€”â€”  |â€”â€”  ğŸ“ƒ operations.ts // æ“ä½œæ•°æ®è¡Œä¸ºæšä¸¾ï¼Œsetã€addã€deleteã€getã€hasç­‰</span><br><span class="line"># |â€”â€”  |â€”â€”  ğŸ“ƒ index.ts // å…¥å£æ–‡ä»¶</span><br></pre></td></tr></table></figure>
<h2 id="ğŸ‘»reactive-ts"><a href="#ğŸ‘»reactive-ts" class="headerlink" title="ğŸ‘»reactive.ts"></a>ğŸ‘»reactive.ts</h2><p>reactive.tsæ–‡ä»¶ä¸­ï¼Œä¸»è¦å®šä¹‰äº†ä¸¤ä¸ªä¸»è¦çš„APIï¼Œ<code>reactive</code>å’Œ<code>readonly</code>ã€‚å…³äºè¿™ä¸¤ä¸ªçš„ä½¿ç”¨æ–¹æ³•ï¼Œä»¥åŠä½¿ç”¨æ•ˆæœã€‚å¤§å®¶å¯ä»¥å‚è€ƒï¼Œ<code>__tests__</code>ç›®å½•ä¸‹çš„å•å…ƒæµ‹è¯•æ–‡ä»¶ï¼Œ<code>readonly.spec.ts</code>å’Œ<code>reactive.spec.ts</code>æ–‡ä»¶ã€‚ä¸‹é¢æˆ‘ç®€ç•¥çš„ä»‹ç»ä»¥ä¸‹ï¼Œè¿™ä¸¤ä¸ªAPIã€‚</p>
<p>reactiveä¼šå°†æ•°æ®åŒ…è£…æˆå“åº”å¼æ•°æ®ã€‚å¦‚æœåœ¨<code>effect</code>ï¼ˆåæ–‡ä¼šä»‹ç»ï¼Œ<code>watch</code>å’Œ<code>computed</code>éƒ½æ˜¯åŸºäº<code>effect</code>å®ç°çš„ï¼‰ä¸­ä½¿ç”¨äº†å“åº”å¼æ•°æ®ã€‚æ¯”å¦‚ä½¿ç”¨å¯¹è±¡ä¸Šçš„æŸä¸ªå±æ€§ï¼Œè¿™ç§ä¾èµ–ä¼šè¢«æ”¶é›†èµ·æ¥ï¼Œå½“å“åº”å¼æ•°æ®çš„å±æ€§å€¼å‘ç”Ÿäº†å˜åŒ–ï¼Œå†…éƒ¨ä½¿ç”¨åˆ°å“åº”å¼æ•°æ®çš„<code>effect</code>ä¼šé‡æ–°æ‰§è¡Œã€‚ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œä»£ç å¦‚ä¸‹ã€‚</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> dummy = <span class="literal">null</span></span><br><span class="line"><span class="keyword">const</span> original = &#123; foo: <span class="number">1</span> &#125;</span><br><span class="line"><span class="keyword">const</span> observed = reactive(original)</span><br><span class="line"></span><br><span class="line">effect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// å‘ç”Ÿäº†ä¾èµ–æ”¶é›†</span></span><br><span class="line">  dummy = observed.foo</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// dummy: 1</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`dummy:<span class="subst">$&#123;dummy&#125;</span>`</span>)</span><br><span class="line">observed.foo = <span class="number">2</span></span><br><span class="line"><span class="comment">// dummy: 2</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`dummy:<span class="subst">$&#123;dummy&#125;</span>`</span>)</span><br></pre></td></tr></table></figure>
<h3 id="reactive-tsæºç åˆ†æ"><a href="#reactive-tsæºç åˆ†æ" class="headerlink" title="reactive.tsæºç åˆ†æ"></a>reactive.tsæºç åˆ†æ</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Depç±»å‹ï¼Œæ˜¯ReactiveEffectç±»å‹çš„é›†åˆ</span></span><br><span class="line"><span class="comment">// ReactiveEffectç±»å‹æ˜¯ç›‘å¬å‡½æ•°çš„æ¥å£ï¼Œä¼šåœ¨effect.tsæ–‡ä»¶ä¸­ä»‹ç»åˆ°</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> Dep = Set&lt;ReactiveEffect&gt;</span><br><span class="line"><span class="comment">// KeyToDepMapç±»å‹ï¼Œæ˜¯keyä¸Depé›†åˆçš„æ˜ å°„</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> KeyToDepMap = Map&lt;<span class="built_in">any</span>, Dep&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// targetMap&lt;any, KeyToDepMap&lt;any, Dep[]&gt;&gt;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> targetMap = <span class="keyword">new</span> WeakMap&lt;<span class="built_in">any</span>, KeyToDepMap&gt;()</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>reactive.ts</code>æ–‡ä»¶çš„å¼€å¤´ï¼Œå®šä¹‰äº†å¸¸é‡<code>targetMap</code>ã€‚<code>targetMap</code>æ˜¯æ•´ä¸ªå“åº”å¼ç³»ç»Ÿçš„å…³é”®ï¼Œ<code>targetMap</code>ä¸­åŒ…å«äº†å“åº”å¼ç³»ç»Ÿä¸­æ‰€æœ‰çš„ä¾èµ–å…³ç³»ï¼ˆå…·ä½“ç»†èŠ‚è§<code>effect.ts</code>æ–‡ä»¶çš„åˆ†æï¼‰ã€‚</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WeakMap&lt;åŸå¯¹è±¡ï¼Œå“åº”å¼å¯¹è±¡&gt;ä¹‹é—´çš„æ˜ å°„</span></span><br><span class="line"><span class="keyword">const</span> rawToReactive = <span class="keyword">new</span> WeakMap&lt;<span class="built_in">any</span>, <span class="built_in">any</span>&gt;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// WeakMap&lt;å“åº”å¼å¯¹è±¡ï¼ŒåŸå¯¹è±¡&gt;ä¹‹é—´çš„æ˜ å°„</span></span><br><span class="line"><span class="keyword">const</span> reactiveToRaw = <span class="keyword">new</span> WeakMap&lt;<span class="built_in">any</span>, <span class="built_in">any</span>&gt;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> rawToReadonly = <span class="keyword">new</span> WeakMap&lt;<span class="built_in">any</span>, <span class="built_in">any</span>&gt;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> readonlyToRaw = <span class="keyword">new</span> WeakMap&lt;<span class="built_in">any</span>, <span class="built_in">any</span>&gt;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> readonlyValues = <span class="keyword">new</span> WeakSet&lt;<span class="built_in">any</span>&gt;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// éå“åº”å¼å¯¹è±¡çš„é›†åˆï¼ˆä½¿ç”¨çš„æƒ…å†µè¾ƒå°‘ï¼‰</span></span><br><span class="line"><span class="keyword">const</span> nonReactiveValues = <span class="keyword">new</span> WeakSet&lt;<span class="built_in">any</span>&gt;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨Proxyä»£ç†æ—¶ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†çš„ç±»å‹é›†åˆ</span></span><br><span class="line"><span class="keyword">const</span> collectionTypes = <span class="keyword">new</span> Set&lt;<span class="built_in">Function</span>&gt;([Set, Map, WeakMap, WeakSet])</span><br><span class="line"></span><br><span class="line"><span class="comment">// isObservableTypeæ˜¯ä¸€ä¸ªå‡½æ•°</span></span><br><span class="line"><span class="comment">// å¦‚æœå‚æ•°ä¸æ˜¯'Object'ã€'Array'ã€'Map'ã€'Set'ã€'WeakMap'ã€WeakSetçš„å­—ç¬¦ä¸²å°†ä¼šè¿”å›false</span></span><br><span class="line"><span class="keyword">const</span> isObservableType = <span class="comment">/*#__PURE__*/</span> makeMap(</span><br><span class="line">  <span class="string">'Object,Array,Map,Set,WeakMap,WeakSet'</span></span><br><span class="line">)</span><br><span class="line"><span class="comment">// canObserveå‡½æ•°ç”¨æ¥åˆ¤æ–­å¯¹è±¡æ˜¯å¦å¯ä»¥è¢«è§‚å¯Ÿ</span></span><br><span class="line"><span class="keyword">const</span> canObserve = (value: <span class="built_in">any</span>): <span class="function"><span class="params">boolean</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯Vueå®ä¾‹ä¸å¯ä»¥è¢«è§‚å¯Ÿ</span></span><br><span class="line">    !value._isVue &amp;&amp;</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯è™šæ‹ŸVNodeä¸å¯ä»¥è¢«è§‚å¯Ÿ</span></span><br><span class="line">    !value._isVNode &amp;&amp;</span><br><span class="line">    <span class="comment">// å¦‚æœå¯¹è±¡ç±»å‹ä¸å±äºObjectã€Arrayã€Mapã€Setã€WeakMapã€WeakSetï¼Œä¸å¯ä»¥è¢«è§‚å¯Ÿ</span></span><br><span class="line">    <span class="comment">// toRawTypeæ˜¯ä¸€ä¸ªå·¥å…·å‡½æ•°ï¼Œä¼šè¿”å›valueçš„ç±»å‹å­—ç¬¦ä¸²ã€‚æ¯”å¦‚ï¼Œå¦‚æœvalueæ˜¯ä¸€ä¸ªæ•°ç»„ï¼ŒtoRawTypeä¼šè¿”å›å­—ç¬¦ä¸²'Array'</span></span><br><span class="line">    isObservableType(toRawType(value)) &amp;&amp;</span><br><span class="line">    <span class="comment">// å¦‚æœå¯¹è±¡åœ¨nonReactiveValuesé›†åˆä¸­ï¼Œä¸å¯ä»¥è¢«è§‚å¯Ÿ</span></span><br><span class="line">    !nonReactiveValues.has(value)</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> UnwrapNestedRefs&lt;T&gt; = T <span class="keyword">extends</span> Ref ? T : UnwrapRef&lt;T&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">reactive</span>&lt;<span class="title">T</span> <span class="title">extends</span> <span class="title">object</span>&gt;(<span class="params">target: T</span>): <span class="title">UnwrapNestedRefs</span>&lt;<span class="title">T</span>&gt;</span></span><br><span class="line"><span class="function"><span class="title">export</span> <span class="function"><span class="keyword">function</span> <span class="title">reactive</span>(<span class="params">target: object</span>) </span>&#123;</span></span><br><span class="line"><span class="function">  // <span class="title">if</span> <span class="title">trying</span> <span class="title">to</span> <span class="title">observe</span> <span class="title">a</span> <span class="title">readonly</span> <span class="title">proxy</span>, <span class="title">return</span> <span class="title">the</span> <span class="title">readonly</span> <span class="title">version</span>.</span></span><br><span class="line">  if (readonlyToRaw.has(target)) &#123;</span><br><span class="line">    <span class="keyword">return</span> target</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// target is explicitly marked as readonly by user</span></span><br><span class="line">  <span class="keyword">if</span> (readonlyValues.has(target)) &#123;</span><br><span class="line">    <span class="keyword">return</span> readonly(target)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// è°ƒç”¨createReactiveObjectï¼Œåˆ›å»ºå“åº”å¼å¯¹è±¡</span></span><br><span class="line">  <span class="keyword">return</span> createReactiveObject(</span><br><span class="line">    target, <span class="comment">// åŸå¯¹è±¡</span></span><br><span class="line">    rawToReactive, <span class="comment">// &lt;åŸå¯¹è±¡ï¼Œå“åº”å¼å¯¹è±¡&gt;çš„æ˜ å°„</span></span><br><span class="line">    reactiveToRaw, <span class="comment">// &lt;å“åº”å¼å¯¹è±¡ï¼ŒåŸå¯¹è±¡&gt;çš„æ˜ å°„</span></span><br><span class="line">    mutableHandlers, <span class="comment">// æ™®é€šå¯¹è±¡ï¼Œè¿›è¡ŒProxyä»£ç†çš„handle</span></span><br><span class="line">    mutableCollectionHandlers <span class="comment">// Set, Map, WeakMap, WeakSetç±»å‹ï¼Œè¿›è¡ŒProxyä»£ç†çš„handle</span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createReactiveObject</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  target: unknown,</span></span></span><br><span class="line"><span class="function"><span class="params">  toProxy: WeakMap&lt;<span class="built_in">any</span>, <span class="built_in">any</span>&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  toRaw: WeakMap&lt;<span class="built_in">any</span>, <span class="built_in">any</span>&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  baseHandlers: ProxyHandler&lt;<span class="built_in">any</span>&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  collectionHandlers: ProxyHandler&lt;<span class="built_in">any</span>&gt;</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœtargetä¸æ˜¯ä¸€ä¸ªå¯¹è±¡ç±»å‹ã€‚åœ¨å¼€å‘ç¯å¢ƒæ—¶ï¼Œä¼šå‘å‡ºè­¦å‘Šã€‚å¹¶è¿”å›åŸtarget</span></span><br><span class="line">  <span class="keyword">if</span> (!isObject(target)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="built_in">console</span>.warn(<span class="string">`value cannot be made reactive: <span class="subst">$&#123;String(target)&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> target</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åœ¨rawToReactiveä¸­æŸ¥æ‰¾ï¼Œå¦‚æœtargetå·²ç»è¢«ä»£ç†ï¼Œç›´æ¥è¿”å›å“åº”å¼å¯¹è±¡</span></span><br><span class="line">  <span class="keyword">let</span> observed = toProxy.get(target)</span><br><span class="line">  <span class="keyword">if</span> (observed !== <span class="built_in">void</span> <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> observed</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åœ¨reactiveToRawä¸­æŸ¥æ‰¾ï¼Œå¦‚æœtargetæœ¬èº«å°±æ˜¯å“åº”å¼å¯¹è±¡ï¼Œç›´æ¥è¿”å›target</span></span><br><span class="line">  <span class="keyword">if</span> (toRaw.has(target)) &#123;</span><br><span class="line">    <span class="keyword">return</span> target</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å¦‚æœtargetä¸å¯è¢«è§‚å¯Ÿï¼Œç›´æ¥è¿”å›target</span></span><br><span class="line">  <span class="keyword">if</span> (!canObserve(target)) &#123;</span><br><span class="line">    <span class="keyword">return</span> target</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// collectionTypes.hasåˆ¤æ–­targetæ˜¯å¦æ˜¯Set, Map, WeakMap, WeakSetä¸­çš„ç±»å‹ä¹‹ä¸€</span></span><br><span class="line">  <span class="comment">// å¦‚æœæ˜¯ï¼Œhandlersç­‰äºmutableCollectionHandlers</span></span><br><span class="line">  <span class="comment">// å¦‚æœä¸æ˜¯ï¼Œhandlersç­‰äºmutableHandlers</span></span><br><span class="line">  <span class="keyword">const</span> handlers = collectionTypes.has(target.constructor)</span><br><span class="line">    ? collectionHandlers</span><br><span class="line">    : baseHandlers</span><br><span class="line">  <span class="comment">// ä½¿ç”¨Proxyå¯¹targetè¿›è¡Œä»£ç†</span></span><br><span class="line">  observed = <span class="keyword">new</span> Proxy(target, handlers)</span><br><span class="line">  <span class="comment">// åœ¨rawToReactiveå’ŒreactiveToRawä¸­æ·»åŠ æ˜ å°„å…³ç³»</span></span><br><span class="line">  toProxy.set(target, observed)</span><br><span class="line">  toRaw.set(observed, target)</span><br><span class="line">  <span class="comment">// åœ¨targetMapä¸­æ·»åŠ æ˜ å°„å…³ç³»</span></span><br><span class="line">  <span class="keyword">if</span> (!targetMap.has(target)) &#123;</span><br><span class="line">    targetMap.set(target, <span class="keyword">new</span> Map())</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> observed</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æ˜¯ä¸€äº›å·¥å…·å‡½æ•°çš„å…·ä½“å®ç°</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ¤æ–­æ˜¯å¦æ˜¯å“åº”å¼å¯¹è±¡</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isReactive</span>(<span class="params">value: unknown</span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> reactiveToRaw.has(value) || readonlyToRaw.has(value)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ¤æ–­æ˜¯å¦æ˜¯åªè¯»å“åº”å¼å¯¹è±¡</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isReadonly</span>(<span class="params">value: unknown</span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> readonlyToRaw.has(value)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœæ•°æ®æ˜¯å“åº”å¼å¯¹è±¡ï¼Œè½¬æ¢ä¸ºåŸæ•°æ®</span></span><br><span class="line"><span class="comment">// å¦‚æœä¸æ˜¯ï¼Œç›´æ¥è¿”å›åŸæ•°æ®</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">toRaw</span>&lt;<span class="title">T</span>&gt;(<span class="params">observed: T</span>): <span class="title">T</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> reactiveToRaw.get(observed) || readonlyToRaw.get(observed) || observed</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†valueæ ‡è®°ä¸ºåªè¯»å“åº”å¼å¯¹è±¡</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">markReadonly</span>&lt;<span class="title">T</span>&gt;(<span class="params">value: T</span>): <span class="title">T</span> </span>&#123;</span><br><span class="line">  readonlyValues.add(value)</span><br><span class="line">  <span class="keyword">return</span> value</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†valueæ ‡è®°ä¸ºéå“åº”å¼å¯¹è±¡ï¼ˆç”¨å¤„ä¸å¤§ï¼‰</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">markNonReactive</span>&lt;<span class="title">T</span>&gt;(<span class="params">value: T</span>): <span class="title">T</span> </span>&#123;</span><br><span class="line">  nonReactiveValues.add(value)</span><br><span class="line">  <span class="keyword">return</span> value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ğŸ‘»ä¸ºä»€ä¹ˆä½¿ç”¨WeakMapå­˜å‚¨æ˜ å°„å…³ç³»ï¼Œè€Œä¸æ˜¯ä½¿ç”¨Mapï¼Ÿ"><a href="#ğŸ‘»ä¸ºä»€ä¹ˆä½¿ç”¨WeakMapå­˜å‚¨æ˜ å°„å…³ç³»ï¼Œè€Œä¸æ˜¯ä½¿ç”¨Mapï¼Ÿ" class="headerlink" title="ğŸ‘»ä¸ºä»€ä¹ˆä½¿ç”¨WeakMapå­˜å‚¨æ˜ å°„å…³ç³»ï¼Œè€Œä¸æ˜¯ä½¿ç”¨Mapï¼Ÿ"></a>ğŸ‘»ä¸ºä»€ä¹ˆä½¿ç”¨WeakMapå­˜å‚¨æ˜ å°„å…³ç³»ï¼Œè€Œä¸æ˜¯ä½¿ç”¨Mapï¼Ÿ</h4><h2 id="ğŸ‘»baseHandlers-ts"><a href="#ğŸ‘»baseHandlers-ts" class="headerlink" title="ğŸ‘»baseHandlers.ts"></a>ğŸ‘»baseHandlers.ts</h2><p>baseHandlers.tsä¸­åŒ…å«äº†ä¸¤å¥—Proxyçš„handleï¼Œ<code>mutableHandlers</code>å’Œ<code>readonlyHandlers</code>ã€‚<code>mutableHandlers</code>å¤„ç†æ™®é€šçš„å“åº”å¼å¯¹è±¡ï¼Œ<code>readonlyHandlers</code>å¤„ç†åªè¯»å“åº”å¼å¯¹è±¡ã€‚</p>
<h3 id="ğŸ‘»baseHandlers-tsæºç åˆ†æ"><a href="#ğŸ‘»baseHandlers-tsæºç åˆ†æ" class="headerlink" title="ğŸ‘»baseHandlers.tsæºç åˆ†æ"></a>ğŸ‘»baseHandlers.tsæºç åˆ†æ</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> mutableHandlers: ProxyHandler&lt;object&gt; = &#123;</span><br><span class="line">  <span class="keyword">get</span>: createGetter(<span class="literal">false</span>),</span><br><span class="line">  <span class="keyword">set</span>,</span><br><span class="line">  deleteProperty,</span><br><span class="line">  has,</span><br><span class="line">  ownKeys</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="get"><a href="#get" class="headerlink" title="get"></a>get</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// isReadonlyæ˜¯å¦æ˜¯åªè¯»çš„åŠ«æŒ</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createGetter</span>(<span class="params">isReadonly: <span class="built_in">boolean</span>, unwrap: <span class="built_in">boolean</span> = <span class="literal">true</span></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// target åŸå¯¹è±¡</span></span><br><span class="line">  <span class="comment">// key å±æ€§å</span></span><br><span class="line">  <span class="comment">// receiver proxyçš„å®ä¾‹</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params">target: object, key: <span class="built_in">string</span> | symbol, receiver: object</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨Reflect.getè·å–åŸå±æ€§å€¼</span></span><br><span class="line">    <span class="keyword">let</span> res = Reflect.get(target, key, receiver)</span><br><span class="line">    <span class="comment">// å¯¹äºtargetä¸Šï¼Œå†…ç½®çš„Symbolç±»å‹çš„keyï¼Œæ¯”å¦‚Symbol.iteratorï¼Œä¸è¿›è¡Œæ”¶é›†ä¾èµ–</span></span><br><span class="line">    <span class="keyword">if</span> (isSymbol(key) &amp;&amp; builtInSymbols.has(key)) &#123;</span><br><span class="line">      <span class="keyword">return</span> res</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœresæ˜¯Refå¯¹è±¡</span></span><br><span class="line">    <span class="comment">// resçš„valueå±æ€§çš„getteræ“ä½œï¼ŒåŒ…å«äº†æ”¶é›†ä¾èµ–çš„æ“ä½œï¼ˆè§åæ–‡ï¼‰ã€‚æ‰€ä»¥æˆ‘ä»¬æ— éœ€ä½¿ç”¨tracké‡å¤æ”¶é›†ä¾èµ–</span></span><br><span class="line">    <span class="keyword">if</span> (unwrap &amp;&amp; isRef(res)) &#123;</span><br><span class="line">      <span class="comment">// åŒæ—¶è¿™é‡Œä¼šè‡ªåŠ¨è§£å¼€refçš„åŒ…è£…ã€‚å¯ä»¥ä½¿ç”¨æˆ·æ— éœ€ä½¿ç”¨`target.key.value`è¿›è¡Œå–å€¼</span></span><br><span class="line">      <span class="comment">// ä¸¾ä¸€ä¸ªä¾‹å­</span></span><br><span class="line">      <span class="comment">// const a = ref(1)</span></span><br><span class="line">      <span class="comment">// const obj = reactive(&#123; a &#125;)</span></span><br><span class="line">      <span class="comment">// const temp = obj.a // ä¸éœ€è¦ä½¿ç”¨obj.a.value</span></span><br><span class="line">      res = res.value</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// ä½¿ç”¨trackæ”¶é›†ä¾èµ–ï¼Œtrackå…·ä½“å®ç°çš„ç»†èŠ‚è§ä¸‹æ–‡</span></span><br><span class="line">      track(target, OperationTypes.GET, key)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœresæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œé€’å½’çš„è¿›è¡Œä»£ç†ã€‚å› ä¸ºProxyåœ¨åˆå§‹åŒ–æ—¶åªä¼šå¯¹ç¬¬ä¸€å±‚çš„å±æ€§è¿›è¡Œä»£ç†</span></span><br><span class="line">    <span class="comment">// Vue3å¯¹äºåµŒå¥—å¯¹è±¡çš„ä»£ç†è¡Œä¸ºæ˜¯æ‡’æƒ°çš„ï¼Œåªæœ‰å½“ä½¿ç”¨åˆ°ï¼ˆgetï¼‰æ—¶ï¼Œæ‰ä¼šè¿›è¡Œä»£ç†åŠ«æŒ </span></span><br><span class="line">    <span class="comment">// è¿™æ ·åšåŒæ—¶å¯ä»¥é¿å…å¾ªç¯å¼•ç”¨ã€‚</span></span><br><span class="line">    <span class="comment">// ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œå½“ä½¿ç”¨a.b.cæ—¶ï¼Œreactive(a.b.c)ï¼Œreactiveçš„å†…éƒ¨ä¼šé€šè¿‡toProxy.get(target)åˆ¤æ–­</span></span><br><span class="line">    <span class="comment">// aå·²ç»è¢«ä»£ç†äº†ï¼Œç›´æ¥è¿”å›ä»£ç†å¯¹è±¡ä¸‹ã€‚é¿å…äº†è°ƒç”¨æ ˆæº¢å‡º</span></span><br><span class="line">    <span class="comment">// const a = &#123;</span></span><br><span class="line">    <span class="comment">//   b: &#123;</span></span><br><span class="line">    <span class="comment">//     c: a</span></span><br><span class="line">    <span class="comment">//   &#125;  </span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="keyword">return</span> isObject(res)</span><br><span class="line">      ? isReadonly</span><br><span class="line">        ? readonly(res) : reactive(res)</span><br><span class="line">      : res</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="ä¸ºä»€ä¹ˆä½¿ç”¨Reflect-getï¼Œè€Œä¸ç›´æ¥ä½¿ç”¨target-key-ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆä½¿ç”¨Reflect-getï¼Œè€Œä¸ç›´æ¥ä½¿ç”¨target-key-ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆä½¿ç”¨Reflect.getï¼Œè€Œä¸ç›´æ¥ä½¿ç”¨target[key]ï¼Ÿ"></a>ä¸ºä»€ä¹ˆä½¿ç”¨Reflect.getï¼Œè€Œä¸ç›´æ¥ä½¿ç”¨target[key]ï¼Ÿ</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> original = &#123;</span><br><span class="line">  bar: <span class="number">2</span>,</span><br><span class="line">  <span class="keyword">get</span> foo () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.bar</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> observed = reactive(original)</span><br><span class="line">observed.foo</span><br><span class="line"><span class="built_in">console</span>.log(num) <span class="comment">// numæ˜¯ä¾èµ–æ”¶é›†æ¬¡æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœgetåŠ«æŒå†…éƒ¨ï¼Œä½¿ç”¨target[key]</span></span><br><span class="line"><span class="comment">// thisæŒ‡å‘targetï¼Œè€Œä¸æ˜¯proxyå¯¹è±¡ï¼Œæ‰€ä»¥ä¼šå°‘è§¦å‘ä¸€æ¬¡ä¾èµ–æ”¶é›†</span></span><br><span class="line">num === <span class="number">1</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœgetåŠ«æŒå†…éƒ¨ï¼Œä½¿ç”¨Reflect.get</span></span><br><span class="line"><span class="comment">// å¦‚æœå±æ€§éƒ¨ç½²äº†è¯»å–å‡½æ•°ï¼ˆgetterï¼‰ï¼Œåˆ™è¯»å–å‡½æ•°çš„thisç»‘å®šproxyï¼Œæ‰€ä»¥ä¼šè§¦å‘ä¸¤æ¬¡ä¾èµ–æ”¶é›†</span></span><br><span class="line">num === <span class="number">2</span></span><br></pre></td></tr></table></figure>
<h4 id="set"><a href="#set" class="headerlink" title="set"></a>set</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  target: object,</span></span></span><br><span class="line"><span class="function"><span class="params">  key: <span class="built_in">string</span> | symbol,</span></span></span><br><span class="line"><span class="function"><span class="params">  value: unknown,</span></span></span><br><span class="line"><span class="function"><span class="params">  receiver: object</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="comment">// æ–°å€¼</span></span><br><span class="line">  value = toRaw(value)</span><br><span class="line">  <span class="comment">// æœªæ›´æ–°å‰çš„æ—§å€¼</span></span><br><span class="line">  <span class="keyword">const</span> oldValue = (target <span class="keyword">as</span> <span class="built_in">any</span>)[key]</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœæ—§å€¼æ˜¯refç±»å‹ï¼Œè€Œæ–°çš„å€¼ä¸æ˜¯refç±»å‹ï¼Œç›´æ¥èµ‹å€¼ç»™oldValue.value</span></span><br><span class="line">  <span class="keyword">if</span> (isRef(oldValue) &amp;&amp; !isRef(value)) &#123;</span><br><span class="line">    <span class="comment">// åœ¨refç±»å‹çš„æ•°æ®setter valueä¸­ï¼Œå·²ç»åŒ…å«äº†triggerï¼Œä¸éœ€è¦é‡å¤è§¦å‘å“åº”ä¾èµ–ï¼Œæ‰€ä»¥ç›´æ¥return</span></span><br><span class="line">    oldValue.value = value</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ¤æ–­targetä¹‹å‰æ˜¯å¦å·²ç»å­˜åœ¨äº†è¯¥key</span></span><br><span class="line">  <span class="comment">// å¦‚æœå­˜åœ¨ï¼Œtriggerè§¦å‘ä¾èµ–å“åº”çš„ç±»å‹æ˜¯OperationTypes.SET</span></span><br><span class="line">  <span class="comment">// å¦‚æœä¸å­˜åœ¨ï¼Œtriggerè§¦å‘ä¾èµ–å“åº”çš„ç±»å‹æ˜¯OperationTypes.ADD</span></span><br><span class="line">  <span class="comment">// ä¸¤è€…çš„åŒºåˆ«æ˜¯ï¼Œå¦‚æœæ˜¯ADDç±»å‹ï¼Œtriggerä¼šé¢å¤–è§¦å‘targetMapä¸­ITERATE_KEYï¼ˆè¿­ä»£å™¨ï¼‰çš„å“åº”</span></span><br><span class="line">  <span class="comment">// å› ä¸ºè¿›è¡Œå¢åˆ å¯¹è±¡çš„å±æ€§çš„æ“ä½œæ—¶ï¼Œä¼šå½±å“åˆ°æ¶‰åŠäº†è¿­ä»£å™¨çš„effect</span></span><br><span class="line">  <span class="comment">// è€ŒSETç±»å‹ä¸ä¼š</span></span><br><span class="line">  <span class="keyword">const</span> hadKey = hasOwn(target, key)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¿®æ”¹targetä¸Šçš„å¯¹åº”çš„å±æ€§å€¼</span></span><br><span class="line">  <span class="keyword">const</span> result = Reflect.set(target, key, value, receiver)</span><br><span class="line">  <span class="comment">// ä¸ºä»€ä¹ˆéœ€è¦åˆ¤æ–­target === toRaw(receiver)ï¼Œè§ä¸‹é¢çš„è¡¥å……è¯´æ˜</span></span><br><span class="line">  <span class="keyword">if</span> (target === toRaw(receiver)) &#123;</span><br><span class="line">    <span class="comment">/* istanbul ignore else */</span></span><br><span class="line">    <span class="comment">// triggerè§¦å‘ä¾èµ–æ›´æ–°ï¼ˆtriggerçš„å…·ä½“å®ç°è§ä¸‹æ–‡ï¼‰ï¼Œå¦‚æœkeyä¹‹å‰å·²ç»å­˜åœ¨æ˜¯SETç±»å‹</span></span><br><span class="line">    <span class="comment">// å¦‚æœä¸å­˜åœ¨æ˜¯ADDç±»å‹</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="keyword">const</span> extraInfo = &#123; oldValue, newValue: value &#125;</span><br><span class="line">      <span class="keyword">if</span> (!hadKey) &#123;</span><br><span class="line">        trigger(target, OperationTypes.ADD, key, extraInfo)</span><br><span class="line">        <span class="comment">// hasChangedä¼šåˆ¤æ–­ï¼Œå¦‚æœvalueå’ŒoldValueå‰åä¸€è‡´ï¼Œä¸ä¼šè§¦å‘ä¾èµ–æ›´æ–°</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hasChanged(value, oldValue)) &#123;</span><br><span class="line">        trigger(target, OperationTypes.SET, key, extraInfo)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!hadKey) &#123;</span><br><span class="line">        trigger(target, OperationTypes.ADD, key)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hasChanged(value, oldValue)) &#123;</span><br><span class="line">        trigger(target, OperationTypes.SET, key)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="ğŸ¤”ï¸target-toRaw-receiver-æ˜¯ä»€ä¹ˆåˆ¤æ–­é€»è¾‘ï¼Ÿ"><a href="#ğŸ¤”ï¸target-toRaw-receiver-æ˜¯ä»€ä¹ˆåˆ¤æ–­é€»è¾‘ï¼Ÿ" class="headerlink" title="ğŸ¤”ï¸target === toRaw(receiver)æ˜¯ä»€ä¹ˆåˆ¤æ–­é€»è¾‘ï¼Ÿ"></a>ğŸ¤”ï¸target === toRaw(receiver)æ˜¯ä»€ä¹ˆåˆ¤æ–­é€»è¾‘ï¼Ÿ</h5><p>ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œä¾‹å­å¦‚ä¸‹ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰å¯¹parentProxyå¯¹è±¡ï¼Œè¿›è¡Œsetæ“ä½œã€‚ä½†æ˜¯ç¡®è§¦å‘äº†parentProxyçš„setã€‚å¦‚æœä¸ä½¿ç”¨<code>target === toRaw(receiver)</code>è¿›è¡Œåˆ¤æ–­targetå’Œreceiveræ˜¯å¦å¯¹åº”çš„ï¼Œä¼šé€ æˆé¢å¤–çš„triggerã€‚</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> childProxy = <span class="keyword">new</span> Proxy(&#123;</span><br><span class="line">  name: <span class="string">'Atreus'</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">  <span class="keyword">set</span>(target, key, value, receiver) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'è§¦å‘Atreusçš„set'</span>, target, receiver)</span><br><span class="line">    <span class="keyword">return</span> Reflect.set(target, key, value, receiver)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> parentProxy = <span class="keyword">new</span> Proxy(&#123;</span><br><span class="line">  name: <span class="string">'Kratos'</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">  <span class="keyword">set</span>(target, key, value, receiver) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'è§¦å‘Kratosçš„set'</span>, target, receiver)</span><br><span class="line">    <span class="keyword">return</span> Reflect.set(target, key, value, receiver)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">Object</span>.setPrototypeOf(childProxy, parentProxy)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è§¦å‘Atreusçš„setï¼Œ&#123;name: "Atreus"&#125;ï¼ŒProxyÂ &#123;name: "Atreus"&#125;</span></span><br><span class="line"><span class="comment">// è§¦å‘Kratosçš„setï¼Œ&#123;name: "Kratos"&#125; ProxyÂ &#123;name: "Atreus"&#125;</span></span><br><span class="line"><span class="comment">// è™½ç„¶è§¦å‘äº†parentProxyçš„setã€‚ä½†æ˜¯targetå’Œreceiverå¹¶ä¸æ˜¯å¯¹åº”çš„</span></span><br><span class="line">childProxy.age = <span class="number">8</span></span><br></pre></td></tr></table></figure>
<h5 id="ğŸ¤”ï¸unshift-shift-pop-pushç­‰çš„å¤„ç†"><a href="#ğŸ¤”ï¸unshift-shift-pop-pushç­‰çš„å¤„ç†" class="headerlink" title="ğŸ¤”ï¸unshift, shift, pop, pushç­‰çš„å¤„ç†"></a>ğŸ¤”ï¸unshift, shift, pop, pushç­‰çš„å¤„ç†</h5><p>ä½¿ç”¨æ•°ç»„çš„å®ä¾‹æ–¹æ³•ï¼Œæ¯”å¦‚<code>shift</code>ä¼šè§¦å‘setåŠ«æŒå—ï¼Ÿä¸¾ä¸€ä¸ªä¾‹å­ï¼Œä»£ç å¦‚ä¸‹</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> original = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"><span class="keyword">const</span> observed = reactive(original)</span><br><span class="line">observed.shift()</span><br><span class="line"><span class="comment">// num == 3ï¼Œè§¦å‘äº†3æ¬¡setåŠ«æŒ</span></span><br><span class="line"><span class="comment">// 3æ¬¡setåŠ«æŒçš„keyï¼Œåˆ†åˆ«æ˜¯0ã€1ã€length</span></span><br><span class="line"><span class="comment">// è¿™æ˜¯å› ä¸ºï¼Œæˆ‘ä»¬åˆ é™¤äº†æ•°ç»„çš„é¦–ä½ã€‚æ•°ç»„å†…éƒ¨éœ€è¦ä¾æ¬¡å°†å†…å®¹å¾€å‰æŒªåŠ¨ä¸€ä½ï¼Œå¹¶ä¸”éœ€è¦ä¿®æ”¹æ•°ç»„çš„length</span></span><br><span class="line"><span class="comment">// ç”±æ­¤ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œæ•°ç»„åœ¨æ’å…¥åˆ é™¤æ“ä½œæ€§èƒ½ä¸Šï¼Œç›¸è¾ƒäºé“¾è¡¨è¾ƒå·®ï¼ˆå› ä¸ºé“¾è¡¨åœ¨æ’å…¥åˆ é™¤æ—¶ï¼Œä¸ä¼šå½±å“å…¶ä»–å…ƒç´ çš„å†…å­˜ä½ç½®ï¼‰</span></span><br><span class="line"><span class="built_in">console</span>.log(num)</span><br></pre></td></tr></table></figure>
<h4 id="deletePropertyã€hasã€ownKeysåŠ«æŒ"><a href="#deletePropertyã€hasã€ownKeysåŠ«æŒ" class="headerlink" title="deletePropertyã€hasã€ownKeysåŠ«æŒ"></a>deletePropertyã€hasã€ownKeysåŠ«æŒ</h4><p>deletePropertyã€hasã€ownKeysåˆ†åˆ«å¯¹åº”ç€ï¼Œ<code>delete obj[key]</code>ã€ <code>key in obj</code>ã€ <code>Object.getOwnPropertyNames() | Object.getOwnPropertySymbols() | Object.keys() | for...in</code>è¡Œä¸ºåŠ«æŒã€‚å®ƒä»¬çš„å†…å®¹ç›¸å¯¹æ¥è¯´æ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥æ”¾åœ¨ä¸€èµ·è¯´ã€‚</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">deleteProperty</span>(<span class="params">target: object, key: <span class="built_in">string</span> | symbol</span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="comment">// åˆ¤æ–­targetæ˜¯å¦å­˜åœ¨å±æ€§key</span></span><br><span class="line">  <span class="keyword">const</span> hadKey = hasOwn(target, key)</span><br><span class="line">  <span class="keyword">const</span> oldValue = (target <span class="keyword">as</span> <span class="built_in">any</span>)[key]</span><br><span class="line">  <span class="comment">// åˆ é™¤targetä¸Šçš„keyå±æ€§</span></span><br><span class="line">  <span class="keyword">const</span> result = Reflect.deleteProperty(target, key)</span><br><span class="line">  <span class="comment">// å¦‚æœåˆ é™¤ä¸å­˜åœ¨çš„å±æ€§ï¼Œæˆ–è€…åˆ é™¤ä¸æˆåŠŸï¼Œä¸ä¼štriggerè§¦å‘ä¾èµ–æ›´æ–°</span></span><br><span class="line">  <span class="keyword">if</span> (result &amp;&amp; hadKey) &#123;</span><br><span class="line">    <span class="comment">/* istanbul ignore else */</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      trigger(target, OperationTypes.DELETE, key, &#123; oldValue &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      trigger(target, OperationTypes.DELETE, key)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">has</span>(<span class="params">target: object, key: <span class="built_in">string</span> | symbol</span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> result = Reflect.has(target, key)</span><br><span class="line">  <span class="comment">// æ”¶é›†ä¾èµ–</span></span><br><span class="line">  track(target, OperationTypes.HAS, key)</span><br><span class="line">  <span class="comment">// è¿”å›inæ“ä½œç¬¦çš„ç»“æœ</span></span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ownKeys</span>(<span class="params">target: object</span>): (<span class="params"><span class="built_in">string</span> | <span class="built_in">number</span> | symbol</span>)[] </span>&#123;</span><br><span class="line">  <span class="comment">// æ”¶é›†ä¾èµ–ï¼Œæ³¨æ„OperationTypes.ITERATEç±»å‹ï¼Œè¿™ä¸ªç±»å‹ä¼šåœ¨æ”¶é›†ä¾èµ–çš„trackå‡½æ•°ä¸­ç‰¹æ®Šå¤„ç†</span></span><br><span class="line">  track(target, OperationTypes.ITERATE)</span><br><span class="line">  <span class="comment">// è¿”å›ç»“æœ</span></span><br><span class="line">  <span class="keyword">return</span> Reflect.ownKeys(target)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ğŸ‘»readonlyHandlers"><a href="#ğŸ‘»readonlyHandlers" class="headerlink" title="ğŸ‘»readonlyHandlers"></a>ğŸ‘»readonlyHandlers</h4><h2 id="ğŸ˜Šref-ts"><a href="#ğŸ˜Šref-ts" class="headerlink" title="ğŸ˜Šref.ts"></a>ğŸ˜Šref.ts</h2><p>ä½¿ç”¨Proxyå¯ä»¥è®©å¯¹è±¡æˆä¸ºå“åº”å¼æ•°æ®ï¼Œä½†æ˜¯å¯¹äºåŸºæœ¬æ•°æ®ç±»å‹å´æ— èƒ½ä¸ºåŠ›ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Refå°†åŸºæœ¬æ•°æ®ç±»å‹åŒ…è½¬æˆå¯¹è±¡ï¼Œå°†åŸæ•°æ®å­˜å‚¨åœ¨åˆ›å»ºçš„æ–°å¯¹è±¡çš„valueå±æ€§ä¸Šï¼Œç„¶åç›´æ¥åŠ«æŒvalueå±æ€§çš„getå’Œsetå³å¯</p>
<h3 id="ref-tsæºç åˆ†æ"><a href="#ref-tsæºç åˆ†æ" class="headerlink" title="ref.tsæºç åˆ†æ"></a>ref.tsæºç åˆ†æ</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¦‚æœvalæ˜¯å¯¹è±¡ï¼Œä½¿ç”¨reactiveå¤„ç†ä¸ºå“åº”å¼å¯¹è±¡</span></span><br><span class="line"><span class="comment">// å¦åˆ™ç›´æ¥è¿”å›val</span></span><br><span class="line"><span class="keyword">const</span> convert = &lt;T <span class="keyword">extends</span> unknown&gt;(val: T): <span class="function"><span class="params">T</span> =&gt;</span></span><br><span class="line">  isObject(val) ? reactive(val) : val</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸ºRefå¯¹è±¡</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isRef</span>(<span class="params">r: <span class="built_in">any</span></span>): <span class="title">r</span> <span class="title">is</span> <span class="title">Ref</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> r ? r._isRef === <span class="literal">true</span> : <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// refå‡½æ•°çš„é‡è½½åˆ—è¡¨</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">ref</span>&lt;<span class="title">T</span> <span class="title">extends</span> <span class="title">Ref</span>&gt;(<span class="params">raw: T</span>): <span class="title">T</span></span></span><br><span class="line"><span class="function"><span class="title">export</span> <span class="function"><span class="keyword">function</span> <span class="title">ref</span>&lt;<span class="title">T</span>&gt;(<span class="params">raw: T</span>): <span class="title">Ref</span>&lt;<span class="title">T</span>&gt;</span></span></span><br><span class="line"><span class="function"><span class="function"><span class="title">export</span> <span class="function"><span class="keyword">function</span> <span class="title">ref</span>&lt;<span class="title">T</span> = <span class="title">any</span>&gt;(<span class="params"></span>): <span class="title">Ref</span>&lt;<span class="title">T</span>&gt;</span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="title">export</span> <span class="function"><span class="keyword">function</span> <span class="title">ref</span>(<span class="params">raw?: unknown</span>) </span>&#123;</span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function">  // å¦‚æœå·²ç»æ˜¯<span class="title">Ref</span>å¯¹è±¡ç›´æ¥è¿”å›</span></span></span></span><br><span class="line">  if (isRef(raw)) &#123;</span><br><span class="line">    <span class="keyword">return</span> raw</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å¦‚æœrawæ˜¯Objectï¼Œé¦–å…ˆä½¿ç”¨reactiveè½¬æ¢ä¸ºå“åº”å¼å¯¹è±¡</span></span><br><span class="line">  <span class="comment">// ä¹Ÿå°±æ˜¯è¯´ï¼Œrefå‡½æ•°æ—¢å¯ä»¥ç”¨äºåŸºæœ¬æ•°æ®ç±»å‹ï¼Œä¹Ÿå¯ä»¥ç”¨äºå¼•ç”¨æ•°æ®ç±»å‹</span></span><br><span class="line">  <span class="comment">// ä½†æ˜¯å¯¹äºå¼•ç”¨æ•°æ®ç±»å‹å“åº”å¼ç›‘å¬æ˜¯åŸºäºreactiveå®ç°çš„</span></span><br><span class="line">  raw = convert(raw)</span><br><span class="line">  <span class="comment">// å¯¹r.valueçš„getå’Œsetè¿›è¡ŒåŠ«æŒ</span></span><br><span class="line">  <span class="keyword">const</span> r = &#123;</span><br><span class="line">    _isRef: <span class="literal">true</span>, <span class="comment">// æ·»åŠ _isRefæ ‡è¯†ï¼Œæ ‡è®°ä¸ºRefå¯¹è±¡</span></span><br><span class="line">    <span class="keyword">get</span> value() &#123;</span><br><span class="line">      <span class="comment">// trackæ”¶é›†ä¾èµ–</span></span><br><span class="line">      track(r, OperationTypes.GET, <span class="string">'value'</span>)</span><br><span class="line">      <span class="keyword">return</span> raw</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">set</span> value(newVal) &#123;</span><br><span class="line">      raw = convert(newVal)</span><br><span class="line">      <span class="comment">// triggerè§¦å‘ä¾èµ–æ›´æ–°</span></span><br><span class="line">      trigger(</span><br><span class="line">        r,</span><br><span class="line">        OperationTypes.SET,</span><br><span class="line">        <span class="string">'value'</span>,</span><br><span class="line">        __DEV__ ? &#123; newValue: newVal &#125; : <span class="built_in">void</span> <span class="number">0</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> r</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="interface-Ref"><a href="#interface-Ref" class="headerlink" title="interface Ref"></a>interface Ref</h4><p>å¯¹äº<code>Ref</code>ç±»å‹å®šä¹‰çš„æ¥å£</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isRefSymbol = Symbol()</span><br><span class="line"><span class="comment">// Refæ¥å£</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> Ref&lt;T = any&gt; &#123;</span><br><span class="line">  <span class="comment">// [isRefSymbol]å­—æ®µæ˜¯å¿…é¡»çš„ï¼Œç”¨äºåŒºåˆ†æ°å¥½æ‹¥æœ‰valueå±æ€§çš„æ™®é€šå¯¹è±¡</span></span><br><span class="line">  <span class="comment">// ä½†æ˜¯åœ¨å¯¹è±¡ä¸Šæ£€æŸ¥Symbolå±æ€§ï¼Œæ¯”æ£€æŸ¥æ™®é€šå±æ€§æ…¢çš„å¤šï¼Œæ‰€ä»¥åœ¨isRefå‡½æ•°ä¸­ï¼Œä½¿ç”¨_isRefæ™®é€šå±æ€§è¿›è¡Œæ£€æŸ¥</span></span><br><span class="line">  [isRefSymbol]: <span class="literal">true</span></span><br><span class="line">  value: UnwrapRef&lt;T&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// UnwrapRefè§£å¥—ç±»å‹ï¼Œè§£å¼€Refç±»å‹çš„valueå±æ€§åµŒå¥—çš„Refç±»å‹</span></span><br><span class="line"><span class="comment">// å¦‚æœæ³›å‹å‚æ•°Tï¼Œæ»¡è¶³çº¦æŸæ¡ä»¶ComputedRef&lt;any&gt;ï¼Œé€’å½’çš„å±•å¼€åµŒå¥—ç»‘å®š</span></span><br><span class="line"><span class="comment">// å¦‚æœæ³›å‹å‚æ•°Tï¼Œæ»¡è¶³çº¦æŸæ¡ä»¶Ref, é€’å½’çš„å±•å¼€åµŒå¥—ç»‘å®š</span></span><br><span class="line"><span class="comment">// å¦‚æœæ³›å‹å‚æ•°Tï¼Œæ»¡è¶³çº¦æŸæ¡ä»¶Array&lt;any&gt;ï¼Œå¾ªç¯æ•°ç»„è§£å¼€ç»‘å®š</span></span><br><span class="line"><span class="comment">// å¦‚æœæ³›å‹å‚æ•°Tï¼Œæ»¡è¶³çº¦æŸæ¡ä»¶Function | Map&lt;any, any&gt; | Set&lt;any&gt; | WeakMap&lt;any, any&gt; | WeakSet&lt;any&gt;ï¼Œç›´æ¥è¿”å›æ³›å‹å‚æ•°Tçš„ç±»å‹</span></span><br><span class="line"><span class="comment">// å¦‚æœæ³›å‹å‚æ•°Tï¼Œæ»¡è¶³çº¦æŸæ¡ä»¶objectï¼Œå¾ªç¯objectçš„keysè§£å¼€ç»‘å®š</span></span><br><span class="line"><span class="comment">// å¦‚æœä¸Šè¿°çš„çº¦æŸæ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼Œè¿”å›æ³›å‹å‚æ•°Tçš„ç±»å‹</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> UnwrapRef&lt;T&gt; = &#123;</span><br><span class="line">  cRef: T <span class="keyword">extends</span> ComputedRef&lt;infer V&gt; ? UnwrapRef&lt;V&gt; : T</span><br><span class="line">  ref: T <span class="keyword">extends</span> Ref&lt;infer V&gt; ? UnwrapRef&lt;V&gt; : T</span><br><span class="line">  array: T <span class="keyword">extends</span> <span class="built_in">Array</span>&lt;infer V&gt; ? <span class="built_in">Array</span>&lt;UnwrapRef&lt;V&gt;&gt; &amp; UnwrapArray&lt;T&gt; : T</span><br><span class="line">  object: &#123; [K <span class="keyword">in</span> keyof T]: UnwrapRef&lt;T[K]&gt; &#125;</span><br><span class="line">&#125;[T <span class="keyword">extends</span> ComputedRef&lt;<span class="built_in">any</span>&gt;</span><br><span class="line">  ? <span class="string">'cRef'</span></span><br><span class="line">  : T <span class="keyword">extends</span> Ref</span><br><span class="line">    ? <span class="string">'ref'</span></span><br><span class="line">    : T <span class="keyword">extends</span> <span class="built_in">Array</span>&lt;<span class="built_in">any</span>&gt;</span><br><span class="line">      ? <span class="string">'array'</span></span><br><span class="line">      : T <span class="keyword">extends</span> <span class="built_in">Function</span> | CollectionTypes</span><br><span class="line">        ? <span class="string">'ref'</span> <span class="comment">// bail out on types that shouldn't be unwrapped</span></span><br><span class="line">        : T <span class="keyword">extends</span> object ? <span class="string">'object'</span> : <span class="string">'ref'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¾ªç¯çš„æ•°ç»„çš„å±æ€§ï¼Œè§£å¼€ç»‘å®š</span></span><br><span class="line"><span class="keyword">type</span> UnwrapArray&lt;T&gt; = &#123; [P <span class="keyword">in</span> keyof T]: UnwrapRef&lt;T[P]&gt; &#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ä¸Šé¢çš„ç±»å‹æ¨å¯¼çš„åˆ†æï¼Œå¯çŸ¥<code>Ref</code>ç±»å‹çš„<code>value</code>å±æ€§æ˜¯ä¸æ”¯æŒåµŒå¥—<code>Ref</code>ç±»å‹çš„å€¼ã€‚å¦‚æœ<code>value</code>çš„å€¼æ˜¯<code>Ref</code>ç±»å‹ï¼Œä¼šè¿›è¡Œé€’å½’è§£å¥—ã€‚ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œä»£ç å¦‚ä¸‹</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> foo = Ref&lt;&#123;a: <span class="number">1</span>, b: Ref&lt;<span class="number">2</span>&gt;&#125;&gt;</span><br><span class="line"><span class="keyword">let</span> bar!: foo</span><br><span class="line"><span class="comment">// åœ¨tsä¸­bar.valueç±»å‹ç­‰äº&#123;a: 1, b: 2&#125;</span></span><br><span class="line">bar.value</span><br></pre></td></tr></table></figure>
<h4 id="toRefs"><a href="#toRefs" class="headerlink" title="toRefs"></a>toRefs</h4><p>ä¸Šé¢æˆ‘ä»¬è¯´è¿‡<code>ref</code>æ˜¯ä¸ºäº†è§£å†³åŸºæœ¬æ•°æ®æ•°æ®ç±»å‹ï¼Œæ— æ³•ä½¿ç”¨<code>reactive</code>æˆä¸ºå“åº”å¼æ•°æ®ã€‚è€ƒè™‘ä¸‹é¢è¿™ç§æƒ…å†µï¼Œ<code>observed</code>æ˜¯ä¸€ä¸ªå“åº”å¼å¯¹è±¡ï¼Œä½†æ˜¯ç»è¿‡è§£æ„ï¼ˆè§£æ„å‡ºæ¥çš„å€¼æ˜¯åŸºæœ¬æ•°æ®ç±»å‹çš„æƒ…å†µä¸‹ï¼‰ï¼Œè§£æ„å‡ºæ¥çš„å€¼ä¹Ÿä¸åœ¨æ˜¯å“åº”å¼æ•°æ®ã€‚</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">let</span> dummy = <span class="literal">null</span></span><br><span class="line"><span class="keyword">const</span> original = &#123; foo: <span class="number">1</span> &#125;</span><br><span class="line"><span class="keyword">const</span> observed = reactive(original)</span><br><span class="line">effect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  dummy = observed.foo</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// dummy: 1</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`dummy:<span class="subst">$&#123;dummy&#125;</span>`</span>)</span><br><span class="line"><span class="keyword">let</span> &#123; foo &#125; = observed</span><br><span class="line"><span class="comment">// fooä¸æ˜¯å“åº”å¼æ•°æ®</span></span><br><span class="line">foo = <span class="number">2</span></span><br><span class="line"><span class="comment">// dummy: 1</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`dummy:<span class="subst">$&#123;dummy&#125;</span>`</span>)</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>toRefs</code>è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ<code>toRefs</code>ä¼šéå†å¯¹è±¡ï¼Œå°†å¯¹è±¡çš„æ¯ä¸€ä¸ªå±æ€§å˜ä¸ºRefæ•°æ®ã€‚ä½†æ˜¯<code>toRef</code>çš„å‚æ•°å¿…é¡»æ˜¯ç»è¿‡<code>reactive</code>è¿”å›çš„å“åº”å¼æ•°æ®ï¼Œæ™®é€šçš„å¯¹è±¡ä½¿ç”¨<code>toRefs</code>æ˜¯æ— æ•ˆçš„ï¼Œåœ¨å¼€å‘ç¯å¢ƒä¸‹è¿˜ä¼šå‘å‡ºè­¦å‘Šã€‚</p>
<p>ä¸‹é¢æ˜¯ä½¿ç”¨<code>toRefs</code>åçš„ä¾‹å­</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> dummy = <span class="literal">null</span></span><br><span class="line"><span class="keyword">const</span> original = &#123; foo: <span class="number">1</span> &#125;</span><br><span class="line"><span class="keyword">const</span> observed = reactive(original)</span><br><span class="line"><span class="keyword">const</span> observedRef = toRefs(observed)</span><br><span class="line">effect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  dummy = observedRef.foo.value</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// dummy: 1</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`dummy:<span class="subst">$&#123;dummy&#125;</span>`</span>)</span><br><span class="line"><span class="keyword">let</span> &#123; foo &#125; = observedRef</span><br><span class="line"><span class="comment">// fooç°åœ¨æ˜¯å“åº”å¼æ•°æ®</span></span><br><span class="line">foo.value = <span class="number">2</span></span><br><span class="line"><span class="comment">// dummy: 2</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`dummy:<span class="subst">$&#123;dummy&#125;</span>`</span>)</span><br></pre></td></tr></table></figure>
<p>toRefsçš„æºç å¦‚ä¸‹ï¼Œæºç å¾ˆç®€å•ï¼Œéå†å¯¹è±¡çš„æ¯ä¸€ä¸ªkeyï¼Œé€šè¿‡<code>toProxyRef</code>ï¼Œå°†æ¯ä¸€ä¸ªå±æ€§å€¼å¤„ç†ä¸º<code>ref</code>å¯¹è±¡</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">toRefs</span>&lt;<span class="title">T</span> <span class="title">extends</span> <span class="title">object</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  object: T</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): </span>&#123; [K <span class="keyword">in</span> keyof T]: Ref&lt;T[K]&gt; &#125; &#123;</span><br><span class="line">  <span class="comment">// å‚æ•°å¿…é¡»æ˜¯å“åº”å¼æ•°æ®ï¼Œå¦åˆ™ä¼šå‘å‡ºè­¦å‘Š</span></span><br><span class="line">  <span class="keyword">if</span> (__DEV__ &amp;&amp; !isReactive(object)) &#123;</span><br><span class="line">    <span class="built_in">console</span>.warn(<span class="string">`toRefs() expects a reactive object but received a plain one.`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> ret: <span class="built_in">any</span> = &#123;&#125;</span><br><span class="line">  <span class="comment">// éå†å¯¹è±¡ä¸­æ‰€ä»¥key</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> object) &#123;</span><br><span class="line">    <span class="comment">// toProxyRefä¼šå°†æ¯ä¸€ä¸ªå±æ€§ï¼Œè½¬æ¢ä¸ºRefå¯¹è±¡</span></span><br><span class="line">    ret[key] = toProxyRef(object, key)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ret</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">toProxyRef</span>&lt;<span class="title">T</span> <span class="title">extends</span> <span class="title">object</span>, <span class="title">K</span> <span class="title">extends</span> <span class="title">keyof</span> <span class="title">T</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  object: T,</span></span></span><br><span class="line"><span class="function"><span class="params">  key: K</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Ref</span>&lt;<span class="title">T</span>[<span class="title">K</span>]&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="comment">// getï¼Œsetä¸­å¹¶æ²¡æœ‰æ”¶é›†ä¾èµ–å’Œè¿›è¡Œè§¦å‘ä¾èµ–æ›´æ–°</span></span><br><span class="line">    <span class="comment">// è¿™æ˜¯å› ä¸ºobjectæœ¬èº«å°±æ˜¯å“åº”å¼æ•°æ®</span></span><br><span class="line">    <span class="comment">// object[key]ä¼šè§¦å‘Proxyçš„åŠ«æŒè¿›è¡Œæ”¶é›†ä¾èµ–</span></span><br><span class="line">    <span class="comment">// object[key] = newVal ä¹Ÿä¼šè§¦å‘ä¾èµ–æ›´æ–°</span></span><br><span class="line">    _isRef: <span class="literal">true</span>,</span><br><span class="line">    <span class="keyword">get</span> value(): <span class="built_in">any</span> &#123;</span><br><span class="line">      <span class="comment">// è¿™é‡Œæ²¡æœ‰ä½¿ç”¨trackï¼Œæ”¶é›†ä¾èµ–</span></span><br><span class="line">      <span class="keyword">return</span> object[key]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">set</span> value(newVal) &#123;</span><br><span class="line">      <span class="comment">// è¿™é‡Œæ²¡æœ‰ä½¿ç”¨triggerï¼Œè§¦å‘ä¾èµ–æ›´æ–°</span></span><br><span class="line">      object[key] = newVal</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ğŸ˜Šeffect-ts"><a href="#ğŸ˜Šeffect-ts" class="headerlink" title="ğŸ˜Šeffect.ts"></a>ğŸ˜Šeffect.ts</h2><p>effectæ¥å—ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œä½œä¸ºå‚æ•°çš„å‡½æ•°ä¼šæˆä¸ºä¸€ä¸ªç›‘å¬å‡½æ•°ã€‚ç›‘å¬å‡½æ•°ä¼šé€šè¿‡<code>track</code>å‡½æ•°ä¼šæ”¶é›†ç›‘å¬å‡½æ•°ä¸­çš„ä¾èµ–ï¼Œå½“ä¾èµ–å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ä¼šé€šè¿‡<code>trigger</code>å‡½æ•°ï¼Œè§¦å‘ç›‘å¬å‡½æ•°çš„å“åº”ã€‚åœ¨Vue3ä¸­<code>watch</code>å’Œ<code>computed</code>å‡æ˜¯åŸºäºeffectå®ç°çš„ã€‚</p>
<h3 id="effect-tsæºç è§£æ"><a href="#effect-tsæºç è§£æ" class="headerlink" title="effect.tsæºç è§£æ"></a>effect.tsæºç è§£æ</h3><p>ç›‘å¬å‡½æ•°çš„æ¥å£ï¼Œä»¥åŠç›‘å¬å‡½æ•°<code>options</code>é…ç½®é¡¹çš„æ¥å£</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// effectçš„æ¥å£</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> ReactiveEffect&lt;T = any&gt; &#123;</span><br><span class="line">  (): T</span><br><span class="line">  <span class="comment">// æ ‡è®°ä¸ºç›‘å¬å‡½æ•°</span></span><br><span class="line">  _isEffect: <span class="literal">true</span></span><br><span class="line">  <span class="comment">// ç»ˆæ­¢å“åº”çš„æ ‡è®°</span></span><br><span class="line">  active: <span class="built_in">boolean</span></span><br><span class="line">  <span class="comment">// effectçš„å‚æ•°çš„åŸå‡½æ•°</span></span><br><span class="line">  raw: <span class="function"><span class="params">()</span> =&gt;</span> T</span><br><span class="line">  <span class="comment">// Depç±»å‹åˆ«ååœ¨reactive.tsä¸­ä»‹ç»è¿‡ï¼Œtype Dep = Set&lt;ReactiveEffect&gt;</span></span><br><span class="line">  <span class="comment">// æ‰€ä»¥depsæ•°ç»„ä¸­çš„å†…å®¹ç±»ä¼¼ä¸º[Set&lt;effect1, effect2&gt;, Set&lt;effect1, effect3&gt;]</span></span><br><span class="line">  <span class="comment">// ä¸åŒçš„Setä¸­ï¼Œå¯èƒ½å­˜å‚¨äº†åŒä¸€ä¸ªeffectï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆä½¿ç”¨depsé€‰é¡¹å‘¢ï¼Ÿè¯·çœ‹ä¸‹é¢</span></span><br><span class="line">  deps: <span class="built_in">Array</span>&lt;Dep&gt;</span><br><span class="line">  <span class="comment">// effectçš„é…ç½®é¡¹</span></span><br><span class="line">  options: ReactiveEffectOptions</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// effectçš„optionsé…ç½®é¡¹çš„æ¥å£</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> ReactiveEffectOptions &#123;</span><br><span class="line">  <span class="comment">// effectæ˜¯å¦è¿›è¡Œæƒ°æ€§è®¡ç®—</span></span><br><span class="line">  <span class="comment">// å¦‚æœè®¾ç½®ä¸ºtrueï¼Œeffectåœ¨åˆ›å»ºæ—¶ï¼Œä¸ä¼šä¸»åŠ¨æ‰§è¡Œç›‘å¬å‡½æ•°</span></span><br><span class="line">  <span class="comment">// å¦‚æœä¸è®¾ç½®ï¼Œeffectåœ¨åˆ›å»ºæ—¶ï¼Œä¼šä¸»åŠ¨æ‰§è¡Œä¸€æ¬¡ç›‘å¬å‡½æ•°ï¼Œæ”¶é›†ä¾èµ–</span></span><br><span class="line">  lazy?: <span class="built_in">boolean</span></span><br><span class="line">  <span class="comment">// å°†effectæ ‡è®°ä¸ºcomputedï¼Œä»¥ä¾¿åœ¨æ›´æ–°é˜¶æ®µæ‹¥æœ‰æ›´é«˜çš„æ‰§è¡Œä¼˜å…ˆçº§ï¼ˆå…·ä½“çš„ä½œç”¨è¯·çœ‹åæ–‡ï¼‰</span></span><br><span class="line">  computed?: <span class="built_in">boolean</span></span><br><span class="line">  <span class="comment">// å¦‚æœè®¾ç½®äº†scheduleré€‰é¡¹ï¼Œè§¦å‘æ›´æ–°æ—¶ä¸ä¼šç›´æ¥è°ƒç”¨effect(fn)çš„fn()ï¼Œè€Œæ˜¯ä¼šè°ƒç”¨scheduler(fn)</span></span><br><span class="line">  scheduler?: <span class="function">(<span class="params">run: <span class="built_in">Function</span></span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">  onTrack?: <span class="function">(<span class="params">event: DebuggerEvent</span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">  onTrigger?: <span class="function">(<span class="params">event: DebuggerEvent</span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">  onStop?: <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">void</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ­£åœ¨æ‰§è¡Œä¸­çš„effectçš„å †æ ˆ</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> effectStack: ReactiveEffect[] = []</span><br><span class="line"><span class="comment">// æ”¶é›†ä¾èµ–ï¼Œé‡åˆ°è¿­ä»£æ“ä½œã€‚å¦‚ï¼Œforâ€¦â€¦inï¼ŒObject.keys()æ—¶æ‰€ç”¨çš„key</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ITERATE_KEY = Symbol(<span class="string">'iterate'</span>)</span><br></pre></td></tr></table></figure>
<p>ç›‘å¬å‡½æ•°çš„<code>deps</code>å±æ€§æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œé‚£ä¹ˆè¿™ä¸ªæ•°ç»„ä¸­åˆ°åº•å­˜å‚¨çš„ä»€ä¹ˆä¸œè¥¿å‘¢ï¼Ÿå› ä¸º<code>deps</code>è¿™ä¸ªå±æ€§å¾ˆé‡è¦ï¼Œåé¢å¾ˆå¤šå‡½æ•°é€»è¾‘ä¸­éƒ½ä¼šä½¿ç”¨åˆ°ï¼Œæ‰€ä»¥è¿™é‡Œå…ˆæ”¾ç»“è®ºã€‚å…·ä½“ç»†èŠ‚è¯·çœ‹åé¢å…³äº<code>track</code>å‡½æ•°çš„è§£æã€‚</p>
<p>æ”¶é›†ä¾èµ–å‘ç”Ÿåœ¨<code>effect</code>æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œå½“<code>effect</code>å†…éƒ¨ä½¿ç”¨äº†å“åº”å¼æ•°æ®ï¼Œè§¦å‘Proxyçš„åŠ«æŒï¼Œåœ¨Proxyä¸­è°ƒç”¨<code>track</code>å‡½æ•°æ”¶é›†å…³äºå½“å‰<code>effect</code>çš„ä¾èµ–ã€‚æˆ‘ä»¬ä¹‹å‰åœ¨<code>reactive.ts</code>ä¸­ä»‹ç»è¿‡<code>targetMap</code>çš„ç»“æ„ï¼Œ<code>targetMap</code>çš„ç»“æ„å¦‚ä¸‹å›¾ã€‚</p>
<p><img src="https://i.loli.net/2019/11/11/LoeQqi13BP7HjnW.png" alt="targetMap"></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹å‡ºåœ¨<code>Dep</code>ä¸­ä¿å­˜çš„éƒ½æ˜¯<code>effect</code>ï¼Œè¿™äº›<code>effect</code>å†…éƒ¨éƒ½ä½¿ç”¨äº†åŒä¸€ä¸ªå“åº”å¼å¯¹è±¡çš„<code>key</code>ï¼Œæ‰€ä»¥ä¼šè¢«æ”¶é›†åˆ°åŒä¸€ä¸ª<code>Dep</code>ä¸­ã€‚å› ä¸º<code>effect</code>å¯èƒ½ä½¿ç”¨åˆ°äº†å¤šä¸ªå“åº”å¼å¯¹è±¡ï¼Œæ‰€ä»¥å½“å‰<code>effect</code>å¯èƒ½ä¼šè¢«å¤šä¸ª<code>Dep</code>é‡å¤æ”¶é›†ã€‚</p>
<p>å½“å‰çš„<code>effect</code>å†…éƒ¨å¯èƒ½ä½¿ç”¨äº†å¤šä¸ªå“åº”å¼å¯¹è±¡ï¼Œæ‰€ä»¥å½“å‰<code>effect</code>å¯èƒ½ä¼šè¢«å¤šä¸ª<code>Dep</code>æ”¶é›†ã€‚è€Œ<code>effect.deps</code>å°±æ˜¯è¿™äº›åŒ…å«å½“å‰<code>effect</code>çš„<code>Dep</code>çš„é›†åˆã€‚ï¼ˆæ¢ä¸€å¥è¯è¯´ï¼Œ<code>effect.deps</code>ä¸­ä¿å­˜äº†æ‰€æœ‰åŒ…å«è‡ªèº«çš„<code>effect</code>çš„<code>Dep</code>ï¼Œè¿™ä¸€ç‚¹åœ¨æ¸…ç†ä¾èµ–å…³ç³»æ—¶å¾ˆé‡è¦ï¼‰</p>
<p>æˆ‘ä»¬æ¥ç€å¾€ä¸‹çœ‹æºç </p>
<h4 id="effect"><a href="#effect" class="headerlink" title="effect"></a>effect</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ¤æ–­æ˜¯å¦æ˜¯ç›‘å¬å‡½æ•°</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isEffect</span>(<span class="params">fn: <span class="built_in">any</span></span>): <span class="title">fn</span> <span class="title">is</span> <span class="title">ReactiveEffect</span> </span>&#123;</span><br><span class="line">  <span class="comment">// é€šè¿‡åˆ¤æ–­_isEffectå±æ€§ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºç›‘å¬å‡½æ•°</span></span><br><span class="line">  <span class="keyword">return</span> fn != <span class="literal">null</span> &amp;&amp; fn._isEffect === <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºç›‘å¬å‡½æ•°</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">effect</span>&lt;<span class="title">T</span> = <span class="title">any</span>&gt;(<span class="params"></span></span></span><br><span class="line">  fn: () =&gt; T, // ç›‘å¬å‡½æ•°çš„åŸå‡½æ•°</span><br><span class="line">  options: ReactiveEffectOptions = EMPTY_OBJ <span class="comment">// ç›‘å¬å‡½æ•°çš„é…ç½®é¡¹ï¼Œé»˜è®¤æ˜¯ä¸€ä¸ªç©ºå¯¹è±¡</span></span><br><span class="line">): ReactiveEffect&lt;T&gt; &#123;</span><br><span class="line">  <span class="comment">// å¦‚æœfnæœ¬èº«å°±æ˜¯ç›‘å¬å‡½æ•°ï¼Œå–fn.rawä¸Šçš„åŸå§‹å‡½æ•°ï¼Œç„¶åé‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„ç›‘å¬å‡½æ•°</span></span><br><span class="line">  <span class="keyword">if</span> (isEffect(fn)) &#123;</span><br><span class="line">    fn = fn.raw</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// è°ƒç”¨createReactiveEffectåˆ›å»ºç›‘å¬å‡½æ•°</span></span><br><span class="line">  <span class="keyword">const</span> effect = createReactiveEffect(fn, options)</span><br><span class="line">  <span class="comment">// å¦‚æœæ²¡æœ‰è®¾ç½®lazyé…ç½®é¡¹ï¼Œç›‘å¬å‡½æ•°ä¼šç«‹å³æ‰§è¡Œä¸€æ¬¡ï¼ˆå¹¶æ”¶é›†ä¾èµ–ï¼‰</span></span><br><span class="line">  <span class="keyword">if</span> (!options.lazy) &#123;</span><br><span class="line">    effect()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> effect</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createReactiveEffect</span>&lt;<span class="title">T</span> = <span class="title">any</span>&gt;(<span class="params"></span></span></span><br><span class="line">  fn: () =&gt; T,</span><br><span class="line">  options: ReactiveEffectOptions</span><br><span class="line">): ReactiveEffect&lt;T&gt; &#123;</span><br><span class="line">  <span class="comment">// åˆ›å»ºç›‘å¬å‡½æ•°ï¼Œå¹¶åšäº†ä¸€å±‚é¢å¤–çš„åŒ…è£¹</span></span><br><span class="line">  <span class="keyword">const</span> effect = <span class="function"><span class="keyword">function</span> <span class="title">reactiveEffect</span>(<span class="params">...args: unknown[]</span>): <span class="title">unknown</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨runæ–¹æ³•æ‰§è¡Œç›‘å¬å‡½æ•°</span></span><br><span class="line">    <span class="keyword">return</span> run(effect, fn, args)</span><br><span class="line">  &#125; <span class="keyword">as</span> ReactiveEffect</span><br><span class="line">  <span class="comment">// æ ‡è®°ä¸ºç›‘å¬å‡½æ•°</span></span><br><span class="line">  effect._isEffect = <span class="literal">true</span></span><br><span class="line">  <span class="comment">// æ˜¯å¦åœæ­¢ç›‘å¬çš„æ ‡è®°</span></span><br><span class="line">  effect.active = <span class="literal">true</span></span><br><span class="line">  <span class="comment">// ä¿å­˜åŸå‡½æ•°</span></span><br><span class="line">  effect.raw = fn</span><br><span class="line">  <span class="comment">// ä¸Šé¢ä»‹ç»è¿‡deps</span></span><br><span class="line">  effect.deps = []</span><br><span class="line">  effect.options = options</span><br><span class="line">  <span class="keyword">return</span> effect</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›‘å¬å‡½æ•°çš„æ‰§è¡Œå™¨</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params">effect: ReactiveEffect, fn: <span class="built_in">Function</span>, args: unknown[]</span>): <span class="title">unknown</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!effect.active) &#123;</span><br><span class="line">    <span class="keyword">return</span> fn(...args)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// é˜²æ­¢é€’å½’å¼•ç”¨çˆ†æ ˆ</span></span><br><span class="line">  <span class="keyword">if</span> (!effectStack.includes(effect)) &#123;</span><br><span class="line">    <span class="comment">// æ¸…é™¤å½“å‰effectåœ¨targetMapçš„æ‰€æœ‰çš„æ˜ å°„å…³ç³»</span></span><br><span class="line">    cleanup(effect)</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// å°†å½“å‰æ­£åœ¨æ‰§è¡Œeffectï¼Œæ¨åˆ°effectStackå †æ ˆä¸­</span></span><br><span class="line">      effectStack.push(effect)</span><br><span class="line">      <span class="comment">// æ‰§è¡ŒåŸå‡½æ•°ï¼Œå¹¶ä¸”é‡æ–°æ”¶é›†ä¾èµ–</span></span><br><span class="line">      <span class="keyword">return</span> fn(...args)</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">// æ‰§è¡Œå®Œæˆåï¼Œå°†å½“å‰çš„effectä»effectStackä¸­æ¸…é™¤</span></span><br><span class="line">      effectStack.pop()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ¸…é™¤å½“å‰effectåœ¨targetMapä¸­æ‰€æœ‰æ˜ å°„å…³ç³»</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cleanup</span>(<span class="params">effect: ReactiveEffect</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; deps &#125; = effect</span><br><span class="line">  <span class="keyword">if</span> (deps.length) &#123;</span><br><span class="line">    <span class="comment">// æ¸…é™¤depsæ•°ç»„ä¸­ï¼Œæ‰€æœ‰Depä¸­ä¿å­˜çš„å½“å‰çš„effect</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; deps.length; i++) &#123;</span><br><span class="line">      <span class="comment">// åˆ é™¤Setä¸­çš„effect</span></span><br><span class="line">      deps[i].delete(effect)</span><br><span class="line">    &#125;</span><br><span class="line">    deps.length = <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="ğŸ¤”ï¸åœ¨effectçš„æ‰§è¡Œå™¨runä¸­ï¼Œä½¿ç”¨-effectStack-includes-effect-åˆ¤æ–­æ˜¯ä»€ä¹ˆé€»è¾‘ï¼Ÿ"><a href="#ğŸ¤”ï¸åœ¨effectçš„æ‰§è¡Œå™¨runä¸­ï¼Œä½¿ç”¨-effectStack-includes-effect-åˆ¤æ–­æ˜¯ä»€ä¹ˆé€»è¾‘ï¼Ÿ" class="headerlink" title="ğŸ¤”ï¸åœ¨effectçš„æ‰§è¡Œå™¨runä¸­ï¼Œä½¿ç”¨!effectStack.includes(effect)åˆ¤æ–­æ˜¯ä»€ä¹ˆé€»è¾‘ï¼Ÿ"></a>ğŸ¤”ï¸åœ¨effectçš„æ‰§è¡Œå™¨runä¸­ï¼Œä½¿ç”¨!effectStack.includes(effect)åˆ¤æ–­æ˜¯ä»€ä¹ˆé€»è¾‘ï¼Ÿ</h5><p>ä½¿ç”¨<code>!effectStack.includes(effect)</code>åˆ¤æ–­å½“å‰<code>effect</code>æ˜¯å¦åœ¨å †æ ˆä¸­çš„ç›®çš„ï¼Œæ˜¯ä¸ºäº†é¿å…é€’å½’å¼•ç”¨ã€‚ä¸ºä»€ä¹ˆï¼Ÿè¯·çœ‹ä¸‹é¢çš„å•å…ƒæµ‹è¯•ã€‚</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'should avoid implicit infinite recursive loops with itself'</span>, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> counter = reactive(&#123; num: <span class="number">0</span> &#125;)</span><br><span class="line">  <span class="keyword">const</span> counterSpy = jest.fn(<span class="function"><span class="params">()</span> =&gt;</span> counter.num++)</span><br><span class="line">  effect(counterSpy)</span><br><span class="line">  expect(counter.num).toBe(<span class="number">1</span>)</span><br><span class="line">  expect(counterSpy).toHaveBeenCalledTimes(<span class="number">1</span>)</span><br><span class="line">  <span class="comment">// æˆ‘ä»¬çŸ¥é“ï¼Œeffectæ‰§è¡Œæ—¶ï¼Œä¼šå°†ç›‘å¬å‡½æ•°pushåˆ°effectStackå †æ ˆä¸­</span></span><br><span class="line">  <span class="comment">// ä¿®æ”¹å“åº”å¼æ•°æ®counterï¼Œä¼šè§¦å‘ç›‘å¬å‡½æ•°æ‰§è¡Œ</span></span><br><span class="line">  <span class="comment">// ä½†æ˜¯counterSpyç›‘å¬å‡½æ•°å†…éƒ¨åˆä¼šå†ä¸€æ¬¡ä¿®æ”¹å“åº”å¼æ•°æ®counter</span></span><br><span class="line">  <span class="comment">// å¦‚æœä¸æ·»åŠ `!effectStack.includes(effect)`çš„åˆ¤æ–­ï¼Œé‡åˆ°è¿™ç§æƒ…å†µå°±ä¼šäº§ç”Ÿé€’å½’å¼•ç”¨çš„é”™è¯¯</span></span><br><span class="line">  counter.num = <span class="number">4</span></span><br><span class="line">  expect(counter.num).toBe(<span class="number">5</span>)</span><br><span class="line">  expect(counterSpy).toHaveBeenCalledTimes(<span class="number">2</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h5 id="ğŸ¤”ï¸ä¸ºä»€ä¹ˆåœ¨runä¸­æ‰§è¡Œfnå‰ï¼Œéœ€è¦ä½¿ç”¨cleanup-effect-æ¸…é™¤æ‰€æœ‰ä¾èµ–å…³ç³»ï¼Ÿ"><a href="#ğŸ¤”ï¸ä¸ºä»€ä¹ˆåœ¨runä¸­æ‰§è¡Œfnå‰ï¼Œéœ€è¦ä½¿ç”¨cleanup-effect-æ¸…é™¤æ‰€æœ‰ä¾èµ–å…³ç³»ï¼Ÿ" class="headerlink" title="ğŸ¤”ï¸ä¸ºä»€ä¹ˆåœ¨runä¸­æ‰§è¡Œfnå‰ï¼Œéœ€è¦ä½¿ç”¨cleanup(effect)æ¸…é™¤æ‰€æœ‰ä¾èµ–å…³ç³»ï¼Ÿ"></a>ğŸ¤”ï¸ä¸ºä»€ä¹ˆåœ¨runä¸­æ‰§è¡Œfnå‰ï¼Œéœ€è¦ä½¿ç”¨cleanup(effect)æ¸…é™¤æ‰€æœ‰ä¾èµ–å…³ç³»ï¼Ÿ</h5><p>ç›®çš„æ˜¯ä¸ºäº†æ¸…é™¤ä¸€äº›ä¸å¿…è¦çš„ç›‘å¬ã€‚è¯·çœ‹ä¸‹é¢çš„å•å…ƒæµ‹è¯•ä¸­ä¸¾å‡ºçš„ä¾‹å­ã€‚</p>
<p>å½“<code>obj.run</code>ç­‰äºfalseæ—¶ï¼Œ<code>obj.prop</code>è¿™ä¸ªåˆ†æ”¯ï¼Œæ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œï¼Œæ‰€ä»¥<code>obj.prop</code>çš„ä¾èµ–å…³ç³»ä¹Ÿåº”è¯¥ä»<code>targetMap</code>ä¸­åˆ é™¤ã€‚æ‰€ä»¥åœ¨æ¯æ¬¡æ‰§è¡Œç›‘å¬å‡½æ•°æ˜¯ï¼Œéƒ½è¦åˆ é™¤ï¼Œç„¶åå†é‡æ–°æ”¶é›†ä¾èµ–ã€‚</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">it(<span class="string">'should not be triggered by mutating a property, which is used in an inactive branch'</span>, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> dummy</span><br><span class="line">  <span class="keyword">const</span> obj = reactive(&#123; prop: <span class="string">'value'</span>, run: <span class="literal">true</span> &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> conditionalSpy = jest.fn(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    dummy = obj.run ? obj.prop : <span class="string">'other'</span></span><br><span class="line">  &#125;)</span><br><span class="line">  effect(conditionalSpy)</span><br><span class="line"></span><br><span class="line">  expect(dummy).toBe(<span class="string">'value'</span>)</span><br><span class="line">  expect(conditionalSpy).toHaveBeenCalledTimes(<span class="number">1</span>)</span><br><span class="line">  <span class="comment">// å½“obj.runè®¾ç½®ä¸ºfalseæ—¶ï¼Œè§¦å‘ç›‘å¬å‡½æ•°çš„å“åº”</span></span><br><span class="line">  <span class="comment">// åœ¨å“åº”å‰ï¼Œä¼šè°ƒç”¨cleanup(effect)ï¼Œæ¸…ç©ºeffectæ‰€å¯¹åº”æ‰€æœ‰çš„ä¾èµ–å…³ç³»</span></span><br><span class="line">  <span class="comment">// ç”±äºobj.runç­‰äºfalseï¼Œæ‰€ä»¥obj.propçš„åˆ†æ”¯æ˜¯æ°¸è¿œä¸ä¼šæ‰§è¡Œï¼ˆä¾èµ–ä¹Ÿä¸ä¼šè¢«æ”¶é›†ï¼‰</span></span><br><span class="line">  <span class="comment">// æ‰€ä»¥ç›‘å¬å‡½æ•°æ‰§è¡Œå®Œåï¼Œä¿®æ”¹obj.propå°†ä¸ä¼šå†è§¦å‘ç›‘å¬å‡½æ•°äº†</span></span><br><span class="line">  obj.run = <span class="literal">false</span></span><br><span class="line">  expect(dummy).toBe(<span class="string">'other'</span>)</span><br><span class="line">  expect(conditionalSpy).toHaveBeenCalledTimes(<span class="number">2</span>)</span><br><span class="line">  <span class="comment">// ä¿®æ”¹obj.propå°†ä¸åœ¨è§¦å‘ç›‘å¬å‡½æ•°</span></span><br><span class="line">  obj.prop = <span class="string">'value2'</span></span><br><span class="line">  expect(dummy).toBe(<span class="string">'other'</span>)</span><br><span class="line">  expect(conditionalSpy).toHaveBeenCalledTimes(<span class="number">2</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="track"><a href="#track" class="headerlink" title="track"></a>track</h4><p>ç»ˆäºè®²åˆ°äº†<code>track</code>ï¼Œæˆ‘ä»¬åœ¨ä¹‹å‰ä»‹ç»<code>baseHandlers.ts</code>å’Œ<code>ref.ts</code>æ—¶éƒ½ä»‹ç»äº†å®ƒã€‚å®ƒåœ¨æ•´ä¸ªå“åº”å¼ç³»ç»Ÿä¸­ï¼Œè´Ÿè´£ä¾èµ–çš„æ”¶é›†ã€‚åœ¨é˜…è¯»<code>track</code>çš„æºç å‰ï¼Œé¦–å…ˆå›é¡¾ä¸‹<code>targetMap</code>çš„ç»“æ„ï¼ˆç»“æ„å›¾åœ¨ä¸Šé¢ï¼‰ã€‚æˆ‘ä»¬å°†<code>targetMap</code>å±•å¼€å¤§è‡´æ˜¯è¿™æ ·çš„ç»“æ„ï¼Œ<code>WeakMap&lt;åŸå§‹å¯¹è±¡a, Map&lt;åŸå§‹å¯¹è±¡açš„key1, Set[ä½¿ç”¨äº†åŸå§‹å¯¹è±¡açš„key1çš„ç›‘å¬å‡½æ•°1, åŸå§‹å¯¹è±¡açš„key1çš„ç›‘å¬å‡½æ•°2]&gt;&gt;</code>ã€‚å¥½äº†ï¼Œæˆ‘ä»¬ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„å®ç°å§ã€‚</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">track</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  target: object, <span class="comment">// åŸå§‹å¯¹è±¡</span></span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">type</span>: OperationTypes, <span class="comment">// æ”¶é›†ä¾èµ–æ“ä½œæ—¶çš„ç±»å‹</span></span></span></span><br><span class="line"><span class="function"><span class="params">  key?: unknown <span class="comment">// åŸå§‹å¯¹è±¡çš„key</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// å¦‚æœeffectStackå †æ ˆé•¿åº¦ä¸º0ï¼Œè¯´æ˜å½“å‰æ²¡æœ‰ç›‘å¬å‡½æ•°åœ¨æ‰§è¡Œï¼Œä¸éœ€è¦æ”¶é›†ä¾èµ–ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">  <span class="keyword">if</span> (!shouldTrack || effectStack.length === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ä¹‹å‰æˆ‘ä»¬åœ¨ç›‘å¬å‡½æ•°çš„æ‰§è¡Œå™¨runä¸­äº†è§£åˆ°</span></span><br><span class="line">  <span class="comment">// ç›‘å¬å‡½æ•°åœ¨æ‰§è¡Œå‰ä¼špushåˆ°effectStackä¸­ï¼Œæ‰§è¡Œå®Œæˆåä¼šä½¿ç”¨popä»effectStackä¸­æ¸…é™¤</span></span><br><span class="line">  <span class="comment">// æ‰€ä»¥effectStack[effectStack.length - 1]è·å–çš„æ­£æ˜¯å½“å‰æ­£åœ¨æ‰§è¡Œçš„ç›‘å¬å‡½æ•°ï¼ˆæˆ–è€…è¯´ï¼Œéœ€è¦è¢«ä¾èµ–æ”¶é›†çš„ç›‘å¬å‡½æ•°ï¼‰</span></span><br><span class="line">  <span class="keyword">const</span> effect = effectStack[effectStack.length - <span class="number">1</span>]</span><br><span class="line">  <span class="comment">// åœ¨Proxyä¸­ï¼Œå¯¹è¿­ä»£æ“ä½œè¿›è¡ŒåŠ«æŒæ—¶ï¼Œè°ƒç”¨trackæ—¶ï¼Œæ²¡æœ‰ä¼ å…¥keyå‚æ•°çš„ï¼Œä½¿ç”¨OperationTypes.ITERATEä½œä¸ºkey</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">type</span> === OperationTypes.ITERATE) &#123;</span><br><span class="line">    key = ITERATE_KEY</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// è·å–åŸå§‹å¯¹è±¡æ‰€å¯¹åº”çš„Mapï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆå§‹åŒ–åˆ›å»º</span></span><br><span class="line">  <span class="keyword">let</span> depsMap = targetMap.get(target)</span><br><span class="line">  <span class="keyword">if</span> (depsMap === <span class="built_in">void</span> <span class="number">0</span>) &#123;</span><br><span class="line">    targetMap.set(target, (depsMap = <span class="keyword">new</span> Map()))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// è·å–åŸå§‹å¯¹è±¡çš„keyæ‰€å¯¹åº”çš„ç›‘å¬å‡½æ•°çš„é›†åˆï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆå§‹åŒ–åˆ›å»º</span></span><br><span class="line">  <span class="keyword">let</span> dep = depsMap.get(key!)</span><br><span class="line">  <span class="keyword">if</span> (dep === <span class="built_in">void</span> <span class="number">0</span>) &#123;</span><br><span class="line">    depsMap.set(key!, (dep = <span class="keyword">new</span> Set()))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!dep.has(effect)) &#123;</span><br><span class="line">    <span class="comment">// å°†å½“å‰çš„effectæ·»åŠ åˆ°depé›†åˆä¸­ï¼Œå®Œæˆä¾èµ–æ”¶é›†</span></span><br><span class="line">    dep.add(effect)</span><br><span class="line">    <span class="comment">// åŒæ—¶å°†depé›†åˆæ·»åŠ åˆ°effect.depsé›†åˆä¸­ï¼ˆåŒå‘å­˜å‚¨ï¼Œæ–¹ä¾¿åœ¨runæ—¶ï¼Œæ¸…é™¤ä¾èµ–å…³ç³»ï¼‰</span></span><br><span class="line">    effect.deps.push(dep)</span><br><span class="line">    <span class="keyword">if</span> (__DEV__ &amp;&amp; effect.options.onTrack) &#123;</span><br><span class="line">      effect.options.onTrack(&#123;</span><br><span class="line">        effect,</span><br><span class="line">        target,</span><br><span class="line">        <span class="keyword">type</span>,</span><br><span class="line">        key</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="ğŸ¤”ï¸depé›†åˆæœ¬èº«æ˜¯Setç»“æ„ï¼Œæˆå‘˜å€¼æ˜¯å”¯ä¸€çš„ã€‚é‚£ä¸ºä»€ä¹ˆè¿˜è¦æ·»åŠ ï¼Œ-dep-has-effect-çš„åˆ¤æ–­ï¼Ÿ"><a href="#ğŸ¤”ï¸depé›†åˆæœ¬èº«æ˜¯Setç»“æ„ï¼Œæˆå‘˜å€¼æ˜¯å”¯ä¸€çš„ã€‚é‚£ä¸ºä»€ä¹ˆè¿˜è¦æ·»åŠ ï¼Œ-dep-has-effect-çš„åˆ¤æ–­ï¼Ÿ" class="headerlink" title="ğŸ¤”ï¸depé›†åˆæœ¬èº«æ˜¯Setç»“æ„ï¼Œæˆå‘˜å€¼æ˜¯å”¯ä¸€çš„ã€‚é‚£ä¸ºä»€ä¹ˆè¿˜è¦æ·»åŠ ï¼Œ!dep.has(effect)çš„åˆ¤æ–­ï¼Ÿ"></a>ğŸ¤”ï¸depé›†åˆæœ¬èº«æ˜¯Setç»“æ„ï¼Œæˆå‘˜å€¼æ˜¯å”¯ä¸€çš„ã€‚é‚£ä¸ºä»€ä¹ˆè¿˜è¦æ·»åŠ ï¼Œ!dep.has(effect)çš„åˆ¤æ–­ï¼Ÿ</h5><p>è¿›è¡Œ<code>!dep.has(effect)</code>åˆ¤æ–­çš„ç›®çš„ï¼Œæ˜¯ä¸ºäº†é¿å…é‡å¤çš„<code>dep</code>çš„é›†åˆè¢«<code>push</code>åˆ°<code>effect.deps</code>æ•°ç»„ä¸­ã€‚ä¸¾ä¸€ä¸ªä¾‹å­éªŒè¯ä¸€ä¸‹ï¼Œä»£ç å¦‚ä¸‹ã€‚</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> dummy = <span class="literal">null</span></span><br><span class="line"><span class="keyword">const</span> original = &#123; foo: <span class="number">1</span> &#125;</span><br><span class="line"><span class="keyword">const</span> observed = reactive(original)</span><br><span class="line"><span class="keyword">const</span> observedFn = effect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  dummy = observed.foo + observed.foo</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// å¦‚æœæ·»åŠ !dep.has(effect)çš„åˆ¤æ–­</span></span><br><span class="line"><span class="comment">// observedFn.deps.length === 1</span></span><br><span class="line"><span class="comment">// å¦‚æœä¸æ·»åŠ !dep.has(effect)çš„åˆ¤æ–­</span></span><br><span class="line"><span class="comment">// observedFn.deps.length === 2ï¼Œå¹¶ä¸”observedFn.depsä¸­æ˜¯ä¸¤ä¸ªé‡å¤çš„depé›†åˆ</span></span><br></pre></td></tr></table></figure>
<h4 id="trigger"><a href="#trigger" class="headerlink" title="trigger"></a>trigger</h4><p>å½“å“åº”å¼æ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡<code>trigger</code>å‡½æ•°ï¼Œè§¦å‘ç›‘å¬å‡½æ•°åšå‡ºå“åº”ã€‚</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">trigger</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  target: object, <span class="comment">// åŸå§‹å¯¹è±¡</span></span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">type</span>: OperationTypes, <span class="comment">// è§¦å‘ä¾èµ–çš„ç±»å‹ï¼ˆSETï¼ŒADDï¼ŒDELETEï¼‰ç­‰</span></span></span></span><br><span class="line"><span class="function"><span class="params">  key?: unknown, <span class="comment">// åŸå§‹å¯¹è±¡çš„key</span></span></span></span><br><span class="line"><span class="function"><span class="params">  extraInfo?: DebuggerEventExtraInfo</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// å¦‚æœæ— æ³•åœ¨targetMapä¸­æ‰¾åˆ°targetå¯¹åº”çš„Mapã€‚è¯´æ˜targetæ²¡æœ‰è¢«ç›‘å¬ï¼Œç›´æ¥è¿”å›ã€‚</span></span><br><span class="line">  <span class="keyword">const</span> depsMap = targetMap.get(target)</span><br><span class="line">  <span class="keyword">if</span> (depsMap === <span class="built_in">void</span> <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å£°æ˜ä¸€ä¸ªç›‘å¬å‡½æ•°çš„Seté›†åˆ</span></span><br><span class="line">  <span class="keyword">const</span> effects = <span class="keyword">new</span> Set&lt;ReactiveEffect&gt;()</span><br><span class="line">  <span class="comment">// å£°æ˜ä¸€ä¸ªcomputedçš„é›†åˆ</span></span><br><span class="line">  <span class="keyword">const</span> computedRunners = <span class="keyword">new</span> Set&lt;ReactiveEffect&gt;()</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">type</span> === OperationTypes.CLEAR) &#123;</span><br><span class="line">    <span class="comment">// ğŸ‘»</span></span><br><span class="line">    <span class="comment">// collection being cleared, trigger all effects for target</span></span><br><span class="line">    <span class="comment">// addRunnerså‡½æ•°çš„å…·ä½“ç»†èŠ‚è§åæ–‡</span></span><br><span class="line">    depsMap.forEach(<span class="function"><span class="params">dep</span> =&gt;</span> &#123;</span><br><span class="line">      addRunners(effects, computedRunners, dep)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœkeyä¸ç­‰äºundefinedã€‚æ— è®ºæ­¤æ—¶æ˜¯SETæˆ–è€…ADDè¿˜æ˜¯DELETEçš„æ“ä½œã€‚</span></span><br><span class="line">    <span class="comment">// éƒ½è·å–keyå¯¹åº”çš„effecté›†åˆï¼Œå°†é›†åˆä¸­çš„effectåˆ†åˆ«æ·»åŠ åˆ°å¯¹åº”çš„é˜Ÿåˆ—ä¸­ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (key !== <span class="built_in">void</span> <span class="number">0</span>) &#123;</span><br><span class="line">      addRunners(effects, computedRunners, depsMap.get(key))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœtypeçš„ç±»å‹æ˜¯ADDï¼ŒDELETEæ—¶ï¼Œæˆ‘ä»¬éœ€è¦åšé¢å¤–çš„æ“ä½œ</span></span><br><span class="line">    <span class="comment">// ä¸ºä»€ä¹ˆè¦åšé¢å¤–çš„å¤„ç†ï¼Œåé¢æœ‰è¯¦ç»†çš„è§£é‡Š</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">type</span> === OperationTypes.ADD || <span class="keyword">type</span> === OperationTypes.DELETE) &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœtargetæ˜¯æ•°ç»„ï¼ŒiterationKeyç­‰äºlength</span></span><br><span class="line">      <span class="comment">// å¦‚æœæ˜¯å¯¹è±¡ï¼ŒiterationKeyç­‰äºè¿­ä»£æ“ä½œç¬¦</span></span><br><span class="line">      <span class="keyword">const</span> iterationKey = isArray(target) ? <span class="string">'length'</span> : ITERATE_KEY</span><br><span class="line">      <span class="comment">// è·å–lengthæˆ–è€…è¿­ä»£æ“ä½œç¬¦ï¼Œå¯¹åº”çš„effecté›†åˆï¼Œå°†é›†åˆä¸­çš„effectåˆ†åˆ«æ·»åŠ åˆ°å¯¹åº”çš„é˜Ÿåˆ—ä¸­ã€‚</span></span><br><span class="line">      addRunners(effects, computedRunners, depsMap.get(iterationKey))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å®šä¹‰runå‡½æ•°ï¼Œç”¨æ¥æ‰§è¡Œeffectså’ŒcomputedRunnersé˜Ÿåˆ—ä¸­çš„ç›‘å¬å‡½æ•°</span></span><br><span class="line">  <span class="keyword">const</span> run = <span class="function">(<span class="params">effect: ReactiveEffect</span>) =&gt;</span> &#123;</span><br><span class="line">    scheduleRun(effect, target, <span class="keyword">type</span>, key, extraInfo)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ä¼˜å…ˆæ‰§è¡Œè®¡ç®—å±æ€§çš„é˜Ÿåˆ—ï¼ˆè®¡ç®—å±æ€§åŸºäºeffectå®ç°ï¼‰</span></span><br><span class="line">  <span class="comment">// å› ä¸ºç›‘å¬å‡½æ•°ä¸­å¯èƒ½ä¼šä½¿ç”¨åˆ°è®¡ç®—å±æ€§</span></span><br><span class="line">  <span class="comment">// å¾ªç¯computedRunnerså’Œeffectsé˜Ÿåˆ—ï¼Œé‡æ–°è®¡ç®—computedå’Œé‡æ–°è¿è¡Œç›‘å¬å‡½æ•°</span></span><br><span class="line">  computedRunners.forEach(run)</span><br><span class="line">  effects.forEach(run)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addRunners</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  effects: Set&lt;ReactiveEffect&gt;, <span class="comment">// effectsé˜Ÿåˆ—</span></span></span></span><br><span class="line"><span class="function"><span class="params">  computedRunners: Set&lt;ReactiveEffect&gt;, <span class="comment">// computedRunnersé˜Ÿåˆ— </span></span></span></span><br><span class="line"><span class="function"><span class="params">  effectsToAdd: Set&lt;ReactiveEffect&gt; | <span class="literal">undefined</span> <span class="comment">// ç›‘å¬å‡½æ•°çš„é›†åˆ</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (effectsToAdd !== <span class="built_in">void</span> <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœeffectåŒ…å«computedå±æ€§ï¼Œæ·»åŠ åˆ°computedRunnersé˜Ÿåˆ—ä¸­</span></span><br><span class="line">    <span class="comment">// å¦åˆ™æ·»åŠ åˆ°effectsé˜Ÿåˆ—ä¸­</span></span><br><span class="line">    effectsToAdd.forEach(<span class="function"><span class="params">effect</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (effect.options.computed) &#123;</span><br><span class="line">        computedRunners.add(effect)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        effects.add(effect)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// computedå’Œç›‘å¬å‡½æ•°çš„æ‰§è¡Œå™¨</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">scheduleRun</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  effect: ReactiveEffect,</span></span></span><br><span class="line"><span class="function"><span class="params">  target: object,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">type</span>: OperationTypes,</span></span></span><br><span class="line"><span class="function"><span class="params">  key: unknown,</span></span></span><br><span class="line"><span class="function"><span class="params">  extraInfo?: DebuggerEventExtraInfo</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (__DEV__ &amp;&amp; effect.options.onTrigger) &#123;</span><br><span class="line">    <span class="keyword">const</span> event: DebuggerEvent = &#123;</span><br><span class="line">      effect,</span><br><span class="line">      target,</span><br><span class="line">      key,</span><br><span class="line">      <span class="keyword">type</span></span><br><span class="line">    &#125;</span><br><span class="line">    effect.options.onTrigger(extraInfo ? extend(event, extraInfo) : event)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å¦‚æœåœ¨optionsä¸­é…ç½®äº†scheduleræ‰§è¡Œå™¨</span></span><br><span class="line">  <span class="keyword">if</span> (effect.options.scheduler !== <span class="built_in">void</span> <span class="number">0</span>) &#123;</span><br><span class="line">    effect.options.scheduler(effect)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    effect()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="ğŸ¤”ï¸ä¸ºä»€ä¹ˆè¦å¯¹ADDå’ŒDELETEç±»å‹çš„typeåšå‡ºé¢å¤–çš„å¤„ç†ï¼Ÿ"><a href="#ğŸ¤”ï¸ä¸ºä»€ä¹ˆè¦å¯¹ADDå’ŒDELETEç±»å‹çš„typeåšå‡ºé¢å¤–çš„å¤„ç†ï¼Ÿ" class="headerlink" title="ğŸ¤”ï¸ä¸ºä»€ä¹ˆè¦å¯¹ADDå’ŒDELETEç±»å‹çš„typeåšå‡ºé¢å¤–çš„å¤„ç†ï¼Ÿ"></a>ğŸ¤”ï¸ä¸ºä»€ä¹ˆè¦å¯¹ADDå’ŒDELETEç±»å‹çš„typeåšå‡ºé¢å¤–çš„å¤„ç†ï¼Ÿ</h5><p>è¿™æ®µä»£ç æ˜¯ä»€ä¹ˆé€»è¾‘ï¼Ÿæˆ‘ä»¬ä¸¾ä¸ªä¾‹å­æ¥è¯´æ˜ã€‚</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">type</span> === OperationTypes.ADD || <span class="keyword">type</span> === OperationTypes.DELETE) &#123;</span><br><span class="line">  <span class="keyword">const</span> iterationKey = isArray(target) ? <span class="string">'length'</span> : ITERATE_KEY</span><br><span class="line">  addRunners(effects, computedRunners, depsMap.get(iterationKey))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ç›‘å¬å‡½æ•°ä¸­ï¼Œä¼šæ”¶é›†è¿­ä»£æ“ä½œç¬¦<code>in</code>çš„ä¾èµ–ã€‚å¦‚æœæˆ‘ä»¬å¯¹<code>observed</code>å¯¹è±¡çš„å±æ€§è¿›è¡Œåˆ å‡ï¼Œå¾ˆæ˜¾ç„¶ä¼šå½±å“åˆ°<code>dummy</code>å€¼çš„å¤§å°ã€‚æ‰€ä»¥ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå½“typeç­‰äº<code>ADD</code>æˆ–è€…<code>DELETE</code>æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å°†è¿­ä»£æ“ä½œç¬¦å¯¹åº”çš„ç›‘å¬å‡½æ•°çš„é›†åˆï¼Œæ·»åŠ åˆ°æ›´æ–°é˜Ÿåˆ—ä¸­ã€‚åŒç†å½“æˆ‘ä»¬å¯¹æ•°ç»„è¿›è¡Œ<code>ADD</code>æˆ–è€…<code>DELETE</code>æ“ä½œæ—¶ï¼Œä¹Ÿä¼šå¯¹æ•°ç»„çš„<code>length</code>äº§ç”Ÿå½±å“ã€‚</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> dummy = <span class="number">0</span></span><br><span class="line"><span class="keyword">const</span> original = &#123;foo: <span class="number">1</span>, bar: <span class="number">2</span>&#125;</span><br><span class="line"><span class="keyword">const</span> observed = reactive(original)</span><br><span class="line"><span class="keyword">type</span> keys = keyof <span class="keyword">typeof</span> observed</span><br><span class="line">effect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> k <span class="keyword">in</span> observed) &#123;</span><br><span class="line">    dummy += observed[k <span class="keyword">as</span> keys]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`dummy: <span class="subst">$&#123;dummy&#125;</span>`</span>)</span><br><span class="line">dummy = <span class="number">0</span></span><br><span class="line"><span class="comment">// ä¼šè§¦å‘ç›‘å¬å‡½æ•°çš„å“åº”</span></span><br><span class="line"><span class="keyword">delete</span> observed.foo</span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`dummy: <span class="subst">$&#123;dummy&#125;</span>`</span>)</span><br></pre></td></tr></table></figure>
<h5 id="ğŸ¤”ï¸å¦‚æœaddRunnersæ·»åŠ äº†é‡å¤çš„effectæ€ä¹ˆåŠï¼Ÿ"><a href="#ğŸ¤”ï¸å¦‚æœaddRunnersæ·»åŠ äº†é‡å¤çš„effectæ€ä¹ˆåŠï¼Ÿ" class="headerlink" title="ğŸ¤”ï¸å¦‚æœaddRunnersæ·»åŠ äº†é‡å¤çš„effectæ€ä¹ˆåŠï¼Ÿ"></a>ğŸ¤”ï¸å¦‚æœaddRunnersæ·»åŠ äº†é‡å¤çš„effectæ€ä¹ˆåŠï¼Ÿ</h5><p>è€ƒè™‘ä¸‹é¢åˆ—ä¸¾å‡ºçš„æƒ…å†µã€‚<br><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> dummy = <span class="number">0</span></span><br><span class="line"><span class="keyword">const</span> original = &#123;foo: <span class="number">1</span>, bar: <span class="number">2</span>&#125;</span><br><span class="line"><span class="keyword">const</span> observed = reactive(original)</span><br><span class="line"><span class="keyword">type</span> keys = keyof <span class="keyword">typeof</span> observed</span><br><span class="line"><span class="keyword">const</span> fnSpy = jest.fn(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> k <span class="keyword">in</span> observed) &#123;</span><br><span class="line">    dummy += observed[k <span class="keyword">as</span> keys]</span><br><span class="line">  &#125;</span><br><span class="line">  dummy = observed.foo</span><br><span class="line">&#125;)</span><br><span class="line">effect(fnSpy)</span><br><span class="line"><span class="comment">// toHaveBeenCalledTimesåˆ¤æ–­å‡½æ•°çš„æ‰§è¡Œæ¬¡æ•°</span></span><br><span class="line">expect(fnSpy).toHaveBeenCalledTimes(<span class="number">1</span>)</span><br><span class="line">expect(dummy).toBe(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">delete</span> observed.foo</span><br><span class="line">expect(dummy).toBe(<span class="literal">undefined</span>)</span><br><span class="line">expect(fnSpy).toHaveBeenCalledTimes(<span class="number">2</span>))</span><br></pre></td></tr></table></figure></p>
<p>åˆ é™¤<code>observed.foo</code>å±æ€§ï¼Œä¼šå¯¼è‡´å½“å‰ç›‘å¬å‡½æ•°è¢«é‡å¤æ·»åŠ åˆ°æ‰§è¡Œé˜Ÿåˆ—ä¸­ï¼Œç¬¬ä¸€æ¬¡æ˜¯å› ä¸ºDELETEçš„æ“ä½œï¼Œç¬¬äºŒæ¬¡æ˜¯å› ä¸ºè¿­ä»£å™¨ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆç›‘å¬å‡½æ•°åªä¼šæ‰§è¡Œä¸€æ¬¡å‘¢ï¼Ÿ</p>
<p>åŸå› å¾ˆç®€å•ã€‚æ‰§è¡Œé˜Ÿåˆ—<code>computedRunners</code>å’Œ<code>effects</code>æ˜¯Setæ•°æ®ç»“æ„ï¼Œæˆå‘˜æœ¬èº«æ˜¯å…·æœ‰å”¯ä¸€æ€§çš„ã€‚</p>
<h2 id="ğŸ˜ŠcollectionHandlers-ts"><a href="#ğŸ˜ŠcollectionHandlers-ts" class="headerlink" title="ğŸ˜ŠcollectionHandlers.ts"></a>ğŸ˜ŠcollectionHandlers.ts</h2><p>Proxyå¯¹<code>Set, Map, WeakMap, WeakSet</code>ç­‰å†…ç½®å¯¹è±¡çš„æ”¯æŒå¹¶ä¸å®Œç¾ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦è¿›è¡Œé¢å¤–çš„å¤„ç†ã€‚è¿™äº›ç‰¹æ®Šçš„å¤„ç†ï¼Œéƒ½åœ¨<code>collectionHandlers.ts</code>æ–‡ä»¶ä¸­ã€‚</p>
<h3 id="ğŸ¤”ï¸ä¸ºä»€ä¹ˆProxyå¯¹Mapï¼ŒSetç­‰æ•°æ®ç»“æ„ä¸èµ·ä½œç”¨ï¼Ÿ"><a href="#ğŸ¤”ï¸ä¸ºä»€ä¹ˆProxyå¯¹Mapï¼ŒSetç­‰æ•°æ®ç»“æ„ä¸èµ·ä½œç”¨ï¼Ÿ" class="headerlink" title="ğŸ¤”ï¸ä¸ºä»€ä¹ˆProxyå¯¹Mapï¼ŒSetç­‰æ•°æ®ç»“æ„ä¸èµ·ä½œç”¨ï¼Ÿ"></a>ğŸ¤”ï¸ä¸ºä»€ä¹ˆProxyå¯¹Mapï¼ŒSetç­‰æ•°æ®ç»“æ„ä¸èµ·ä½œç”¨ï¼Ÿ</h3><p>Mapã€Setä½¿ç”¨äº†å†…éƒ¨æ’æ§½ï¼ŒMapå°†æ•°æ®å­˜å‚¨åœ¨å†…éƒ¨æ’æ§½<code>[[MapData]]</code>ä¸­ã€‚ä¸é€šè¿‡<code>[[Get]]</code>/<code>[[Set]]</code>æ‰€ä»¥Proxyæ— æ•ˆã€‚å¦‚æœè®¾ç½®äº†<code>Proxy Set</code>çš„ä»£ç†ï¼Œå‡½æ•°å†…éƒ¨ä¼šå°è¯•è¯»å–<code>this.[[MapData]]</code>ï¼Œä½†æ˜¯ä»£ç†å<code>this</code>ç­‰äº<code>ä»£ç†å¯¹è±¡</code>ï¼ˆthis === proxyï¼‰ï¼Œå¹¶ä¸åŒ…å«å†…éƒ¨æ’æ§½<code>[[MapData]]</code>ï¼Œæ‰€ä»¥ä¼šæŠ›å‡ºé”™è¯¯ã€‚</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> map = <span class="keyword">new</span> Map()</span><br><span class="line"><span class="keyword">let</span> proxy = <span class="keyword">new</span> Proxy(map, &#123;</span><br><span class="line">  <span class="keyword">set</span> (target, key, value, receiver) &#123;</span><br><span class="line">    <span class="keyword">const</span> result = Reflect.set(target, key, value, receiver)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//  TypeError: Method Map.prototype.set called on incompatible receiver [object Object]</span></span><br><span class="line">proxy.set(<span class="string">'name'</span>, <span class="string">'sam'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="ğŸ¤”ï¸å¦‚ä½•è§£å†³Proxxyåœ¨Mapï¼ŒSetä¸Šä¸èµ·ä½œç”¨ï¼Ÿ"><a href="#ğŸ¤”ï¸å¦‚ä½•è§£å†³Proxxyåœ¨Mapï¼ŒSetä¸Šä¸èµ·ä½œç”¨ï¼Ÿ" class="headerlink" title="ğŸ¤”ï¸å¦‚ä½•è§£å†³Proxxyåœ¨Mapï¼ŒSetä¸Šä¸èµ·ä½œç”¨ï¼Ÿ"></a>ğŸ¤”ï¸å¦‚ä½•è§£å†³Proxxyåœ¨Mapï¼ŒSetä¸Šä¸èµ·ä½œç”¨ï¼Ÿ</h3><p>è§£å†³æ–¹æ³•å¦‚ä¸‹ã€‚è§£é‡Šè¿™æ®µä»£ç çš„åŸç†ã€‚</p>
<ol>
<li><code>proxy.set</code>è¿™å¥ä»£ç æœ¬èº«ä¼šè§¦å‘<code>proxy</code>å¯¹è±¡çš„<code>get</code>åŠ«æŒã€‚</li>
<li><code>Reflect.get(...arguments)</code>å¯ä»¥æ‹¿åˆ°åŸå§‹å¯¹è±¡<code>target</code>ä¸Šçš„<code>set</code>å‡½æ•°ã€‚</li>
<li>å¦‚æœ<code>value</code>ï¼ˆç›®å‰æ˜¯<code>set</code>)æ˜¯å‡½æ•°çš„è¯ï¼Œä½¿ç”¨<code>bind</code>æ”¹å˜<code>value</code>å†…éƒ¨çš„<code>this</code>æŒ‡å‘ï¼Œ<code>this</code>æŒ‡å‘åŸå§‹å¯¹è±¡<code>target</code>ã€‚</li>
<li><code>proxy.set</code>è¿”å›çš„<code>set</code>å‡½æ•°ï¼Œå†…éƒ¨çš„<code>this</code>ä¸å†æ˜¯<code>proxy</code>ï¼Œè€Œæ˜¯åŸå§‹å¯¹è±¡ã€‚ä»è€Œé¿å…äº†<code>this</code>å¼•èµ·çš„é—®é¢˜ã€‚</li>
<li>æˆåŠŸä¿®æ”¹<code>name</code>å±æ€§ã€‚</li>
</ol>
<p>åœ¨Vueä¸­ï¼Œä¹Ÿåšäº†ç±»ä¼¼çš„å¤„ç†ã€‚</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> map = <span class="keyword">new</span> Map()</span><br><span class="line"><span class="keyword">let</span> proxy = <span class="keyword">new</span> Proxy(map, &#123;</span><br><span class="line">  <span class="keyword">get</span> (target, prop, receiver) &#123;</span><br><span class="line">    <span class="keyword">let</span> value = Reflect.get(...arguments)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">typeof</span> value === <span class="string">'function'</span> ? value.bind(target) : value</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line">proxy.set(<span class="string">'name'</span>, <span class="string">'sam'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="collectionHandlers-tsæºç åˆ†æ"><a href="#collectionHandlers-tsæºç åˆ†æ" class="headerlink" title="collectionHandlers.tsæºç åˆ†æ"></a>collectionHandlers.tsæºç åˆ†æ</h3><p>ä¸Šé¢æˆ‘ä»¬ä»‹ç»å¦‚ä½•è§£å†³<code>Proxy</code>å¯¹<code>Map</code>ï¼Œ<code>Set</code>æ”¯æŒä¸å®Œç¾çš„è§£å†³æ–¹æ³•ã€‚è¿™ç§æ–¹æ³•å…¶å®ä¸Vue3ä¸­çš„åšæ³•åŸç†æ˜¯ç±»ä¼¼çš„ã€‚</p>
<p>åœ¨Vue3ä¸­ï¼Œé€šè¿‡å¯¹<code>get</code>æ“ä½œè¿›è¡ŒåŠ«æŒï¼Œè¿”å›<code>mutableInstrumentations</code>å¯¹è±¡ä¸Šï¼Œä¸<code>key</code>å¯¹åº”çš„æ–¹æ³•ã€‚å½“ç„¶è¿™ä¸ªæ–¹æ³•æ˜¯æœ‰é¢å¤–è¡Œä¸ºï¼Œæ–¹æ³•å†…éƒ¨åŒ…å«äº†ä¾èµ–æ”¶é›†ï¼Œé€šçŸ¥ç›‘å¬å‡½æ•°å“åº”ç­‰è¡Œä¸ºã€‚</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯¹getæ“ä½œè¿›è¡ŒåŠ«æŒ</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> mutableCollectionHandlers: ProxyHandler&lt;CollectionTypes&gt; = &#123;</span><br><span class="line">  <span class="keyword">get</span>: createInstrumentationGetter(mutableInstrumentations)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºgetåŠ«æŒ</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createInstrumentationGetter</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  instrumentations: Record&lt;<span class="built_in">string</span>, <span class="built_in">Function</span>&gt;</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// getåŠ«æŒçš„å‡½æ•°</span></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    target: CollectionTypes,</span><br><span class="line">    key: <span class="built_in">string</span> | symbol,</span><br><span class="line">    receiver: CollectionTypes</span><br><span class="line">  ) =&gt;</span><br><span class="line">    <span class="comment">// å¦‚æœinstrumentationsä¸Šå­˜åœ¨åŒåçš„keyå±æ€§ï¼Œè¿”å›instrumentations[key]</span></span><br><span class="line">    <span class="comment">// å¦‚æœä¸å­˜åœ¨ï¼Œè¿”å›åŸå¯¹è±¡ä¸Šçš„å±æ€§ï¼Œtarget[key]</span></span><br><span class="line">    Reflect.get(</span><br><span class="line">      hasOwn(instrumentations, key) &amp;&amp; key <span class="keyword">in</span> target</span><br><span class="line">        ? instrumentations</span><br><span class="line">        : target,</span><br><span class="line">      key,</span><br><span class="line">      receiver</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†å¯¹è±¡è½¬ä¸ºå“åº”å¼å¯¹è±¡</span></span><br><span class="line"><span class="keyword">const</span> toReactive = &lt;T <span class="keyword">extends</span> unknown&gt;(value: T): <span class="function"><span class="params">T</span> =&gt;</span></span><br><span class="line">  isObject(value) ? reactive(value) : value</span><br><span class="line"></span><br><span class="line"><span class="comment">// `keys`ã€`values`ã€`entries`ç­‰è¿­ä»£æ–¹æ³•çš„å¤„ç†è§åæ–‡</span></span><br><span class="line"><span class="keyword">const</span> mutableInstrumentations: Record&lt;<span class="built_in">string</span>, <span class="built_in">Function</span>&gt; = &#123;</span><br><span class="line">  <span class="comment">// this: MapTypesæ˜¯TSä¸­thiså‚æ•°ï¼Œä¸»è¦æ˜¯ä¸ºäº†é˜²æ­¢thisçš„ç±»å‹ä¸¢å¤±ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªçœŸçš„å‚æ•°</span></span><br><span class="line">  <span class="keyword">get</span>(<span class="keyword">this</span>: MapTypes, key: unknown) &#123;</span><br><span class="line">    <span class="comment">// thisï¼ŒæŒ‡çš„æ˜¯è®¿é—®getå±æ€§çš„å¯¹è±¡ï¼Œé€šå¸¸æŒ‡çš„æ˜¯reactiveè¿”å›çš„å“åº”å¼å¯¹è±¡</span></span><br><span class="line">    <span class="comment">// keyï¼Œå±æ€§å</span></span><br><span class="line">    <span class="comment">// toReactiveï¼Œå·¥å…·æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">get</span>(<span class="keyword">this</span>, key, toReactive)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="keyword">get</span> size(<span class="keyword">this</span>: IterableCollections) &#123;</span><br><span class="line">    <span class="comment">// thisï¼ŒæŒ‡çš„æ˜¯è®¿é—®sizeå±æ€§çš„å¯¹è±¡ï¼Œé€šå¸¸æŒ‡çš„æ˜¯reactiveè¿”å›çš„å“åº”å¼å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">return</span> size(<span class="keyword">this</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  has,</span><br><span class="line">  add,</span><br><span class="line">  <span class="keyword">set</span>,</span><br><span class="line">  <span class="keyword">delete</span>: deleteEntry,</span><br><span class="line">  clear,</span><br><span class="line">  forEach: createForEach(<span class="literal">false</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ğŸ¤”ï¸å¦‚æœè®¿é—®çš„å±æ€§ä¸å­˜åœ¨åœ¨instrumentationsä¸Šä¼šæ€ä¹ˆæ ·ï¼Ÿ"><a href="#ğŸ¤”ï¸å¦‚æœè®¿é—®çš„å±æ€§ä¸å­˜åœ¨åœ¨instrumentationsä¸Šä¼šæ€ä¹ˆæ ·ï¼Ÿ" class="headerlink" title="ğŸ¤”ï¸å¦‚æœè®¿é—®çš„å±æ€§ä¸å­˜åœ¨åœ¨instrumentationsä¸Šä¼šæ€ä¹ˆæ ·ï¼Ÿ"></a>ğŸ¤”ï¸å¦‚æœè®¿é—®çš„å±æ€§ä¸å­˜åœ¨åœ¨instrumentationsä¸Šä¼šæ€ä¹ˆæ ·ï¼Ÿ</h4><p>å¦‚æœä½¿ç”¨è®¿é—®å±æ€§ï¼Œä¸åœ¨<code>instrumentations</code>ä¸­ï¼ˆ<code>size</code>ã€<code>get</code>ã€<code>has</code>ã€<code>add</code>ã€<code>set</code>ã€<code>delete</code>ã€<code>clear</code>ã€<code>forEach</code>ã€<code>keys</code>ã€<code>values</code>ã€<code>entries</code>ä»¥å¤–çš„å±æ€§)ã€‚æ— æ³•è¿›è¡Œä¾èµ–æ”¶é›†ï¼Œæ›´æ–°è‡ªå®šä¹‰å±æ€§ä¹Ÿæ— æ³•è§¦å‘ç›‘å¬å‡½æ•°çš„å“åº”ã€‚ä¸‹é¢çš„å•æµ‹å¯ä»¥è¯´æ˜ä¾‹å­ã€‚</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">'should not observe custom property mutations'</span>, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> dummy</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">set</span>: <span class="built_in">any</span> = reactive(<span class="keyword">new</span> Set())</span><br><span class="line">  effect(<span class="function"><span class="params">()</span> =&gt;</span> (dummy = <span class="keyword">set</span>.customProp))</span><br><span class="line">  expect(dummy).toBe(<span class="literal">undefined</span>)</span><br><span class="line">  <span class="keyword">set</span>.customProp = <span class="string">'Hello World'</span></span><br><span class="line">  <span class="comment">// ä¿®æ”¹customPropï¼Œç›‘å¬å‡½æ•°å¹¶æ²¡æœ‰é‡æ–°æ‰§è¡Œï¼Œæ‰€ä»¥dummyä¾ç„¶ç­‰äºundefined</span></span><br><span class="line">  expect(dummy).toBe(<span class="literal">undefined</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="get-1"><a href="#get-1" class="headerlink" title="get"></a>get</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  target: MapTypes, <span class="comment">// æ³¨æ„è¿™é‡Œæ˜¯å“åº”å¼å¯¹è±¡ï¼Œä¸æ˜¯åŸå¯¹è±¡</span></span></span></span><br><span class="line"><span class="function"><span class="params">  key: unknown, <span class="comment">// å±æ€§çš„key</span></span></span></span><br><span class="line"><span class="function"><span class="params">  wrap: <span class="keyword">typeof</span> toReactive | <span class="keyword">typeof</span> toReadonly</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// è¿”å›targetå¯¹åº”çš„åŸå§‹å¯¹è±¡</span></span><br><span class="line">  target = toRaw(target)</span><br><span class="line">  key = toRaw(key)</span><br><span class="line">  <span class="comment">// æ”¶é›†ä¾èµ–</span></span><br><span class="line">  track(target, OperationTypes.GET, key)</span><br><span class="line">  <span class="comment">// getProto(target).get ä½¿ç”¨åŸå§‹å¯¹è±¡åŸå‹ä¸Šçš„getæ–¹æ³•</span></span><br><span class="line">  <span class="comment">// é€šè¿‡callï¼Œå°†åŸå‹ä¸Šçš„getæ–¹æ³•çš„å†…éƒ¨thisæŒ‡å‘åŸå§‹å¯¹è±¡ï¼Œé¿å…äº†ï¼Œå¦‚æœthisæ˜¯å“åº”å¼å¯¹è±¡ä¸Šä¸å­˜åœ¨[[MapData]]æ’æ§½çš„é—®é¢˜</span></span><br><span class="line">  <span class="comment">// æœ€åå°†valueçš„å€¼ä¹Ÿè½¬æ¢ä¸ºå“åº”å¼çš„</span></span><br><span class="line">  <span class="keyword">return</span> wrap(getProto(target).get.call(target, key))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="addã€set"><a href="#addã€set" class="headerlink" title="addã€set"></a>addã€set</h4><p><code>add</code>å’Œ<code>set</code>æ€è·¯æ˜¯ç±»ä¼¼çš„ï¼Œåªæ˜¯é’ˆå¯¹ä¸åŒçš„æ•°æ®ç»“æ„<code>Set</code>å’Œ<code>Map</code>ã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œå‡½æ•°å†…éƒ¨çš„<code>this</code>æŒ‡çš„æ˜¯å“åº”å¼å¯¹è±¡ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨<code>toRaw</code>æ‹¿åˆ°åŸå¯¹è±¡ã€‚</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">this</span>: SetTypes, <span class="comment">// this: SetTypesæ˜¯TSä¸­thiså‚æ•°ï¼Œä¸»è¦æ˜¯ä¸ºäº†é˜²æ­¢thisçš„ç±»å‹ä¸¢å¤±ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªçœŸçš„å‚æ•°</span></span></span></span><br><span class="line"><span class="function"><span class="params">  value: unknown</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  value = toRaw(value)</span><br><span class="line">  <span class="comment">// è·å–åŸå§‹æ•°æ®ï¼Œè¿™é‡Œçš„thisæ˜¯å“åº”å¼å¯¹è±¡</span></span><br><span class="line">  <span class="keyword">const</span> target = toRaw(<span class="keyword">this</span>)</span><br><span class="line">  <span class="comment">// è·å–åŸå§‹æ•°æ®çš„åŸå‹</span></span><br><span class="line">  <span class="keyword">const</span> proto = getProto(target)</span><br><span class="line">  <span class="comment">// åˆ¤æ–­æ˜¯å¦å­˜åœ¨è¿™ä¸ªvalue</span></span><br><span class="line">  <span class="keyword">const</span> hadKey = proto.has.call(target, value)</span><br><span class="line">  <span class="comment">// é€šè¿‡åŸå‹æ–¹æ³•ï¼Œä¿®æ”¹thisæŒ‡å‘ï¼Œæ·»åŠ value</span></span><br><span class="line">  <span class="keyword">const</span> result = proto.add.call(target, value)</span><br><span class="line">  <span class="comment">// å¦‚æœvalueæ˜¯ä¹‹å‰ä¸å­˜åœ¨çš„ï¼Œéœ€è¦é€šçŸ¥ç›‘å¬å‡½æ•°</span></span><br><span class="line">  <span class="keyword">if</span> (!hadKey) &#123;</span><br><span class="line">    <span class="comment">/* istanbul ignore else */</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      trigger(target, OperationTypes.ADD, value, &#123; newValue: value &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      trigger(target, OperationTypes.ADD, value)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ€è·¯å’Œaddæ˜¯ç±»ä¼¼çš„ï¼ŒåŒºåˆ«æ˜¯å¦‚æœæ˜¯æ–°å¢çš„å±æ€§ï¼Œtypeç­‰äºOperationTypes.ADD</span></span><br><span class="line"><span class="comment">// å…·ä½“åŸå› æˆ‘ä»¬åœ¨effectä¸­è®¨è®ºè¿‡</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">this</span>: MapTypes, <span class="comment">// this: MapTypesæ˜¯TSä¸­thiså‚æ•°ï¼Œä¸»è¦æ˜¯ä¸ºäº†é˜²æ­¢thisçš„ç±»å‹ä¸¢å¤±ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªçœŸçš„å‚æ•°</span></span></span></span><br><span class="line"><span class="function"><span class="params">  key: unknown,</span></span></span><br><span class="line"><span class="function"><span class="params">  value: unknown</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  value = toRaw(value)</span><br><span class="line">  <span class="comment">// æ‹¿åˆ°åŸå¯¹è±¡</span></span><br><span class="line">  <span class="keyword">const</span> target = toRaw(<span class="keyword">this</span>)</span><br><span class="line">  <span class="keyword">const</span> proto = getProto(target)</span><br><span class="line">  <span class="keyword">const</span> hadKey = proto.has.call(target, key)</span><br><span class="line">  <span class="keyword">const</span> oldValue = proto.get.call(target, key)</span><br><span class="line">  <span class="keyword">const</span> result = proto.set.call(target, key, value)</span><br><span class="line">  <span class="comment">/* istanbul ignore else */</span></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="keyword">const</span> extraInfo = &#123; oldValue, newValue: value &#125;</span><br><span class="line">    <span class="keyword">if</span> (!hadKey) &#123;</span><br><span class="line">      trigger(target, OperationTypes.ADD, key, extraInfo)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hasChanged(value, oldValue)) &#123;</span><br><span class="line">      trigger(target, OperationTypes.SET, key, extraInfo)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!hadKey) &#123;</span><br><span class="line">      trigger(target, OperationTypes.ADD, key)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hasChanged(value, oldValue)) &#123;</span><br><span class="line">      trigger(target, OperationTypes.SET, key)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="forEachã€keysã€valuesã€entries"><a href="#forEachã€keysã€valuesã€entries" class="headerlink" title="forEachã€keysã€valuesã€entries"></a>forEachã€keysã€valuesã€entries</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> iteratorMethods = [<span class="string">'keys'</span>, <span class="string">'values'</span>, <span class="string">'entries'</span>, Symbol.iterator]</span><br><span class="line"></span><br><span class="line">iteratorMethods.forEach(<span class="function"><span class="params">method</span> =&gt;</span> &#123;</span><br><span class="line">  mutableInstrumentations[method <span class="keyword">as</span> <span class="built_in">string</span>] = createIterableMethod(</span><br><span class="line">    method,</span><br><span class="line">    <span class="literal">false</span></span><br><span class="line">  )</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createForEach</span>(<span class="params">isReadonly: <span class="built_in">boolean</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">forEach</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">this</span>: IterableCollections,</span></span></span><br><span class="line"><span class="function"><span class="params">    callback: <span class="built_in">Function</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    thisArg?: unknown</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> observed = <span class="keyword">this</span></span><br><span class="line">    <span class="keyword">const</span> target = toRaw(observed)</span><br><span class="line">    <span class="keyword">const</span> wrap = isReadonly ? toReadonly : toReactive</span><br><span class="line">    track(target, OperationTypes.ITERATE)</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">wrappedCallback</span>(<span class="params">value: unknown, key: unknown</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> callback.call(observed, wrap(value), wrap(key), observed)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> getProto(target).forEach.call(target, wrappedCallback, thisArg)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="computed-ts"><a href="#computed-ts" class="headerlink" title="computed.ts"></a>computed.ts</h2><h3 id="computed-tsæºç è§£æ"><a href="#computed-tsæºç è§£æ" class="headerlink" title="computed.tsæºç è§£æ"></a>computed.tsæºç è§£æ</h3><h4 id="ğŸ¤”ï¸trackChildRun-runner-æ˜¯ä»€ä¹ˆé€»è¾‘ï¼Ÿ"><a href="#ğŸ¤”ï¸trackChildRun-runner-æ˜¯ä»€ä¹ˆé€»è¾‘ï¼Ÿ" class="headerlink" title="ğŸ¤”ï¸trackChildRun(runner)æ˜¯ä»€ä¹ˆé€»è¾‘ï¼Ÿ"></a>ğŸ¤”ï¸trackChildRun(runner)æ˜¯ä»€ä¹ˆé€»è¾‘ï¼Ÿ</h4><h2 id="åç»­è®¡åˆ’"><a href="#åç»­è®¡åˆ’" class="headerlink" title="åç»­è®¡åˆ’"></a>åç»­è®¡åˆ’</h2><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li><a href="https://stackoverflow.com/questions/43236329/why-is-proxy-to-a-map-object-in-es2015-not-working" target="_blank" rel="noopener">Why is Proxy to a Map object in ES2015 not working</a></li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/vue/" rel="tag"># vue</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/10/26/typescript2/" rel="next" title="ã€Œå­¦ä¹ ç¬”è®°ã€TypeScript">
                <i class="fa fa-chevron-left"></i> ã€Œå­¦ä¹ ç¬”è®°ã€TypeScript
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/12/08/vueæºç 2/" rel="prev" title="Vue3æºç è§£æï¼šnextTick">
                Vue3æºç è§£æï¼šnextTick <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            ä½œè€…æ¦‚è¿°
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpeg"
                alt="å¼ è¶Š" />
            
              <p class="site-author-name" itemprop="name">å¼ è¶Š</p>
              <p class="site-description motion-element" itemprop="description">æ‰€è°“æˆé•¿ï¼Œå°±æ˜¯ç»è¿‡ä¸æ–­çš„èšæ•£ç¦»åˆï¼Œæ‰¾åˆ°ä¸å¤ªä¼šä¼¤å®³åˆ°å½¼æ­¤çš„è·ç¦»</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">71</span>
                  <span class="site-state-item-name">ç¯‡æ–‡ç« </span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">32</span>
                  <span class="site-state-item-name">Tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/BengBu-YueZhang" target="_blank" title="æˆ‘çš„GitHub">
                      
                        <i class="fa fa-fw fa-globe"></i>æˆ‘çš„GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://weibo.com/5460100952/profile?topnav=1&wvr=6" target="_blank" title="æˆ‘çš„å¾®åš">
                      
                        <i class="fa fa-fw fa-globe"></i>æˆ‘çš„å¾®åš</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#å‰è¨€"><span class="nav-number">1.</span> <span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æ¦‚è§ˆ"><span class="nav-number">2.</span> <span class="nav-text">æ¦‚è§ˆ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ğŸ‘»reactive-ts"><span class="nav-number">3.</span> <span class="nav-text">ğŸ‘»reactive.ts</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#reactive-tsæºç åˆ†æ"><span class="nav-number">3.1.</span> <span class="nav-text">reactive.tsæºç åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ğŸ‘»ä¸ºä»€ä¹ˆä½¿ç”¨WeakMapå­˜å‚¨æ˜ å°„å…³ç³»ï¼Œè€Œä¸æ˜¯ä½¿ç”¨Mapï¼Ÿ"><span class="nav-number">3.1.1.</span> <span class="nav-text">ğŸ‘»ä¸ºä»€ä¹ˆä½¿ç”¨WeakMapå­˜å‚¨æ˜ å°„å…³ç³»ï¼Œè€Œä¸æ˜¯ä½¿ç”¨Mapï¼Ÿ</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ğŸ‘»baseHandlers-ts"><span class="nav-number">4.</span> <span class="nav-text">ğŸ‘»baseHandlers.ts</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ğŸ‘»baseHandlers-tsæºç åˆ†æ"><span class="nav-number">4.1.</span> <span class="nav-text">ğŸ‘»baseHandlers.tsæºç åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#get"><span class="nav-number">4.1.1.</span> <span class="nav-text">get</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ä¸ºä»€ä¹ˆä½¿ç”¨Reflect-getï¼Œè€Œä¸ç›´æ¥ä½¿ç”¨target-key-ï¼Ÿ"><span class="nav-number">4.1.1.1.</span> <span class="nav-text">ä¸ºä»€ä¹ˆä½¿ç”¨Reflect.getï¼Œè€Œä¸ç›´æ¥ä½¿ç”¨target[key]ï¼Ÿ</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#set"><span class="nav-number">4.1.2.</span> <span class="nav-text">set</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ğŸ¤”ï¸target-toRaw-receiver-æ˜¯ä»€ä¹ˆåˆ¤æ–­é€»è¾‘ï¼Ÿ"><span class="nav-number">4.1.2.1.</span> <span class="nav-text">ğŸ¤”ï¸target === toRaw(receiver)æ˜¯ä»€ä¹ˆåˆ¤æ–­é€»è¾‘ï¼Ÿ</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ğŸ¤”ï¸unshift-shift-pop-pushç­‰çš„å¤„ç†"><span class="nav-number">4.1.2.2.</span> <span class="nav-text">ğŸ¤”ï¸unshift, shift, pop, pushç­‰çš„å¤„ç†</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#deletePropertyã€hasã€ownKeysåŠ«æŒ"><span class="nav-number">4.1.3.</span> <span class="nav-text">deletePropertyã€hasã€ownKeysåŠ«æŒ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ğŸ‘»readonlyHandlers"><span class="nav-number">4.1.4.</span> <span class="nav-text">ğŸ‘»readonlyHandlers</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ğŸ˜Šref-ts"><span class="nav-number">5.</span> <span class="nav-text">ğŸ˜Šref.ts</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ref-tsæºç åˆ†æ"><span class="nav-number">5.1.</span> <span class="nav-text">ref.tsæºç åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#interface-Ref"><span class="nav-number">5.1.1.</span> <span class="nav-text">interface Ref</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#toRefs"><span class="nav-number">5.1.2.</span> <span class="nav-text">toRefs</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ğŸ˜Šeffect-ts"><span class="nav-number">6.</span> <span class="nav-text">ğŸ˜Šeffect.ts</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#effect-tsæºç è§£æ"><span class="nav-number">6.1.</span> <span class="nav-text">effect.tsæºç è§£æ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#effect"><span class="nav-number">6.1.1.</span> <span class="nav-text">effect</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ğŸ¤”ï¸åœ¨effectçš„æ‰§è¡Œå™¨runä¸­ï¼Œä½¿ç”¨-effectStack-includes-effect-åˆ¤æ–­æ˜¯ä»€ä¹ˆé€»è¾‘ï¼Ÿ"><span class="nav-number">6.1.1.1.</span> <span class="nav-text">ğŸ¤”ï¸åœ¨effectçš„æ‰§è¡Œå™¨runä¸­ï¼Œä½¿ç”¨!effectStack.includes(effect)åˆ¤æ–­æ˜¯ä»€ä¹ˆé€»è¾‘ï¼Ÿ</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ğŸ¤”ï¸ä¸ºä»€ä¹ˆåœ¨runä¸­æ‰§è¡Œfnå‰ï¼Œéœ€è¦ä½¿ç”¨cleanup-effect-æ¸…é™¤æ‰€æœ‰ä¾èµ–å…³ç³»ï¼Ÿ"><span class="nav-number">6.1.1.2.</span> <span class="nav-text">ğŸ¤”ï¸ä¸ºä»€ä¹ˆåœ¨runä¸­æ‰§è¡Œfnå‰ï¼Œéœ€è¦ä½¿ç”¨cleanup(effect)æ¸…é™¤æ‰€æœ‰ä¾èµ–å…³ç³»ï¼Ÿ</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#track"><span class="nav-number">6.1.2.</span> <span class="nav-text">track</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ğŸ¤”ï¸depé›†åˆæœ¬èº«æ˜¯Setç»“æ„ï¼Œæˆå‘˜å€¼æ˜¯å”¯ä¸€çš„ã€‚é‚£ä¸ºä»€ä¹ˆè¿˜è¦æ·»åŠ ï¼Œ-dep-has-effect-çš„åˆ¤æ–­ï¼Ÿ"><span class="nav-number">6.1.2.1.</span> <span class="nav-text">ğŸ¤”ï¸depé›†åˆæœ¬èº«æ˜¯Setç»“æ„ï¼Œæˆå‘˜å€¼æ˜¯å”¯ä¸€çš„ã€‚é‚£ä¸ºä»€ä¹ˆè¿˜è¦æ·»åŠ ï¼Œ!dep.has(effect)çš„åˆ¤æ–­ï¼Ÿ</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#trigger"><span class="nav-number">6.1.3.</span> <span class="nav-text">trigger</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ğŸ¤”ï¸ä¸ºä»€ä¹ˆè¦å¯¹ADDå’ŒDELETEç±»å‹çš„typeåšå‡ºé¢å¤–çš„å¤„ç†ï¼Ÿ"><span class="nav-number">6.1.3.1.</span> <span class="nav-text">ğŸ¤”ï¸ä¸ºä»€ä¹ˆè¦å¯¹ADDå’ŒDELETEç±»å‹çš„typeåšå‡ºé¢å¤–çš„å¤„ç†ï¼Ÿ</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ğŸ¤”ï¸å¦‚æœaddRunnersæ·»åŠ äº†é‡å¤çš„effectæ€ä¹ˆåŠï¼Ÿ"><span class="nav-number">6.1.3.2.</span> <span class="nav-text">ğŸ¤”ï¸å¦‚æœaddRunnersæ·»åŠ äº†é‡å¤çš„effectæ€ä¹ˆåŠï¼Ÿ</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ğŸ˜ŠcollectionHandlers-ts"><span class="nav-number">7.</span> <span class="nav-text">ğŸ˜ŠcollectionHandlers.ts</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ğŸ¤”ï¸ä¸ºä»€ä¹ˆProxyå¯¹Mapï¼ŒSetç­‰æ•°æ®ç»“æ„ä¸èµ·ä½œç”¨ï¼Ÿ"><span class="nav-number">7.1.</span> <span class="nav-text">ğŸ¤”ï¸ä¸ºä»€ä¹ˆProxyå¯¹Mapï¼ŒSetç­‰æ•°æ®ç»“æ„ä¸èµ·ä½œç”¨ï¼Ÿ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ğŸ¤”ï¸å¦‚ä½•è§£å†³Proxxyåœ¨Mapï¼ŒSetä¸Šä¸èµ·ä½œç”¨ï¼Ÿ"><span class="nav-number">7.2.</span> <span class="nav-text">ğŸ¤”ï¸å¦‚ä½•è§£å†³Proxxyåœ¨Mapï¼ŒSetä¸Šä¸èµ·ä½œç”¨ï¼Ÿ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#collectionHandlers-tsæºç åˆ†æ"><span class="nav-number">7.3.</span> <span class="nav-text">collectionHandlers.tsæºç åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ğŸ¤”ï¸å¦‚æœè®¿é—®çš„å±æ€§ä¸å­˜åœ¨åœ¨instrumentationsä¸Šä¼šæ€ä¹ˆæ ·ï¼Ÿ"><span class="nav-number">7.3.1.</span> <span class="nav-text">ğŸ¤”ï¸å¦‚æœè®¿é—®çš„å±æ€§ä¸å­˜åœ¨åœ¨instrumentationsä¸Šä¼šæ€ä¹ˆæ ·ï¼Ÿ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#get-1"><span class="nav-number">7.3.2.</span> <span class="nav-text">get</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#addã€set"><span class="nav-number">7.3.3.</span> <span class="nav-text">addã€set</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#forEachã€keysã€valuesã€entries"><span class="nav-number">7.3.4.</span> <span class="nav-text">forEachã€keysã€valuesã€entries</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#computed-ts"><span class="nav-number">8.</span> <span class="nav-text">computed.ts</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#computed-tsæºç è§£æ"><span class="nav-number">8.1.</span> <span class="nav-text">computed.tsæºç è§£æ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ğŸ¤”ï¸trackChildRun-runner-æ˜¯ä»€ä¹ˆé€»è¾‘ï¼Ÿ"><span class="nav-number">8.1.1.</span> <span class="nav-text">ğŸ¤”ï¸trackChildRun(runner)æ˜¯ä»€ä¹ˆé€»è¾‘ï¼Ÿ</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#åç»­è®¡åˆ’"><span class="nav-number">9.</span> <span class="nav-text">åç»­è®¡åˆ’</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å‚è€ƒ"><span class="nav-number">10.</span> <span class="nav-text">å‚è€ƒ</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">å¼ è¶Š</span>

  
</div>


  <div class="powered-by">Erstellt mit  <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
